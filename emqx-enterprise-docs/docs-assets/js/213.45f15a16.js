(window.webpackJsonp=window.webpackJsonp||[]).push([[213],{1468:function(s,t,a){"use strict";a.r(t);var n=a(10),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mongodb-acl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-acl"}},[s._v("#")]),s._v(" MongoDB ACL")]),s._v(" "),a("p",[s._v("For MongoDB ACL, an external MongoDB database is used to store ACL rules, which can store a large amount of data and dynamically manage ACLs for easy integration with external device management systems")]),s._v(" "),a("p",[s._v("Plugin:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("emqx_auth_mongo\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("The emqx_auth_mongo plugin also includes authentication, which can be disabled via comments")])]),s._v(" "),a("h2",{attrs:{id:"mongodb-connection-information"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-connection-information"}},[s._v("#")]),s._v(" MongoDB connection information")]),s._v(" "),a("p",[s._v("MongoDB basic connection information needs to ensure that all nodes in the cluster can be accessed.")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_mongo.conf")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## MongoDB Architecture type")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: single | unknown | sharded | rs")]),s._v("\nauth.mongo.type "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" single\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## rs mode needs to set rs name")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.rs_set_name =")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Server list, separated by comma in cluster mode")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Examples: 127.0.0.1:27017,127.0.0.2:27017...")]),s._v("\nauth.mongo.server "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:27017\n\nauth.mongo.pool "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n\nauth.mongo.login "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n\nauth.mongo.password "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.auth_source = admin")]),s._v("\n\nauth.mongo.database "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mqtt\n\nauth.mongo.query_timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 5s\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## SSL option")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# auth.mongo.ssl = false")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.ssl_opts.keyfile =")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.ssl_opts.certfile =")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.ssl_opts.cacertfile =")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## MongoDB write mode.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: unsafe | safe")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.w_mode =")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Mongo read mode.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: master | slave_ok")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.r_mode =")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## MongoDB topology configuration, generally not used, see MongoDB website documentation for details")]),s._v("\nauth.mongo.topology.pool_size "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nauth.mongo.topology.max_overflow "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.overflow_ttl = 1000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.overflow_check_period = 1000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.local_threshold_ms = 1000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.connect_timeout_ms = 20000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.socket_timeout_ms = 100")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.server_selection_timeout_ms = 30000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.wait_queue_timeout_ms = 1000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.heartbeat_frequency_ms = 10000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.min_heartbeat_frequency_ms = 1000")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br")])]),a("h2",{attrs:{id:"default-data-structure"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#default-data-structure"}},[s._v("#")]),s._v(" Default data structure")]),s._v(" "),a("p",[s._v("In the default configuration of MongoDB authentication, you need to ensure that the following collections are included in the database:")]),s._v(" "),a("h3",{attrs:{id:"authentication-super-collection"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#authentication-super-collection"}},[s._v("#")]),s._v(" Authentication / Super Collection")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("{\n  username: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  password: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password hash"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  salt: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password salt"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  is_superuser: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  created: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2020-02-20 12:12:14"')]),s._v("\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("Sample data:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("use mqtt\n\ndb.mqtt_user.insert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"emqx"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"efa1f375d76194fa51a3556a97e641e61685f914d446979da50a551a4333ffd7"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"is_superuser"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" false,\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"salt"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h3",{attrs:{id:"acl-rule-collection"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#acl-rule-collection"}},[s._v("#")]),s._v(" ACL rule collection")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    username"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    clientid"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clientid"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    publish"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ..."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    subscribe"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"subtop1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"subtop2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ..."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    pubsub"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic/#"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic1"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ..."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("MongoDB ACL rule defines the publish, subscribe, and publish/subscribe information, and  all "),a("strong",[s._v("allow")]),s._v(" lists are included in the rule.")]),s._v(" "),a("p",[s._v("Rule field description:")]),s._v(" "),a("ul",[a("li",[s._v("username: the user name of the connected client")]),s._v(" "),a("li",[s._v("clientid: the Client ID of the connected client")]),s._v(" "),a("li",[s._v("publish: the number of topics allowed to be published, supports wildcards")]),s._v(" "),a("li",[s._v("subscribe: the number of topics allowed to be subscribed to, supports wildcards")]),s._v(" "),a("li",[s._v("pubsub: the number of topics allowed to be published  and subscribed to, supports wildcards")])]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("Wildcards can be used for topic, and placeholders can be added to the topic to match client information. For example,  the topic will be replaced with the client ID of the current client when matching "),a("code",[s._v("t/%c")]),s._v(".")]),s._v(" "),a("ul",[a("li",[s._v("%u：user name")]),s._v(" "),a("li",[s._v("%c：Client ID")])])]),s._v(" "),a("p",[s._v("Sample data in the default configuration:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("use mqtt\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## All users cannot subscribe and publish system topics")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Clients are allowed to subscribe to the topic of /smarthome/${clientid}/temperature with their own Client ID")]),s._v("\n\ndb.mqtt_acl.insert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  username: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$all")]),s._v('"')]),s._v(",\n  clientid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$all")]),s._v('"')]),s._v(",\n  publish: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"#"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n  subscribe: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/smarthome/%c/temperature"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("After enabling MongoDB ACL and successfully connecting with the username emqx, the client should have the appropriate topic permissions for the data.")]),s._v(" "),a("h2",{attrs:{id:"super-query"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#super-query"}},[s._v("#")]),s._v(" super_query")]),s._v(" "),a("p",[s._v("When performing ACL authentication, EMQX Broker will use the current client information to execute a user-configured superuser query to query whether the client is a superuser. ACL queries are skipped when the client is a superuser.")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_mongo.conf")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Enable superuser")]),s._v("\nauth.mongo.super_query "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" on\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##collections for super queries")]),s._v("\nauth.mongo.super_query.collection "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mqtt_user\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##Field for super user")]),s._v("\nauth.mongo.super_query.super_field "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" is_superuser\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Superuser query selector, commas can be used to seperate multiple conditions")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#auth.mongo.super_query.selector = username=%u, clientid=$all")]),s._v("\nauth.mongo.super_query.selector "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%u\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("MongoDB "),a("code",[s._v("and")]),s._v(" query is used in the actual query under multiple conditions of the same "),a("strong",[s._v("selector")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("db.mqtt_user.find"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wivwiv"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clientid"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$all")]),s._v('"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("You can use the following placeholders in your query conditions, and EMQX Broker will automatically populate with client information when executed:")]),s._v(" "),a("ul",[a("li",[s._v("%u：user name")]),s._v(" "),a("li",[s._v("%c：Client ID")])]),s._v(" "),a("p",[s._v("You can adjust the super user query according to business to achieve more business-related functions, such as adding multiple query conditions and using database preprocessing functions. However, in any case, the superuser query needs to meet the following conditions:")]),s._v(" "),a("ol",[a("li",[s._v("The query result must include the is_superuser field, which should be explicitly true")])]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("If superuser functionality is not needed, it can be more efficient when commenting and disabling this option")])]),s._v(" "),a("h2",{attrs:{id:"acl-query"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#acl-query"}},[s._v("#")]),s._v(" acl_query")]),s._v(" "),a("p",[s._v("When performing ACL authentication, EMQX Broker will use the current client information to execute the user-configured superuser query. If superuser query is not enabled or the client is not a superuser, ACL query will be used to find out the ACL rules of client in the database.")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_mongo.conf")]),s._v("\n\nauth.mongo.acl_query "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" on\n\nauth.mongo.acl_query.collection "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mqtt_acl\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Query selector, commas can be used to seperate multiple conditions")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.acl_query.selector = username=%u,clientid=%c")]),s._v("\nauth.mongo.acl_query.selector "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%u\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Using multiple query selectors")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.acl_query.selector.1 = username=$all")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.acl_query.selector.2 = username=%u")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("MongoDB "),a("code",[s._v("and")]),s._v(" query is used in the actual query under multiple "),a("strong",[s._v("conditions")]),s._v("  of the same selector:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("db.mqtt_acl.find"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"emqx"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clientid"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$all")]),s._v('"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("MongoDB "),a("code",[s._v("or")]),s._v(" query is used in actual query under multiple "),a("strong",[s._v("selectors")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("db.mqtt_acl.find"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$or")]),s._v('"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$all")]),s._v('"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"emqx"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("You can use the following placeholders in ACL queries, and EMQX Broker will automatically populate with client information when executed:")]),s._v(" "),a("ul",[a("li",[s._v("%u：username")]),s._v(" "),a("li",[s._v("%c：Client ID")])]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("MongoDB ACL rules need to use the above data structures strictly.")]),s._v(" "),a("p",[s._v("All rules added in MongoDB ACL are "),a("strong",[s._v("allow")]),s._v(" rules. i.e. a whitelist.")]),s._v(" "),a("p",[s._v("When a client's rules list is empty, EMQX continues to check the next auth/ACL plugin.\nOtherwise the check returns immediately without proceeding to the next auth/ACL plugins.")]),s._v(" "),a("p",[s._v("When the rule is non-empty and does not match the corresponding pub/sub permission,\nan ath/ACL failure will be returned (the corresponding pub/sub behavior will be denied) and the auth/ACL chain will be terminated.")]),s._v(" "),a("p",[s._v("When more than one auth/ACL plugins are in use, it is recommended to position MongoDB ACL after other auth/ACL plugins in the enabled plugins list.")])])])}),[],!1,null,null,null);t.default=e.exports}}]);
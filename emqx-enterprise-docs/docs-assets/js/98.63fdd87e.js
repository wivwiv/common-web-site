(window.webpackJsonp=window.webpackJsonp||[]).push([[98],{1185:function(s,a,t){s.exports=t.p+"docs-assets/img/lindorm_create_resource.b7c6a6ef.png"},1186:function(s,a,t){s.exports=t.p+"docs-assets/img/lindorm_resource_status.eeeb777d.png"},1187:function(s,a,t){s.exports=t.p+"docs-assets/img/lindorm_create_rule.64109759.png"},1188:function(s,a,t){s.exports=t.p+"docs-assets/img/lindorm_create_action.c2ee3559.png"},1189:function(s,a,t){s.exports=t.p+"docs-assets/img/lindorm_create_rule_over.623e6db9.png"},1190:function(s,a,t){s.exports=t.p+"docs-assets/img/lindorm_create_rule_run.a0ca6fe3.png"},1800:function(s,a,t){"use strict";t.r(a);var e=t(10),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"保存数据到-lindorm-数据库-自-e3-3-6-和-e4-4-1-起"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#保存数据到-lindorm-数据库-自-e3-3-6-和-e4-4-1-起"}},[s._v("#")]),s._v(" 保存数据到 Lindorm 数据库 (自 e3.3.6 和 e4.4.1 起）")]),s._v(" "),e("p",[s._v("首先确保 Lindorm 数据库开通服务。\n"),e("br"),s._v("\n确保部署 EMQX 的主机 IP 在访问白名单中。阿里云部署的 EMQX 可以通过云主机内网访问 Lindorm，其他类型的部署方式需要开启 Lindorm 外网访问功能。此类操作步骤请参考阿里 Lindorm 操作文档。\n"),e("br"),s._v("\n创建数据库")]),s._v(" "),e("div",{staticClass:"language-SQL line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DATABASE")]),s._v(" DemoDB1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("创建表")]),s._v(" "),e("div",{staticClass:"language-SQL line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" demo_sensor"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    device_id "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARCHAR")]),s._v(" TAG"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("time")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BIGINT")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    msg "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARCHAR")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("资源需要以下启动参数：")]),s._v(" "),e("ul",[e("li",[s._v("Lindorm 服务器：Lindorm 访问地址，Lindorm 提供了域名访问，阿里云主机请填写内网访问地址，默认端口 "),e("code",[s._v("8242")]),s._v("，根据实际情况填写，需要添加 "),e("code",[s._v("http://")]),s._v(" 前缀；")]),s._v(" "),e("li",[s._v("数据库：数据存储的数据库名称，根据创建的服务填写；")]),s._v(" "),e("li",[s._v("连接池大小：数据库写入数据的进程池，根据业务量填写，写入是阻塞型请求，高并发业务推荐 "),e("code",[s._v("CPU 核心数 * 4")]),s._v(" 或者 "),e("code",[s._v("CPU 核心数 * 8")]),s._v(" 以上；")]),s._v(" "),e("li",[s._v("用户名：未开启用户认证不填写，已经开启请按照实际情况填写；")]),s._v(" "),e("li",[s._v("密码：未开启用户认证不填写，已经开启请按照实际情况填写；")])]),s._v(" "),e("p",[e("img",{attrs:{src:t(1185),alt:"image"}})]),s._v(" "),e("p",[s._v("确保资源状态可用（非阿里云部署，可能会出现创建后首次链接比较慢导致不可用状态，点击状态按钮刷新状态）。")]),s._v(" "),e("p",[e("img",{attrs:{src:t(1186),alt:"image"}})]),s._v(" "),e("p",[s._v("创建规则")]),s._v(" "),e("div",{staticClass:"language-SQL line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v("\n  payload "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" msg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  clientid"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("timestamp")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"#"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[e("img",{attrs:{src:t(1187),alt:"image"}})]),s._v(" "),e("p",[s._v("添加动作；")]),s._v(" "),e("ul",[e("li",[s._v("动作类型：数据持久化；保存数据到 Lindorm；")]),s._v(" "),e("li",[s._v("使用资源：选择创建的资源 ID；")]),s._v(" "),e("li",[s._v("表名：同步模式可以使用占位符动态规划，异步批量写入请严格使用表名，不能动态改变；")]),s._v(" "),e("li",[s._v("同步写入：同步即每条数据立即入库，异步模式开启批量功能，数据将按照批量大小和间隔时间规则写入；")]),s._v(" "),e("li",[s._v("异步模式批量大小：默认 100，推荐 100 - 400 取值，可根据业务规划改变；同步模式下忽略此参数；")]),s._v(" "),e("li",[s._v("异步模式批量间隔：默认 100，单位毫秒，推荐 10 - 200；")]),s._v(" "),e("li",[s._v("时间戳：单位毫秒，推荐使用消息时间，空数据会按照规则命中的时间戳计算；")]),s._v(" "),e("li",[s._v("Tags： 数据标签键值对，根据创建的表结构填写；")]),s._v(" "),e("li",[s._v("Fields：数据键值对，根据创建的表结构填写；")])]),s._v(" "),e("p",[e("img",{attrs:{src:t(1188),alt:"image"}})]),s._v(" "),e("p",[s._v("点击确定，点击创建，查看规则：")]),s._v(" "),e("p",[e("img",{attrs:{src:t(1189),alt:"image"}})]),s._v(" "),e("p",[s._v("使用 MQTT 客户端发布消息，查看规则命中与成功失败计数；")]),s._v(" "),e("p",[e("img",{attrs:{src:t(1190),alt:"image"}})]),s._v(" "),e("p",[s._v("使用 API 查询数据库写入结果：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 替换")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ${LINDORM_SERVER}： 服务器地址")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ${DB_NAME}： 数据库名")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ${LINDORM_TABLE}： 表名")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X POST http://"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${LINDORM_SERVER}")]),s._v(":8242/api/v2/sql?database"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DB_NAME}")]),s._v(" -H "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Content-Type: text/plain"')]),s._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'SELECT count(*) FROM ${LINDORM_TABLE}'")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);
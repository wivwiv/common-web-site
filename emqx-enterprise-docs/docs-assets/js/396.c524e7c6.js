(window.webpackJsonp=window.webpackJsonp||[]).push([[396],{1842:function(s,a,t){"use strict";t.r(a);var e=t(10),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"系统调优"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#系统调优"}},[s._v("#")]),s._v(" 系统调优")]),s._v(" "),t("p",[t("em",[s._v("EMQX")]),s._v(" 自 4.2 版本以来，在一台 8 核心、32G 内存的 CentOS 服务器上，MQTT 连接压力测试可达到 130 万。")]),s._v(" "),t("p",[s._v("100 万连接测试所需的 Linux 内核参数，网络协议栈参数，Erlang 虚拟机参数， "),t("em",[s._v("EMQX")]),s._v(" 消息服务器参数设置如下:")]),s._v(" "),t("h2",{attrs:{id:"linux-操作系统参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#linux-操作系统参数"}},[s._v("#")]),s._v(" Linux 操作系统参数")]),s._v(" "),t("p",[s._v("系统全局允许分配的最大文件句柄数:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2 millions system-wide")]),s._v("\nsysctl -w fs.file-max"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2097152")]),s._v("\nsysctl -w fs.nr_open"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2097152")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2097152")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /proc/sys/fs/nr_open\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("允许当前会话 / 进程打开文件句柄数:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("ulimit")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"etc-sysctl-conf"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#etc-sysctl-conf"}},[s._v("#")]),s._v(" /etc/sysctl.conf")]),s._v(" "),t("p",[s._v("持久化 'fs.file-max' 设置到 /etc/sysctl.conf 文件:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("fs.file-max "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("/etc/systemd/system.conf 设置服务最大文件句柄数:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DefaultLimitNOFILE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"etc-security-limits-conf"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#etc-security-limits-conf"}},[s._v("#")]),s._v(" /etc/security/limits.conf")]),s._v(" "),t("p",[s._v("/etc/security/limits.conf 持久化设置允许用户 / 进程打开文件句柄数:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("*      soft   nofile      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v("\n*      hard   nofile      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"tcp-协议栈网络参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tcp-协议栈网络参数"}},[s._v("#")]),s._v(" TCP 协议栈网络参数")]),s._v(" "),t("p",[s._v("并发连接 backlog 设置:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("sysctl -w net.core.somaxconn"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32768")]),s._v("\nsysctl -w net.ipv4.tcp_max_syn_backlog"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("\nsysctl -w net.core.netdev_max_backlog"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("可用知名端口范围:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("sysctl -w net.ipv4.ip_local_port_range"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1000 65535'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("TCP Socket 读写 Buffer 设置:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("sysctl -w net.core.rmem_default"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("262144")]),s._v("\nsysctl -w net.core.wmem_default"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("262144")]),s._v("\nsysctl -w net.core.rmem_max"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16777216")]),s._v("\nsysctl -w net.core.wmem_max"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16777216")]),s._v("\nsysctl -w net.core.optmem_max"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16777216")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#sysctl -w net.ipv4.tcp_mem='16777216 16777216 16777216'")]),s._v("\nsysctl -w net.ipv4.tcp_rmem"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1024 4096 16777216'")]),s._v("\nsysctl -w net.ipv4.tcp_wmem"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1024 4096 16777216'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("TCP 连接追踪设置:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("sysctl -w net.netfilter.nf_conntrack_max"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v("\nsysctl -w net.netfilter.nf_conntrack_tcp_timeout_time_wait"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("TIME-WAIT Socket 最大数量、回收与重用设置:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("sysctl -w net.ipv4.tcp_max_tw_buckets"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意：不建议开启该设置，NAT 模式下可能引起连接 RST")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sysctl -w net.ipv4.tcp_tw_recycle=1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sysctl -w net.ipv4.tcp_tw_reuse=1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("FIN-WAIT-2 Socket 超时设置:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("sysctl -w net.ipv4.tcp_fin_timeout"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"erlang-虚拟机参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#erlang-虚拟机参数"}},[s._v("#")]),s._v(" Erlang 虚拟机参数")]),s._v(" "),t("p",[s._v("优化设置 Erlang 虚拟机启动参数，配置文件 emqx/etc/emqx.conf:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Erlang Process Limit")]),s._v("\nnode.process_limit "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2097152")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Sets the maximum number of simultaneously existing ports for this system")]),s._v("\nnode.max_ports "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h2",{attrs:{id:"docker-参数调优"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-参数调优"}},[s._v("#")]),s._v(" docker 参数调优")]),s._v(" "),t("p",[s._v("通常调优应该在docker的主机上做，但是如果一定要从docker内部做，可以参考如下例子:")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker run -d --name emqx -p 18083:18083 -p 1883:1883 -p 4369:4369 \\\n    --sysctl fs.file-max=2097152 \\\n    --sysctl fs.nr_open=2097152 \\\n    --sysctl net.core.somaxconn=32768 \\\n    --sysctl net.ipv4.tcp_max_syn_backlog=16384 \\\n    --sysctl net.core.netdev_max_backlog=16384 \\\n    --sysctl net.ipv4.ip_local_port_range=1000 65535 \\\n    --sysctl net.core.rmem_default=262144 \\\n    --sysctl net.core.wmem_default=262144 \\\n    --sysctl net.core.rmem_max=16777216 \\\n    --sysctl net.core.wmem_max=16777216 \\\n    --sysctl net.core.optmem_max=16777216 \\\n    --sysctl net.ipv4.tcp_rmem=1024 4096 16777216 \\\n    --sysctl net.ipv4.tcp_wmem=1024 4096 16777216 \\\n    --sysctl net.ipv4.tcp_max_tw_buckets=1048576 \\\n    --sysctl net.ipv4.tcp_fin_timeout=15 \\\n    emqx/emqx:latest\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("::: 友情提示\n不要使用 "),t("code",[s._v("--privileged")]),s._v(" 或者将系统内核目录挂载到docker中进行调优。\n:::")]),s._v(" "),t("h2",{attrs:{id:"emqx-消息服务器参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#emqx-消息服务器参数"}},[s._v("#")]),s._v(" EMQX 消息服务器参数")]),s._v(" "),t("p",[s._v("ceptor 池大小，最大允许连接数。\n\n"),t("code",[s._v("emqx/etc/emqx.conf")]),s._v(" "),t("code",[s._v("emqx/etc/listeners.conf")]),s._v("\n}")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## TCP Listener")]),s._v("\nlistener.tcp.external "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:1883\nlistener.tcp.external.acceptors "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\nlistener.tcp.external.max_connections "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024000")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h2",{attrs:{id:"测试客户端设置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试客户端设置"}},[s._v("#")]),s._v(" 测试客户端设置")]),s._v(" "),t("p",[s._v("测试客户端服务器在一个接口上，最多只能创建 65000 连接:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("sysctl -w net.ipv4.ip_local_port_range"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"500 65535"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /proc/sys/fs/nr_open\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("ulimit")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100000")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"emqtt-bench"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#emqtt-bench"}},[s._v("#")]),s._v(" emqtt_bench")]),s._v(" "),t("p",[s._v("并发连接测试工具: "),t("a",{attrs:{href:"http://github.com/emqx/emqtt_bench",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://github.com/emqx/emqtt_bench"),t("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=n.exports}}]);
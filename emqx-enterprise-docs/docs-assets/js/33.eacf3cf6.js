(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{1606:function(t,s,e){"use strict";e.r(s);var a=e(10),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"save-data-to-mongodb"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#save-data-to-mongodb"}},[t._v("#")]),t._v(" Save data to MongoDB")]),t._v(" "),a("p",[t._v("Setup a MongoDB database, and changes the username/password to root/public, taking Mac OSX for instance:")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ brew "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" mongodb\n$ brew services start mongodb\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## add user root")]),t._v("\n$ use mqtt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n$ db.createUser"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("user: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"root"')]),t._v(", pwd: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"public"')]),t._v(", roles: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("role: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"readWrite"')]),t._v(", db: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mqtt"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## change the config file to enable authentication")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /usr/local/etc/mongod.conf\n\n    security:\n        authorization: enabled\n\n$ brew services restart mongodb\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])]),a("p",[t._v("Initiate the MongoDB table:")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ mongo "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1/mqtt -uroot -ppublic\n\ndb.createCollection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"t_mqtt_msg"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("Create a rule:")]),t._v(" "),a("p",[t._v("Go to "),a("a",{attrs:{href:"http://127.0.0.1:18083/#/rules",target:"_blank",rel:"noopener noreferrer"}},[t._v("EMQX Dashboard"),a("OutboundLink")],1),t._v(', select the "rule" tab on the menu to the left.')]),t._v(" "),a("p",[t._v('Select "message.publish", then type in the following SQL:')]),t._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"message.publish"')]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[a("img",{attrs:{src:e(393),alt:"image"}})]),t._v(" "),a("p",[t._v("Bind an action:")]),t._v(" "),a("p",[t._v('Click on the "+ Add" button under "Action Handler", and then select\n"Data to MongoDB" in the pop-up dialog window.')]),t._v(" "),a("p",[a("img",{attrs:{src:e(698),alt:"image"}})]),t._v(" "),a("p",[t._v("Fill in the parameters required by the action:")]),t._v(" "),a("p",[t._v('Two parameters is required by action "Data to MongoDB":')]),t._v(" "),a("p",[t._v('1). The mongodb collection. Set it to "t_mqtt_msg" we just created.')]),t._v(" "),a("p",[t._v("2). Selector template. Selector template is the keys and values you'd\nlike to insert into mongodb when the action is triggered. In this\nexample we'll insert a message into mongodb, so type in the following\nsql\ntemplate:")]),t._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("msgid"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("${id}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("topic"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("${topic}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("qos"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("${qos}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("payload"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("${payload}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("retain"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("${retain}"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("arrived"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("${"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("timestamp")]),t._v("}\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("Before data is inserted into the table, placeholders like ${key} will\nbe replaced by the corresponding values.")]),t._v(" "),a("p",[a("img",{attrs:{src:e(699),alt:"image"}})]),t._v(" "),a("p",[t._v('3). Bind a resource to the action. Since the dropdown list "Resource"\nis empty for now, we create a new resource by clicking on the "New\nResource" to the top right, and then select "MongoDB Single Mode":')]),t._v(" "),a("p",[a("img",{attrs:{src:e(700),alt:"image"}})]),t._v(" "),a("p",[t._v("Configure the resource:")]),t._v(" "),a("p",[t._v('Set "Database Name" to "mqtt", "Username" to "root", "Password" to\n"public", "Auth Source" to "mqtt", and keep all other configs as\ndefault, and click on the "Testing Connection" button to make sure the\nconnection can be created successfully, and then click on the "Create"\nbutton..')]),t._v(" "),a("p",[a("img",{attrs:{src:e(701),alt:"image"}})]),t._v(" "),a("p",[t._v('Back to the "Actions" dialog, and then click on the "Confirm" button.')]),t._v(" "),a("p",[a("img",{attrs:{src:e(702),alt:"image"}})]),t._v(" "),a("p",[t._v('Back to the creating rule page, then click on "Create" button. The rule we created will be show in the rule list:')]),t._v(" "),a("p",[a("img",{attrs:{src:e(703),alt:"image"}})]),t._v(" "),a("p",[t._v("We have finished, testing the rule by sending an MQTT message to emqx:")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("Topic: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"t/mongo"')]),t._v("\nQoS: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nRetained: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\nPayload: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hello"')]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("Then inspect the MongoDB table, verify a new record has been inserted:")]),t._v(" "),a("p",[a("img",{attrs:{src:e(704),alt:"image"}})]),t._v(" "),a("p",[t._v('And from the rule list, verify that the "Matched" column has increased\nto 1:')]),t._v(" "),a("p",[a("img",{attrs:{src:e(705),alt:"image"}})])])}),[],!1,null,null,null);s.default=n.exports},393:function(t,s,e){t.exports=e.p+"docs-assets/img/mysql_sql_1.515176ea.png"},698:function(t,s,e){t.exports=e.p+"docs-assets/img/mongo_action_0.75b912e3.png"},699:function(t,s,e){t.exports=e.p+"docs-assets/img/mongo_action_1.c77bcb58.png"},700:function(t,s,e){t.exports=e.p+"docs-assets/img/mongo_action_2.be121641.png"},701:function(t,s,e){t.exports=e.p+"docs-assets/img/mongo_resource_0.aad338fb.png"},702:function(t,s,e){t.exports=e.p+"docs-assets/img/mongo_action_3.b14d9682.png"},703:function(t,s,e){t.exports=e.p+"docs-assets/img/mongo_rule_overview_0.7ea77f9a.png"},704:function(t,s,e){t.exports=e.p+"docs-assets/img/mongo_result.291c07aa.png"},705:function(t,s,e){t.exports=e.p+"docs-assets/img/mongo_rule_overview_1.bcb7cbc1.png"}}]);
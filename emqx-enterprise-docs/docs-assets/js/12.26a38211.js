(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{1630:function(e,s,t){"use strict";t.r(s);var a=t(10),n=Object(a.a)({},(function(){var e=this,s=e.$createElement,a=e._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"save-offline-messages-to-redis"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#save-offline-messages-to-redis"}},[e._v("#")]),e._v(" Save offline messages to Redis")]),e._v(" "),a("p",[e._v("Set up the Redis environment, and take MacOS X as an example:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v(" $ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("wget")]),e._v(" http://download.redis.io/releases/redis-4.0.14.tar.gz\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("tar")]),e._v(" xzf redis-4.0.14.tar.gz\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" redis-4.0.14\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("make")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&&")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("make")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Start redis")]),e._v("\n$ redis-server\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br")])]),a("p",[e._v("Create rules:")]),e._v(" "),a("p",[e._v("Open "),a("a",{attrs:{href:"http://127.0.0.1:18083/#/rules",target:"_blank",rel:"noopener noreferrer"}},[e._v("EMQX Dashboard"),a("OutboundLink")],1),e._v(' and select the "Rules" tab on the left.')]),e._v(" "),a("p",[e._v("Then fill in the rule SQL:")]),e._v(" "),a("p",[e._v("FROM description")]),e._v(" "),a("p",[e._v("​\t"),a("strong",[e._v("t/#")]),e._v(": The publisher publishes a message to trigger the action of saving of offline messages to Redis")]),e._v(" "),a("p",[e._v("​\t"),a("strong",[e._v("$events/session_subscribed")]),e._v(": The subscriber subscribes to topics to trigger  the action of getting offline messages")]),e._v(" "),a("p",[e._v("​\t"),a("strong",[e._v("$events/message_acked")]),e._v(": The subscriber replies to the message ACK to trigger the action of deleting the offline message that has been received")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("SELECT * FROM "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"t/#"')]),e._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$events")]),e._v('/session_subscribed"')]),e._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$events")]),e._v('/message_acked"')]),e._v(" WHERE topic "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=~")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'t/#'")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:t(882),alt:""}})]),e._v(" "),a("p",[e._v("Related actions:")]),e._v(" "),a("p",[e._v('Select "Add Action" on the "Response Action" interface, and then select "Save offline messages to Redis" in the "Action" drop-down box')]),e._v(" "),a("p",[a("img",{attrs:{src:t(883),alt:""}})]),e._v(" "),a("p",[e._v("Fill in the action parameters:")]),e._v(" "),a("p",[e._v("The action of saving offline messages to Redis requires two parameters:")]),e._v(" "),a("p",[e._v("1). Redis Key expired TTL")]),e._v(" "),a("p",[e._v('2). Associated resources. Now that the resource drop-down box is empty, and you can click "New Resource" in the upper right corner to create a Redis resource:')]),e._v(" "),a("p",[a("img",{attrs:{src:t(884),alt:""}})]),e._v(" "),a("p",[e._v("Select Redis single-node mode resources.")]),e._v(" "),a("p",[a("img",{attrs:{src:t(409),alt:""}})]),e._v(" "),a("p",[e._v("Fill in the resource configuration:")]),e._v(" "),a("p",[e._v('Fill in the real Redis server address and keep other configurations as default, and then click the "Test Connection" button to ensure that the connection test is successful.')]),e._v(" "),a("p",[e._v('Finally click the "OK" button.')]),e._v(" "),a("p",[a("img",{attrs:{src:t(885),alt:""}})]),e._v(" "),a("p",[e._v('Return to the response action interface and click "OK".')]),e._v(" "),a("p",[a("img",{attrs:{src:t(886),alt:""}})]),e._v(" "),a("p",[e._v('Return to the rule creation interface and click "Create".')]),e._v(" "),a("p",[a("img",{attrs:{src:t(887),alt:""}})]),e._v(" "),a("p",[e._v("The rule has been created, and you can send a piece of data through the WebSocket client of Dashboard "),a("strong",[e._v("(The QoS of the published message must be greater than 0):")])]),e._v(" "),a("p",[a("img",{attrs:{src:t(888),alt:""}})]),e._v(" "),a("p",[e._v("After the message is sent, you can see the message is saved in Redis through Redis CLI:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ redis-cli\n\nKEYS mqtt:msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("*\n\nhgetall Key\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br")])]),a("p",[a("img",{attrs:{src:t(889),alt:""}})]),e._v(" "),a("p",[e._v('Use another client to subscribe to the topic "t/1" '),a("strong",[e._v("(the QoS of the subscribed topic must be greater than 0, otherwise the message will be received repeatedly. Topic wildcard subscription is not supported to get offline messages):")])]),e._v(" "),a("p",[a("img",{attrs:{src:t(890),alt:""}})]),e._v(" "),a("p",[e._v("After subscribing, you will receive the offline message saved in Redis immediately:")]),e._v(" "),a("p",[a("img",{attrs:{src:t(891),alt:""}})]),e._v(" "),a("p",[e._v("Offline messages will be deleted in Redis after being received:")]),e._v(" "),a("p",[a("img",{attrs:{src:t(892),alt:""}})])])}),[],!1,null,null,null);s.default=n.exports},409:function(e,s,t){e.exports=t.p+"docs-assets/img/offline_msg_4.170b2bfe.png"},882:function(e,s,t){e.exports=t.p+"docs-assets/img/offline_msg_1.644b4ff2.png"},883:function(e,s,t){e.exports=t.p+"docs-assets/img/offline_msg_2.b3a3f503.png"},884:function(e,s,t){e.exports=t.p+"docs-assets/img/offline_msg_3.41784c7d.png"},885:function(e,s,t){e.exports=t.p+"docs-assets/img/offline_msg_5.5336d39b.png"},886:function(e,s,t){e.exports=t.p+"docs-assets/img/offline_msg_7.41d1d8c6.png"},887:function(e,s,t){e.exports=t.p+"docs-assets/img/offline_msg_6.58a9a310.png"},888:function(e,s,t){e.exports=t.p+"docs-assets/img/offline_msg_8.9b109a80.png"},889:function(e,s,t){e.exports=t.p+"docs-assets/img/offline_msg_10.5b40c8b3.png"},890:function(e,s,t){e.exports=t.p+"docs-assets/img/offline_msg_11.1cb47e02.png"},891:function(e,s,t){e.exports=t.p+"docs-assets/img/offline_msg_12.4d50b468.png"},892:function(e,s,t){e.exports=t.p+"docs-assets/img/offline_msg_13.4fd9ee7e.png"}}]);
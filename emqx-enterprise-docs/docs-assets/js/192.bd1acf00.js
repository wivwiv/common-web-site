(window.webpackJsonp=window.webpackJsonp||[]).push([[192],{1660:function(s,t,a){"use strict";a.r(t);var n=a(10),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"发布订阅-acl"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#发布订阅-acl"}},[s._v("#")]),s._v(" 发布订阅 ACL")]),s._v(" "),n("p",[n("strong",[s._v("发布订阅 ACL")]),s._v(" 指对 "),n("strong",[s._v("发布 (PUBLISH)/订阅 (SUBSCRIBE)")]),s._v(" 操作的 "),n("strong",[s._v("权限控制")]),s._v("。例如拒绝用户名为 "),n("code",[s._v("Anna")]),s._v(" 向 "),n("code",[s._v("open/elsa/door")]),s._v(" 发布消息。")]),s._v(" "),n("p",[s._v("EMQX 支持通过客户端发布订阅 ACL 进行客户端权限的管理，本章节介绍了 EMQX 支持的发布订阅 ACL 以及对应插件的配置方法。")]),s._v(" "),n("h2",{attrs:{id:"acl-插件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#acl-插件"}},[s._v("#")]),s._v(" ACL 插件")]),s._v(" "),n("p",[s._v("EMQX 支持使用配置文件、外部主流数据库和自定义 HTTP API 作为 ACL 数据源。")]),s._v(" "),n("p",[s._v("连接数据源、进行访问控制功能是通过插件实现的，使用前需要启用相应的插件。")]),s._v(" "),n("p",[s._v("客户端订阅主题、发布消息时插件通过检查目标主题（Topic）是否在指定数据源允许/禁止列表内来实现对客户端的发布、订阅权限管理。")]),s._v(" "),n("p",[n("strong",[s._v("配置文件/内置数据源")])]),s._v(" "),n("ul",[n("li",[n("RouterLink",{attrs:{to:"/zh/enterprise/latest/modules/mnesia_authentication.html"}},[s._v("内置数据库 认证/访问控制")])],1)]),s._v(" "),n("p",[s._v("使用配置文件提供认证数据源，适用于变动较小的 ACL 管理。")]),s._v(" "),n("p",[n("strong",[s._v("外部数据库")])]),s._v(" "),n("ul",[n("li",[n("RouterLink",{attrs:{to:"/zh/enterprise/latest/modules/mysql_authentication.html"}},[s._v("MySQL 认证/访问控制")])],1),s._v(" "),n("li",[n("RouterLink",{attrs:{to:"/zh/enterprise/latest/modules/pgsql_authentication.html"}},[s._v("PostgreSQL 认证/访问控制")])],1),s._v(" "),n("li",[n("RouterLink",{attrs:{to:"/zh/enterprise/latest/modules/redis_authentication.html"}},[s._v("Redis 认证/访问控制")])],1),s._v(" "),n("li",[n("RouterLink",{attrs:{to:"/zh/enterprise/latest/modules/mongo_authentication.html"}},[s._v("MongoDB 认证/访问控制")])],1),s._v(" "),n("li",[n("RouterLink",{attrs:{to:"/zh/enterprise/latest/modules/ldap_authentication.html"}},[s._v("LDAP 认证/访问控制")])],1)]),s._v(" "),n("p",[s._v("外部数据库可以存储大量数据、动态管理 ACL，方便与外部设备管理系统集成。")]),s._v(" "),n("p",[n("strong",[s._v("其他")])]),s._v(" "),n("ul",[n("li",[n("RouterLink",{attrs:{to:"/zh/enterprise/latest/modules/http_authentication.html"}},[s._v("HTTP 认证/访问控制")])],1)]),s._v(" "),n("p",[s._v("HTTP ACL 能够实现复杂的 ACL 管理。")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("p",[s._v("ACL 功能包含在认证鉴权插件中，更改插件配置后需要"),n("strong",[s._v("重启插件")]),s._v("才能生效，")])]),s._v(" "),n("h2",{attrs:{id:"规则详解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#规则详解"}},[s._v("#")]),s._v(" 规则详解")]),s._v(" "),n("p",[s._v("ACL 是允许与拒绝条件的集合，EMQX 中使用以下元素描述 ACL 规则：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Allow-Deny Who Pub-Sub Topic")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"允许(Allow) / 拒绝(Deny)"')]),s._v("  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"谁(Who)"')]),s._v("  "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"订阅(Subscribe) / 发布(Publish)"')]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"主题列表(Topics)"')]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("同时具有多条 ACL 规则时，EMQX 将按照规则排序进行合并，以 ACL 文件中的默认 ACL 为例，ACL 文件中配置了默认的 ACL 规则，规则从下至上加载：")]),s._v(" "),n("ol",[n("li",[s._v("第一条规则允许客户端发布订阅所有主题")]),s._v(" "),n("li",[s._v("第二条规则禁止全部客户端订阅 "),n("code",[s._v("$SYS/#")]),s._v(" 与 "),n("code",[s._v("#")]),s._v(" 主题")]),s._v(" "),n("li",[s._v("第三条规则允许 ip 地址为 "),n("code",[s._v("127.0.0.1")]),s._v(" 的客户端发布/订阅 "),n("code",[s._v("$SYS/#")]),s._v(" 与 "),n("code",[s._v("#")]),s._v(" 主题，为第二条开了特例")]),s._v(" "),n("li",[s._v("第四条规则允许用户名为 "),n("code",[s._v("dashboard")]),s._v(" 的客户端订阅 "),n("code",[s._v("$SYS/#")]),s._v(" 主题，为第二条开了特例")])]),s._v(" "),n("div",{staticClass:"language-erlang line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-erlang"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token atom"}},[s._v("allow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token atom"}},[s._v("user")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dashboard"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token atom"}},[s._v("subscribe")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$SYS/#"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token atom"}},[s._v("allow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token atom"}},[s._v("ipaddr")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token atom"}},[s._v("pubsub")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$SYS/#"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"#"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token atom"}},[s._v("deny")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token atom"}},[s._v("all")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token atom"}},[s._v("subscribe")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$SYS/#"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token atom"}},[s._v("eq")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"#"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token atom"}},[s._v("allow")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token atom"}},[s._v("all")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h2",{attrs:{id:"授权结果"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#授权结果"}},[s._v("#")]),s._v(" 授权结果")]),s._v(" "),n("p",[s._v("任何一次 ACL 授权最终都会返回一个结果：")]),s._v(" "),n("ul",[n("li",[s._v("允许：经过检查允许客户端进行操作")]),s._v(" "),n("li",[s._v("禁止：经过检查禁止客户端操作")]),s._v(" "),n("li",[s._v("忽略（ignore）：未查找到 ACL 权限信息，无法显式判断结果是允许还是禁止，交由下一 ACL 插件或默认 ACL 规则来判断")])]),s._v(" "),n("h2",{attrs:{id:"全局配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#全局配置"}},[s._v("#")]),s._v(" 全局配置")]),s._v(" "),n("p",[s._v("默认配置中 ACL 是开放授权的，即授权结果为"),n("strong",[s._v("忽略（ignore）"),n("strong",[s._v("时")]),s._v("允许")]),s._v("客户端通过授权。")]),s._v(" "),n("p",[s._v("通过 "),n("code",[s._v("etc/emqx.conf")]),s._v(" 中的 ACL 配置可以更改该属性：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/emqx.conf")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## ACL 未匹配时默认授权")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: allow | deny")]),s._v("\nacl_nomatch "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" allow\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("配置默认 ACL 文件，使用文件定义默认 ACL 规则：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/emqx.conf")]),s._v("\n\nacl_file "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" etc/acl.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("配置 ACL 授权结果为"),n("strong",[s._v("禁止")]),s._v("的响应动作，为 "),n("code",[s._v("disconnect")]),s._v(" 时将断开设备：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/emqx.conf")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: ignore | disconnect")]),s._v("\nacl_deny_action "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ignore\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("p",[s._v("在 MQTT v3.1 和 v3.1.1 协议中，发布操作被拒绝后服务器无任何报文错误返回，这是协议设计的一个缺陷。但在 MQTT v5.0 协议上已经支持应答一个相应的错误报文。")])]),s._v(" "),n("h2",{attrs:{id:"超级用户-superuser"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#超级用户-superuser"}},[s._v("#")]),s._v(" 超级用户（superuser）")]),s._v(" "),n("p",[s._v("客户端可拥有“超级用户”身份，超级用户拥有最高权限不受 ACL 限制。")]),s._v(" "),n("ol",[n("li",[s._v("认证鉴权插件启用超级用户功能后，发布订阅时 EMQX 将优先检查客户端超级用户身份")]),s._v(" "),n("li",[s._v("客户端为超级用户时，通过授权并跳过后续 ACL 检查")])]),s._v(" "),n("h2",{attrs:{id:"acl-缓存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#acl-缓存"}},[s._v("#")]),s._v(" ACL 缓存")]),s._v(" "),n("p",[s._v("ACL 缓存允许客户端在命中某条 ACL 规则后，便将其缓存至内存中，以便下次直接使用，客户端发布、订阅频率较高的情况下开启 ACL 缓存可以提高 ACL 检查性能。")]),s._v(" "),n("p",[s._v("在 "),n("code",[s._v("etc/emqx.conf")]),s._v(" 可以配置 ACL 缓存大小与缓存时间：")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/emqx.conf")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 是否启用")]),s._v("\nenable_acl_cache "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" on\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 单个客户端最大缓存规则数量")]),s._v("\nacl_cache_max_size "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 缓存失效时间，超时后缓存将被清除")]),s._v("\nacl_cache_ttl "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 1m\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("h3",{attrs:{id:"清除缓存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#清除缓存"}},[s._v("#")]),s._v(" 清除缓存")]),s._v(" "),n("p",[s._v("在更新 ACL 规则后，某些客户端由于已经存在缓存，则无法立即生效。若要立即生效，则需手动清除所有的 ACL 缓存：")]),s._v(" "),n("p",[s._v("参见 "),n("RouterLink",{attrs:{to:"/zh/enterprise/latest/advanced/http-api.html#endpoint-get-acl-cache"}},[s._v("HTTP API - 清除 ACL 缓存")])],1),s._v(" "),n("h2",{attrs:{id:"acl-鉴权链"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#acl-鉴权链"}},[s._v("#")]),s._v(" ACL 鉴权链")]),s._v(" "),n("p",[s._v("当同时启用多个 ACL 插件时，EMQX 将按照插件开启先后顺序进行链式鉴权：")]),s._v(" "),n("ul",[n("li",[s._v("一通过授权，终止链并允许客户端通过验证")]),s._v(" "),n("li",[s._v("一旦授权失败，终止链并禁止客户端通过验证")]),s._v(" "),n("li",[s._v("直到最后一个 ACL 插件仍未通过，根据"),n("strong",[s._v("默认授权")]),s._v("配置判定\n"),n("ul",[n("li",[s._v("默认授权为允许时，允许客户端通过验证")]),s._v(" "),n("li",[s._v("默认授权为禁止时，禁止客户端通过验证")])])])]),s._v(" "),n("p",[n("img",{attrs:{src:a(952),alt:"_images/guide_3.png"}})]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("p",[s._v("同时只启用一个 ACL 插件可以提高客户端 ACL 检查性能。")])])])}),[],!1,null,null,null);t.default=e.exports},952:function(s,t,a){s.exports=a.p+"docs-assets/img/guide_3.33931aab.png"}}]);
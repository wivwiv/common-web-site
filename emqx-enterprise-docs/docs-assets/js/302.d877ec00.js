(window.webpackJsonp=window.webpackJsonp||[]).push([[302],{1647:function(e,s,n){"use strict";n.r(s);var t=n(10),a=Object(t.a)({},(function(){var e=this,s=e.$createElement,n=e._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"tuning-guide"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tuning-guide"}},[e._v("#")]),e._v(" Tuning guide")]),e._v(" "),n("p",[e._v("Since 4.2 EMQX had been stress-tested with 1.3 million on an 8-core, 32G memory CentOS server.")]),e._v(" "),n("p",[e._v("This guide includes in general tuning suggestions for one EMQX broker to serve about 1 million clients.")]),e._v(" "),n("h2",{attrs:{id:"turn-off-swap"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#turn-off-swap"}},[e._v("#")]),e._v(" Turn off swap")]),e._v(" "),n("p",[e._v("Linux swap partitions may cause nondeterministic memory latency to Erlang virtual machine,\nwhich in turn significantly affects the system stability.\nIt is recommended to turn off swap permanently.")]),e._v(" "),n("p",[e._v("To turn off swap immediately, execute command "),n("code",[e._v("sudo swapoff -a")]),e._v(".\nTo turn off swap permanently, comment out the "),n("code",[e._v("swap")]),e._v(" line in "),n("code",[e._v("/etc/fstab")]),e._v(" and reboot the host")]),e._v(" "),n("h2",{attrs:{id:"linux-kernel-tuning"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#linux-kernel-tuning"}},[e._v("#")]),e._v(" Linux Kernel Tuning")]),e._v(" "),n("p",[e._v("The system-wide limit on max opened file handles:")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("# 2 millions system-wide\nsysctl -w fs.file-max=2097152\nsysctl -w fs.nr_open=2097152\necho 2097152 > /proc/sys/fs/nr_open\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("p",[e._v("The limit on opened file handles for current session:")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("ulimit -n 2097152\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("h3",{attrs:{id:"etc-sysctl-conf"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#etc-sysctl-conf"}},[e._v("#")]),e._v(" /etc/sysctl.conf")]),e._v(" "),n("p",[e._v("Persist 'fs.file-max' configuration to "),n("code",[e._v("/etc/sysctl.conf")]),e._v(":")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("fs.file-max = 2097152\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("Set the maximum number of file handles for the service in "),n("code",[e._v("/etc/systemd/system.conf")]),e._v(":")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("DefaultLimitNOFILE=2097152\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("h3",{attrs:{id:"emqx-service"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#emqx-service"}},[e._v("#")]),e._v(" emqx.service")]),e._v(" "),n("p",[e._v("Set the maximum number of file handles for emqx service in e.g. one of below paths depending\non which linux distribution is in use.")]),e._v(" "),n("ul",[n("li",[n("code",[e._v("/usr/lib/systemd/system/emqx.service")])]),e._v(" "),n("li",[n("code",[e._v("/lib/systemd/system/emqx.service")])])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("LimitNOFILE=2097152\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("h3",{attrs:{id:"etc-security-limits-conf"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#etc-security-limits-conf"}},[e._v("#")]),e._v(" /etc/security/limits.conf")]),e._v(" "),n("p",[e._v("Persist the maximum number of opened file handles for users in "),n("code",[e._v("/etc/security/limits.conf")]),e._v(":")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("*      soft   nofile      2097152\n*      hard   nofile      2097152\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("h2",{attrs:{id:"tcp-network-tuning"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tcp-network-tuning"}},[e._v("#")]),e._v(" TCP Network Tuning")]),e._v(" "),n("p",[e._v("Increase number of incoming connections backlog:")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("sysctl -w net.core.somaxconn=32768\nsysctl -w net.ipv4.tcp_max_syn_backlog=16384\nsysctl -w net.core.netdev_max_backlog=16384\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br")])]),n("p",[e._v("Local port range")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("sysctl -w net.ipv4.ip_local_port_range='1000 65535'\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("TCP Socket read/write buffer:")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("sysctl -w net.core.rmem_default=262144\nsysctl -w net.core.wmem_default=262144\nsysctl -w net.core.rmem_max=16777216\nsysctl -w net.core.wmem_max=16777216\nsysctl -w net.core.optmem_max=16777216\n\n#sysctl -w net.ipv4.tcp_mem='16777216 16777216 16777216'\nsysctl -w net.ipv4.tcp_rmem='1024 4096 16777216'\nsysctl -w net.ipv4.tcp_wmem='1024 4096 16777216'\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br")])]),n("p",[e._v("TCP connection tracking:")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("sysctl -w net.netfilter.nf_conntrack_max=1000000\nsysctl -w net.netfilter.nf_conntrack_tcp_timeout_time_wait=30\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("p",[e._v("TIME-WAIT Bucket Pool, Recycling and Reuse:")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("sysctl -w net.ipv4.tcp_max_tw_buckets=1048576\n\n# Enabling following option is not recommended. It could cause connection reset under NAT\n# sysctl -w net.ipv4.tcp_tw_recycle=1\n# sysctl -w net.ipv4.tcp_tw_reuse=1\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br")])]),n("p",[e._v("Timeout for FIN-WAIT-2 Sockets:")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("sysctl -w net.ipv4.tcp_fin_timeout=15\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("h2",{attrs:{id:"erlang-vm-tuning"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#erlang-vm-tuning"}},[e._v("#")]),e._v(" Erlang VM Tuning")]),e._v(" "),n("p",[e._v("Tuning and optimize the Erlang VM in etc/emqx.conf file")]),e._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Erlang Process Limit")]),e._v("\nnode.process_limit "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("2097152")]),e._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Sets the maximum number of simultaneously existing ports for this system")]),e._v("\nnode.max_ports "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("2097152")]),e._v("\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br")])]),n("h2",{attrs:{id:"when-running-in-docker"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#when-running-in-docker"}},[e._v("#")]),e._v(" When running in docker")]),e._v(" "),n("p",[e._v("Usually you should tune the linux docker host by following the above guide.")]),e._v(" "),n("p",[e._v("If you want to tune linux kernel by docker, you must ensure your docker is latest version (>=1.12).")]),e._v(" "),n("p",[e._v("Here is an example to show how it looks.")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("docker run -d --name emqx -p 18083:18083 -p 1883:1883 \\\n    --sysctl fs.file-max=2097152 \\\n    --sysctl fs.nr_open=2097152 \\\n    --sysctl net.core.somaxconn=32768 \\\n    --sysctl net.ipv4.tcp_max_syn_backlog=16384 \\\n    --sysctl net.core.netdev_max_backlog=16384 \\\n    --sysctl net.ipv4.ip_local_port_range='1000 65535' \\\n    --sysctl net.core.rmem_default=262144 \\\n    --sysctl net.core.wmem_default=262144 \\\n    --sysctl net.core.rmem_max=16777216 \\\n    --sysctl net.core.wmem_max=16777216 \\\n    --sysctl net.core.optmem_max=16777216 \\\n    --sysctl net.ipv4.tcp_rmem='1024 4096 16777216' \\\n    --sysctl net.ipv4.tcp_wmem='1024 4096 16777216\\ \\\n    --sysctl net.ipv4.tcp_max_tw_buckets=1048576 \\\n    --sysctl net.ipv4.tcp_fin_timeout=15 \\\n    emqx/emqx:latest\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br")])]),n("p",[e._v("::: REMEMBER\nThe best practice is NOT to run docker "),n("code",[e._v("--privileged")]),e._v(" and NOT to mount system volumes to the container for kernel tunning.\n:::")]),e._v(" "),n("h2",{attrs:{id:"emqx-broker-tuning"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#emqx-broker-tuning"}},[e._v("#")]),e._v(" EMQX Broker Tuning")]),e._v(" "),n("p",[e._v("tor pool, maxand socket options.\n\n config in "),n("code",[e._v("etc/emqx.conf")]),e._v("\n\n\n config in "),n("code",[e._v("etc/listeners.conf")]),e._v("\n}")]),e._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## TCP Listener")]),e._v("\nlistener.tcp.external "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("0.0")]),e._v(".0.0:1883\nlistener.tcp.external.acceptors "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("64")]),e._v("\nlistener.tcp.external.max_connections "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("1024000")]),e._v("\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("h2",{attrs:{id:"client-machine-tuning"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#client-machine-tuning"}},[e._v("#")]),e._v(" Client Machine Tuning")]),e._v(" "),n("p",[e._v("Tune the client machine to benchmark emqttd broker:")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('sysctl -w net.ipv4.ip_local_port_range="500 65535"\necho 1000000 > /proc/sys/fs/nr_open\nulimit -n 100000\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br")])]),n("h3",{attrs:{id:"emqtt-bench"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#emqtt-bench"}},[e._v("#")]),e._v(" emqtt_bench")]),e._v(" "),n("p",[e._v("Test tool for concurrent connections:  "),n("a",{attrs:{href:"http://github.com/emqx/emqtt_bench",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://github.com/emqx/emqtt_bench"),n("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=a.exports}}]);
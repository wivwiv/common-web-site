(window.webpackJsonp=window.webpackJsonp||[]).push([[306],{1650:function(s,a,t){"use strict";t.r(a);var n=t(10),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"内置-acl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内置-acl"}},[s._v("#")]),s._v(" 内置 ACL")]),s._v(" "),t("p",[s._v("内置 ACL 通过文件设置规则，使用上足够简单轻量，适用于规则数量可预测、无变动需求或变动较小的项目。")]),s._v(" "),t("p",[s._v("ACL 规则文件：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("etc/acl.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("内置 ACL 优先级最低，可以被 ACL 插件覆盖，如需禁用全部注释即可。规则文件更改后需重启 EMQX 以应用生效。")])]),s._v(" "),t("h2",{attrs:{id:"定义-acl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#定义-acl"}},[s._v("#")]),s._v(" 定义 ACL")]),s._v(" "),t("p",[s._v("内置 ACL 是优先级最低规则表，在所有的 ACL 检查完成后，如果仍然未命中则检查默认的 ACL 规则。")]),s._v(" "),t("p",[s._v("该规则文件以 Erlang 语法的格式进行描述：")]),s._v(" "),t("div",{staticClass:"language-erlang line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-erlang"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('%% 允许 "dashboard" 用户 订阅 "$SYS/#" 主题')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("allow")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dashboard"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("subscribe")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$SYS/#"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('%% 允许 IP 地址为 "127.0.0.1" 的用户 发布/订阅 "$SYS/#"，"#" 主题')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("allow")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("ipaddr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("pubsub")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$SYS/#"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"#"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('%% 拒绝 "所有用户" 订阅 "$SYS/#" "#" 主题')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("deny")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("all")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("subscribe")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"$SYS/#"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("eq")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"#"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("%% 允许其它任意的发布订阅操作")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("allow")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("all")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ol",[t("li",[s._v("第一条规则允许客户端发布订阅所有主题")]),s._v(" "),t("li",[s._v("第二条规则禁止全部客户端订阅 "),t("code",[s._v("$SYS/#")]),s._v(" 与 "),t("code",[s._v("#")]),s._v(" 主题")]),s._v(" "),t("li",[s._v("第三条规则允许 ip 地址为 "),t("code",[s._v("127.0.0.1")]),s._v(" 的客户端发布/订阅 "),t("code",[s._v("$SYS/#")]),s._v(" 与 "),t("code",[s._v("#")]),s._v(" 主题，为第二条开了特例")]),s._v(" "),t("li",[s._v("第四条规则允许用户名为 "),t("code",[s._v("dashboard")]),s._v(" 的客户端订阅 "),t("code",[s._v("$SYS/#")]),s._v(" 主题，为第二条开了特例")])]),s._v(" "),t("p",[s._v("可知，默认的 ACL 主要是为了限制客户端对系统主题 "),t("code",[s._v("$SYS/#")]),s._v(" 和全通配主题 "),t("code",[s._v("#")]),s._v(" 的权限。")]),s._v(" "),t("h2",{attrs:{id:"acl-conf-编写规则"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#acl-conf-编写规则"}},[s._v("#")]),s._v(" acl.conf 编写规则")]),s._v(" "),t("p",[t("code",[s._v("acl.conf")]),s._v(" 文件中的规则按书写顺序从上往下匹配。")]),s._v(" "),t("p",[t("code",[s._v("acl.conf")]),s._v(" 的语法规则包含在顶部的注释中，熟悉 Erlang 语法的可直接阅读文件顶部的注释。或参考以下的释义：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("以 "),t("code",[s._v("%%")]),s._v(" 表示行注释。")])]),s._v(" "),t("li",[t("p",[s._v("每条规则由四元组组成，以 "),t("code",[s._v(".")]),s._v(" 结束。")])]),s._v(" "),t("li",[t("p",[s._v("元组第一位：表示规则命中成功后，执行权限控制操作，可取值为：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("allow")]),s._v("：表示 "),t("code",[s._v("允许")])]),s._v(" "),t("li",[t("code",[s._v("deny")]),s._v("： 表示 "),t("code",[s._v("拒绝")])])])]),s._v(" "),t("li",[t("p",[s._v("元组第二位：表示规则所生效的用户，可使用的格式为：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v('{user, "dashboard"}')]),s._v("：表明规则仅对 "),t("em",[s._v("用户名 (Username)")]),s._v(' 为 "dashboard" 的用户生效')]),s._v(" "),t("li",[t("code",[s._v('{client, "dashboard"}')]),s._v("：表明规则仅对 "),t("em",[s._v("客户端标识 (ClientId)")]),s._v(' 为 "dashboard" 的用户生效')]),s._v(" "),t("li",[t("code",[s._v('{ipaddr, "127.0.0.1"}')]),s._v("：表明规则仅对 "),t("em",[s._v("源地址")]),s._v(' 为 "127.0.0.1" 的用户生效')]),s._v(" "),t("li",[t("code",[s._v("all")]),s._v("：表明规则对所有的用户都生效")])])]),s._v(" "),t("li",[t("p",[s._v("元组第三位：表示规则所控制的操作，可取值为：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("publish")]),s._v("：表明规则应用在 PUBLISH 操作上")]),s._v(" "),t("li",[t("code",[s._v("subscribe")]),s._v("：表明规则应用在 SUBSCRIBE 操作上")]),s._v(" "),t("li",[t("code",[s._v("pubsub")]),s._v("：表明规则对 PUBLISH 和 SUBSCRIBE 操作都有效")])])]),s._v(" "),t("li",[t("p",[s._v("元组第四位：表示规则所限制的主题列表，内容以数组的格式给出，例如：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v('"$SYS/#"')]),s._v("：为一个 "),t("strong",[s._v("主题过滤器 (Topic Filter)")]),s._v("；表示规则可命中与 "),t("code",[s._v("$SYS/#")]),s._v(' 匹配的主题；如：可命中 "$SYS/#"，也可命中 "$SYS/a/b/c"')]),s._v(" "),t("li",[t("code",[s._v('{eq, "#"}')]),s._v("：表示字符的全等，规则仅可命中主题为 "),t("code",[s._v("#")]),s._v(" 的字串，不能命中 "),t("code",[s._v("/a/b/c")]),s._v(" 等")])])]),s._v(" "),t("li",[t("p",[s._v("除此之外还存在两条特殊的规则：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("{allow, all}")]),s._v("：允许所有操作")]),s._v(" "),t("li",[t("code",[s._v("{deny, all}")]),s._v("：拒绝所有操作")])])])]),s._v(" "),t("p",[s._v("在 "),t("code",[s._v("acl.conf")]),s._v(" 修改完成后，并不会自动加载至 EMQX 系统。需要手动执行：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("./bin/emqx_ctl modules reload emqx_mod_acl_internal\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"占位符"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#占位符"}},[s._v("#")]),s._v(" 占位符")]),s._v(" "),t("p",[s._v("内置的 "),t("code",[s._v("acl.conf")]),s._v(" 在主题的域（元组的第四位）仅支持以下占位符：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("%c")]),s._v("： 表示客户端 ID，在规则生效时它将被替换为实际的客户端 ID。")]),s._v(" "),t("li",[t("code",[s._v("%u")]),s._v("： 表示客户端的用户名，在规则生效时将被替换为实际的客户端用户名。")])]),s._v(" "),t("p",[s._v("例如：")]),s._v(" "),t("div",{staticClass:"language-erlang line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-erlang"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("allow")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("all")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token atom"}},[s._v("pubsub")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sensor/%c/ctrl"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("表示，"),t("strong",[s._v("允许")]),s._v(" 客户端 ID 为 "),t("code",[s._v("light")]),s._v(" 的客户端 "),t("strong",[s._v("订阅和发布")]),s._v(" 到 "),t("code",[s._v("sensor/light/ctrl")]),s._v(" 主题。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("acl.conf 中应只包含一些简单而通用的规则，使其成为系统基础的 ACL 原则。如果需要支持复杂、大量的 ACL 内容，你应该在认证插件中去实现它。")])])])}),[],!1,null,null,null);a.default=e.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[320],{1669:function(s,a,t){"use strict";t.r(a);var e=t(10),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"postgresql-认证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#postgresql-认证"}},[s._v("#")]),s._v(" PostgreSQL 认证")]),s._v(" "),t("p",[s._v("PostgreSQL 认证使用外部 PostgreSQL 数据库作为认证数据源，可以存储大量数据，同时方便与外部设备管理系统集成。")]),s._v(" "),t("p",[s._v("插件：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("emqx_auth_pgsql\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("emqx_auth_pgsql 插件同时包含 ACL 功能，可通过注释禁用。")])]),s._v(" "),t("p",[s._v("要启用 PostgreSQL 认证，需要在 "),t("code",[s._v("etc/plugins/emqx_auth_pgsql.conf")]),s._v(" 中配置以下内容：")]),s._v(" "),t("h2",{attrs:{id:"postgresql-连接信息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#postgresql-连接信息"}},[s._v("#")]),s._v(" PostgreSQL 连接信息")]),s._v(" "),t("p",[s._v("PostgreSQL 基础连接信息，需要保证集群内所有节点均能访问。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_pgsql.conf")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 服务器地址")]),s._v("\nauth.pgsql.server "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:5432\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 连接池大小")]),s._v("\nauth.pgsql.pool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n\nauth.pgsql.username "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" root\n\nauth.pgsql.password "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" public\n\nauth.pgsql.database "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mqtt\n\nauth.pgsql.encoding "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" utf8\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## TLS 配置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.pgsql.ssl = false")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.pgsql.ssl_opts.keyfile =")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.pgsql.ssl_opts.certfile =")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("h2",{attrs:{id:"默认表结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#默认表结构"}},[s._v("#")]),s._v(" 默认表结构")]),s._v(" "),t("p",[s._v("PostgreSQL 认证默认配置下需要确保数据库中有下表：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" mqtt_user "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  id "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SERIAL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIMARY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  username "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CHARACTER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARYING")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  password "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CHARACTER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARYING")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  salt "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CHARACTER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARYING")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  is_superuser "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BOOLEAN")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UNIQUE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("username"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("默认配置下示例数据如下：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" mqtt_user "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("username"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" password"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" salt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" is_superuser"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'emqx'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'efa1f375d76194fa51a3556a97e641e61685f914d446979da50a551a4333ffd7'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("启用 PostgreSQL 认证后，你可以通过用户名： emqx，密码：public 连接。")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("这是默认配置使用的表结构，熟悉该插件的使用后你可以使用任何满足条件的数据表进行认证。")])]),s._v(" "),t("h2",{attrs:{id:"加盐规则与哈希方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#加盐规则与哈希方法"}},[s._v("#")]),s._v(" 加盐规则与哈希方法")]),s._v(" "),t("p",[s._v("PostgreSQL 认证支持配置"),t("RouterLink",{attrs:{to:"/zh/enterprise/latest/advanced/auth.html#加盐规则与哈希方法"}},[s._v("加盐规则与哈希方法")]),s._v("：")],1),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_pgsql.conf")]),s._v("\n\nauth.pgsql.password_hash "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sha256\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"认证-sql-auth-query"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#认证-sql-auth-query"}},[s._v("#")]),s._v(" 认证 SQL（auth_query）")]),s._v(" "),t("p",[s._v("进行身份认证时，EMQX 将使用当前客户端信息填充并执行用户配置的认证 SQL，查询出该客户端在数据库中的认证数据。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_pgsql.conf")]),s._v("\n\nauth.pgsql.auth_query "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" password from mqtt_user where username "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%u'")]),s._v(" limit "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("你可以在认证 SQL 中使用以下占位符，执行时 EMQX 将自动填充为客户端信息：")]),s._v(" "),t("ul",[t("li",[s._v("%u：用户名")]),s._v(" "),t("li",[s._v("%c：Client ID")]),s._v(" "),t("li",[s._v("%C：TLS 证书公用名（证书的域名或子域名），仅当 TLS 连接时有效")]),s._v(" "),t("li",[s._v("%d：TLS 证书 subject，仅当 TLS 连接时有效")])]),s._v(" "),t("p",[s._v("你可以根据业务需要调整认证 SQL，如添加多个查询条件、使用数据库预处理函数，以实现更多业务相关的功能。但是任何情况下认证 SQL 需要满足以下条件：")]),s._v(" "),t("ol",[t("li",[s._v("查询结果中必须包含 password 字段，EMQX 使用该字段与客户端密码比对")]),s._v(" "),t("li",[s._v("如果启用了加盐配置，查询结果中必须包含 salt 字段，EMQX 使用该字段作为 salt（盐）值")]),s._v(" "),t("li",[s._v("查询结果只能有一条，多条结果时只取第一条作为有效数据")])]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("可以在 SQL 中使用 AS 语法为字段重命名指定 password，或者将 salt 值设为固定值。")])]),s._v(" "),t("h3",{attrs:{id:"进阶"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#进阶"}},[s._v("#")]),s._v(" 进阶")]),s._v(" "),t("p",[s._v("默认表结构中，我们将 username 字段设为了唯一索引（UNIQUE），与默认的查询语句（"),t("code",[s._v("select password from mqtt_user where username = '%u' limit 1")]),s._v("）配合使用可以获得非常不错的查询性能。")]),s._v(" "),t("p",[s._v("如果默认查询条件不能满足您的需要，例如你需要根据 Client ID 查询相应的 Password Hash 和 Salt，请确保将 Client ID 设置为索引；又或者您想要对 Username、Client ID 或者其他更多字段进行多条件查询，建议设置正确的单索引或是联合索引。总之，设置正确的表结构和查询语句，尽可能不要让索引失效而影响查询性能。")])])}),[],!1,null,null,null);a.default=n.exports}}]);
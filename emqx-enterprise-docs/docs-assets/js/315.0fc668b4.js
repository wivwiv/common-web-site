(window.webpackJsonp=window.webpackJsonp||[]).push([[315],{1664:function(s,a,t){"use strict";t.r(a);var e=t(10),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"jwt-认证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jwt-认证"}},[s._v("#")]),s._v(" JWT 认证")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://jwt.io/",target:"_blank",rel:"noopener noreferrer"}},[s._v("JWT"),t("OutboundLink")],1),s._v(" 认证基于 Token 的鉴权机制，不依赖服务端保留客户端的认证信息或者会话信息，在持有密钥的情况下可以批量签发认证信息，是最简便的认证方式。")]),s._v(" "),t("p",[s._v("插件：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("emqx_auth_jwt\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"认证原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#认证原理"}},[s._v("#")]),s._v(" 认证原理")]),s._v(" "),t("p",[s._v("客户端使用 Token 作为用户名或密码（取决于插件配置），发起连接时 EMQX 使用配置中的密钥、证书进行解密，如果能成功解密则认证成功，否则认证失败。")]),s._v(" "),t("p",[s._v("默认配置下启用 JWT 认证后，你可以通过任意用户名+以下密码进行连接：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImF1dGhvciI6IndpdndpdiIsInNpdGUiOiJodHRwczovL3dpdndpdi5jb20ifSwiZXhwIjoxNTgyMjU1MzYwNjQyMDAwMCwiaWF0IjoxNTgyMjU1MzYwfQ.FdyAx2fYahm6h3g47m88ttyINzptzKy_speimyUcma4\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"jwt-acl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jwt-acl"}},[s._v("#")]),s._v(" JWT ACL")]),s._v(" "),t("p",[s._v("JWT 身份验证插件可以从身份验证令牌中提取 ACL 规则。 后面会用到这些 ACL 规则\n授权客户的发布/订阅操作。 请参阅 "),t("RouterLink",{attrs:{to:"/zh/enterprise/latest/advanced/acl-jwt.html"}},[s._v("JWT ACL")]),s._v("。")],1),s._v(" "),t("h2",{attrs:{id:"配置项"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置项"}},[s._v("#")]),s._v(" 配置项")]),s._v(" "),t("p",[s._v("要启用 JWT 认证，需要在 "),t("code",[s._v("etc/plugins/emqx_auth_jwt.conf")]),s._v(" 中配置以下内容：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_jwt.conf")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 密钥")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 使用 HMAC 算法校验 Token 的密钥")]),s._v("\nauth.jwt.secret "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" emqxsecret\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## RSA 或 ECDSA 公钥文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 使用 RSA 或 ECDSA 算法校验 Token 的公钥")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#auth.jwt.pubkey = etc/certs/jwt_public_key.pem")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## JWKs 的服务器地址")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## EMQX 会从 JWKs 服务器获取密钥列表，并用于验证 Token")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## JWKs 规范见: http://self-issued.info/docs/draft-ietf-jose-json-web-key.html")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#auth.jwt.jwks = https://127.0.0.1:8080/jwks")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## JWKs 密钥刷新时间")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#auth.jwt.jwks.refresh_interval = 5m")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 客户端携带 Token 的方式")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: username | password")]),s._v("\nauth.jwt.from "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" password\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 是否校验 JWT 携带的字段")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: on | off")]),s._v("\nauth.jwt.verify_claims "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" off\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 字段校验列表")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 配置格式：auth.jwt.verify_claims.$name = $expected")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##   $name 为需要校验的 JWT 的 payload 中的字段名称")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##   $expected 为期待值")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## $expected 可用的占位符为")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##   - %u: username")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##   - %c: clientid")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 例如：校验 JWT 的 payload 中的 username 是否与")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 客户端(MQTT协议)中携带的 username 一致")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#auth.jwt.verify_claims.username = %u")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br")])]),t("h3",{attrs:{id:"auth-jwt-from"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#auth-jwt-from"}},[s._v("#")]),s._v(" auth.jwt.from")]),s._v(" "),t("p",[s._v("客户端携带 JWT 的位置，用于配置客户端 JWT 字符串携带位置，可选 username 与 password。")]),s._v(" "),t("h3",{attrs:{id:"auth-jwt-verify-claims"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#auth-jwt-verify-claims"}},[s._v("#")]),s._v(" auth.jwt.verify_claims")]),s._v(" "),t("p",[s._v("如果你启用了 "),t("code",[s._v("auth.jwt.verify_claims")]),s._v(" 选项，认证插件在验证 JWT 有效性之后还会进一步验证 Payload 中的数据有效性。")]),s._v(" "),t("p",[s._v("假设你的 Payload 为：")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"username"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"emqx_client_username"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("你可以使用如下配置，当客户端携带此 Token 时，将验证客户端 "),t("code",[s._v("username")]),s._v(" "),t("strong",[s._v("是否等于")]),s._v(" "),t("code",[s._v("emqx_client_username")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Variables:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##   - %u: username")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##   - %c: clientid")]),s._v("\nauth.jwt.verify_claims.username "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" %u\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("支持使用固定值或当前客户端信息进行验证：")]),s._v(" "),t("ul",[t("li",[s._v("%u：当前客户端 username")]),s._v(" "),t("li",[s._v("%c：当前客户端 client id")])]),s._v(" "),t("h2",{attrs:{id:"密钥配置和算法支持"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#密钥配置和算法支持"}},[s._v("#")]),s._v(" 密钥配置和算法支持")]),s._v(" "),t("p",[s._v("JWT 认证支持以三种方式配置密钥，这三种方式分别对应三种类型的算法支持：")]),s._v(" "),t("ul",[t("li",[t("p",[t("code",[s._v("auth.jwt.secret")]),s._v("：对称加密的方式，验证 JWT 的 Token 字段。它支持的算法有：")]),s._v(" "),t("ul",[t("li",[s._v("HS256 - HMAC，使用 SHA-256 哈希算法。")]),s._v(" "),t("li",[s._v("HS384 - HMAC，使用 SHA-384 哈希算法。")]),s._v(" "),t("li",[s._v("HS512 - HMAC，使用 SHA-512 哈希算法。")])])]),s._v(" "),t("li",[t("p",[t("code",[s._v("auth.jwt.pubkey")]),s._v("：使用非对称加密的方式，验证 JWT 的 Token 字段。它支持的算法有：")]),s._v(" "),t("ul",[t("li",[s._v("RS256 - RSA，使用 SHA-256 哈希算法。")]),s._v(" "),t("li",[s._v("RS384 - RSA，使用 SHA-384 哈希算法。")]),s._v(" "),t("li",[s._v("RS512 - RSA，使用 SHA-512 哈希算法。")]),s._v(" "),t("li",[s._v("ES256 - ECDSA，使用 P-256 曲线。")]),s._v(" "),t("li",[s._v("ES384 - ECDSA，使用 P-384 曲线。")]),s._v(" "),t("li",[s._v("ES512 - ECDSA，使用 P-512 曲线。")])])]),s._v(" "),t("li",[t("p",[t("code",[s._v("auth.jwt.jwks")]),s._v("：配置为 "),t("a",{attrs:{href:"http://self-issued.info/docs/draft-ietf-jose-json-web-key.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("JWKs"),t("OutboundLink")],1),s._v(" 服务器地址，从 JWKs 服务器中获取可用的密钥列表。")])])]),s._v(" "),t("p",[s._v("该三类密钥允许同时配置。EMQX 在验证 Token 时会按 "),t("code",[s._v("auth.jwt.secret")]),s._v("，"),t("code",[s._v("auth.jwt.pubkey")]),s._v("，"),t("code",[s._v("auth.jwt.jwks")]),s._v(" 顺序检查。")]),s._v(" "),t("div",{staticClass:"custom-block danger"},[t("p",{staticClass:"custom-block-title"},[s._v("警告")]),s._v(" "),t("p",[s._v("JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限，使用 JWT 时建议启用 TLS 加密传输。\nJWT 使用过程中无法在过期前废止某个 Token，请妥善设置有效时长并保管好密钥等加密信息。")])])])}),[],!1,null,null,null);a.default=n.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[310],{1656:function(s,a,t){"use strict";t.r(a);var n=t(10),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"mongodb-acl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-acl"}},[s._v("#")]),s._v(" MongoDB ACL")]),s._v(" "),t("p",[s._v("MongoDB ACL 使用外部 MongoDB 数据库存储 ACL 规则，可以存储大量数据、动态管理 ACL，方便与外部设备管理系统集成")]),s._v(" "),t("p",[s._v("插件：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("emqx_auth_mongo\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("emqx_auth_mongo 插件同时包含认证功能，可通过注释禁用。")])]),s._v(" "),t("h2",{attrs:{id:"mongodb-连接信息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-连接信息"}},[s._v("#")]),s._v(" MongoDB 连接信息")]),s._v(" "),t("p",[s._v("MongoDB 基础连接信息，需要保证集群内所有节点均能访问。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_mongo.conf")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## MongoDB 架构类型")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: single | unknown | sharded | rs")]),s._v("\nauth.mongo.type "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" single\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## rs 模式需要设置 rs name")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.rs_set_name =")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 服务器列表，集群模式下使用逗号分隔每个服务器")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Examples: 127.0.0.1:27017,127.0.0.2:27017...")]),s._v("\nauth.mongo.server "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:27017\n\nauth.mongo.pool "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n\nauth.mongo.login "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n\nauth.mongo.password "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.auth_source = admin")]),s._v("\n\nauth.mongo.database "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mqtt\n\nauth.mongo.query_timeout "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 5s\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## SSL 选项")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# auth.mongo.ssl = false")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.ssl_opts.keyfile =")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.ssl_opts.certfile =")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.ssl_opts.cacertfile =")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## MongoDB write mode.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: unsafe | safe")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.w_mode =")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Mongo read mode.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: master | slave_ok")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.r_mode =")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## MongoDB 拓扑配置，一般情况下用不到，详见 MongoDB 官网文档")]),s._v("\nauth.mongo.topology.pool_size "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nauth.mongo.topology.max_overflow "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.overflow_ttl = 1000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.overflow_check_period = 1000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.local_threshold_ms = 1000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.connect_timeout_ms = 20000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.socket_timeout_ms = 100")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.server_selection_timeout_ms = 30000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.wait_queue_timeout_ms = 1000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.heartbeat_frequency_ms = 10000")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.topology.min_heartbeat_frequency_ms = 1000")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br")])]),t("h2",{attrs:{id:"默认数据结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#默认数据结构"}},[s._v("#")]),s._v(" 默认数据结构")]),s._v(" "),t("p",[s._v("MongoDB 认证默认配置下需要确保数据库中有如下集合：")]),s._v(" "),t("h3",{attrs:{id:"认证-超级集合"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#认证-超级集合"}},[s._v("#")]),s._v(" 认证/超级集合")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("{\n  username: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  password: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password hash"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  salt: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password salt"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  is_superuser: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  created: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2020-02-20 12:12:14"')]),s._v("\n}\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("示例数据：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("use mqtt\n\ndb.mqtt_user.insert"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"emqx"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"efa1f375d76194fa51a3556a97e641e61685f914d446979da50a551a4333ffd7"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"is_superuser"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" false,\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"salt"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h3",{attrs:{id:"acl-规则集合"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#acl-规则集合"}},[s._v("#")]),s._v(" ACL 规则集合")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    username"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    clientid"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clientid"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    publish"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic2"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ..."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    subscribe"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"subtop1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"subtop2"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ..."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    pubsub"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic/#"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ..."),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("MongoDB ACL 一条规则中定义了发布、订阅和发布/订阅的信息，在规则中的都是"),t("strong",[s._v("允许")]),s._v("列表。")]),s._v(" "),t("p",[s._v("规则字段说明：")]),s._v(" "),t("ul",[t("li",[s._v("username：连接客户端的用户名")]),s._v(" "),t("li",[s._v("clientid：连接客户端的 Client ID")]),s._v(" "),t("li",[s._v("publish：允许发布的主题数值，支持通配符")]),s._v(" "),t("li",[s._v("subscribe：允许订阅的主题数值，支持通配符")]),s._v(" "),t("li",[s._v("pubsub：允许发布订阅的主题数值，支持通配符")])]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("主题可以使用通配符，并且可以在主题中加入占位符来匹配客户端信息，例如 "),t("code",[s._v("t/%c")]),s._v(" 则在匹配时主题将会替换为当前客户端的 Client ID")]),s._v(" "),t("ul",[t("li",[s._v("%u：用户名")]),s._v(" "),t("li",[s._v("%c：Client ID")])])]),s._v(" "),t("p",[s._v("默认配置下示例数据：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("use mqtt\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 所有用户不可以订阅、发布系统主题")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 允许客户端订阅包含自身 Client ID 的 /smarthome/${clientid}/temperature 主题")]),s._v("\ndb.mqtt_acl.insert"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  username: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$all")]),s._v('"')]),s._v(",\n  clientid: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$all")]),s._v('"')]),s._v(",\n  publish: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"#"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n  subscribe: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/smarthome/%c/temperature"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("启用 MongoDB ACL 后并以用户名 emqx 成功连接后，客户端应当数据具有相应的主题权限。")]),s._v(" "),t("h2",{attrs:{id:"超级用户查询-super-query"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#超级用户查询-super-query"}},[s._v("#")]),s._v(" 超级用户查询（super_query）")]),s._v(" "),t("p",[s._v("进行 ACL 鉴权时，EMQX 将使用当前客户端信息填充并执行用户配置的超级用户查询，查询客户端是否为超级用户。客户端为超级用户时将跳过 ACL 查询。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_mongo.conf")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 启用超级用户")]),s._v("\nauth.mongo.super_query "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" on\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 超级查询使用集合")]),s._v("\nauth.mongo.super_query.collection "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mqtt_user\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 超级用户使用字段")]),s._v("\nauth.mongo.super_query.super_field "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" is_superuser\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 超级用户查询选择器，多个条件使用逗号分隔")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#auth.mongo.super_query.selector = username=%u, clientid=$all")]),s._v("\nauth.mongo.super_query.selector "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%u\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("同一个"),t("strong",[s._v("选择器")]),s._v("的多个条件时实际查询中使用 MongoDB "),t("code",[s._v("and")]),s._v(" 查询：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("db.mqtt_user.find"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"wivwiv"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clientid"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$all")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("你可以在查询条件中使用以下占位符，执行时 EMQX 将自动填充为客户端信息：")]),s._v(" "),t("ul",[t("li",[s._v("%u：用户名")]),s._v(" "),t("li",[s._v("%c：Client ID")])]),s._v(" "),t("p",[s._v("你可以根据业务需要调整超级用户查询，如添加多个查询条件、使用数据库预处理函数，以实现更多业务相关的功能。但是任何情况下超级用户查询需要满足以下条件：")]),s._v(" "),t("ol",[t("li",[s._v("查询结果中必须包含 is_superuser 字段，is_superuser 应该显式的为 true")])]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("如果不需要超级用户功能，注释并禁用该选项能有效提高效率")])]),s._v(" "),t("h2",{attrs:{id:"acl-查询-acl-query"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#acl-查询-acl-query"}},[s._v("#")]),s._v(" ACL 查询（acl_query）")]),s._v(" "),t("p",[s._v("进行 ACL 鉴权时，EMQX 将使用当前客户端信息填充并执行用户配置的超级用户查询，如果没有启用超级用户查询或客户端不是超级用户，则使用 ACL 查询 查询出该客户端在数据库中的 ACL 规则。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_mongo.conf")]),s._v("\n\nauth.mongo.acl_query "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" on\n\nauth.mongo.acl_query.collection "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mqtt_acl\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 查询选择器，多个条件时使用逗号分隔")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.acl_query.selector = username=%u,clientid=%c")]),s._v("\nauth.mongo.acl_query.selector "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%u\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 使用多个查询选择器")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.acl_query.selector.1 = username=$all")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.mongo.acl_query.selector.2 = username=%u")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("同一个选择器的多个"),t("strong",[s._v("条件")]),s._v("时实际查询中使用 MongoDB "),t("code",[s._v("and")]),s._v(" 查询：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("db.mqtt_acl.find"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"emqx"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clientid"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$all")]),s._v('"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("多个"),t("strong",[s._v("选择器")]),s._v("时实际查询中使用 MongoDB "),t("code",[s._v("or")]),s._v(" 查询：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("db.mqtt_acl.find"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$or")]),s._v('"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$all")]),s._v('"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"emqx"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("你可以在 ACL 查询中使用以下占位符，执行时 EMQX 将自动填充为客户端信息：")]),s._v(" "),t("ul",[t("li",[s._v("%u：用户名")]),s._v(" "),t("li",[s._v("%c：Client ID")])]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),t("p",[s._v("MongoDB ACL 规则需严格使用上述数据结构。")]),s._v(" "),t("p",[s._v("MongoDB ACL 中添加的所有规则都是 "),t("strong",[s._v("允许")]),s._v(" 规则。即白名单。")]),s._v(" "),t("p",[s._v("MongoDB 中对应 topic 的规则为空时将交由下一个 acl 插件继续检查，否则将立即终止认证链并返回。\n规则非空且未匹配到相应的 pub/sub 权限时，将返回认证失败（拒绝相应的 pub/sub 行为）并终止认证链。")]),s._v(" "),t("p",[s._v("同时启用多个 auth/ACL 插件时，建议将 MongoDB ACL 认证置于其他启用的 auth/ACL 插件后。")])])])}),[],!1,null,null,null);a.default=e.exports}}]);
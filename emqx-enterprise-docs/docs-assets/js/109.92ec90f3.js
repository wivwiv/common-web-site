(window.webpackJsonp=window.webpackJsonp||[]).push([[109],{1081:function(s,t,a){s.exports=a.p+"docs-assets/img/auth_mongo1.00d0db60.png"},1082:function(s,t,a){s.exports=a.p+"docs-assets/img/auth_mongo2.852fb387.png"},1083:function(s,t,a){s.exports=a.p+"docs-assets/img/auth_mongo3.89bd5a0a.png"},1084:function(s,t,a){s.exports=a.p+"docs-assets/img/auth_mongo4.16272c64.png"},1776:function(s,t,a){"use strict";a.r(t);var n=a(10),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"mongodb-认证-访问控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#mongodb-认证-访问控制"}},[s._v("#")]),s._v(" MongoDB 认证/访问控制")]),s._v(" "),n("p",[s._v("MongoDB 认证/访问控制使⽤外部 MongoDB 数据库作为数据源，可以存储⼤量数据，同时⽅便与外部设备管理系统集成。")]),s._v(" "),n("h2",{attrs:{id:"安装mongodb"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装mongodb"}},[s._v("#")]),s._v(" 安装MongoDB")]),s._v(" "),n("p",[s._v("打开 MongoDB 官网地址: https://www.mongodb.com/try/download/community, 选择你需要的版本,这里我们用macOS 4.4.1 版本:")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1081),alt:"image-20200928112030369"}})]),s._v(" "),n("p",[s._v("安装后启动MongoDB")]),s._v(" "),n("h2",{attrs:{id:"创建模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建模块"}},[s._v("#")]),s._v(" 创建模块")]),s._v(" "),n("p",[s._v("打开 "),n("a",{attrs:{href:"http://127.0.0.1:18083/#/modules",target:"_blank",rel:"noopener noreferrer"}},[s._v("EMQX Dashboard"),n("OutboundLink")],1),s._v("，点击左侧的 “模块” 选项卡，选择添加：")]),s._v(" "),n("p",[n("img",{attrs:{src:a(390),alt:"image-20200928161310952"}})]),s._v(" "),n("p",[s._v("选择 MongoDB 认证/访问控制模块")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1082),alt:"image-20200928114546350"}})]),s._v(" "),n("p",[s._v("配置 MongoDB 相关参数")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1083),alt:"image-20200928114832162"}})]),s._v(" "),n("p",[s._v("点击添加后，模块添加完成:")]),s._v(" "),n("p",[n("img",{attrs:{src:a(1084),alt:"image-20200928133916267"}})]),s._v(" "),n("h2",{attrs:{id:"认证集合"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#认证集合"}},[s._v("#")]),s._v(" 认证集合")]),s._v(" "),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  username"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  password"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password hash"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  salt"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"password salt"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  is_superuser"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  created"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2020-02-20 12:12:14"')]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("进行身份认证时，EMQX 将使用当前客户端信息填充并执行用户配置的认证 Query，查询出该客户端在数据库中的认证数据。")]),s._v(" "),n("p",[s._v("MongoDB 支持配置集合名称、认证字段、认证占位符等等参数。")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("配置项")]),s._v(" "),n("th",[s._v("说明")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("认证查询集合")]),s._v(" "),n("td",[s._v("认证查询的MongoDB集合")])]),s._v(" "),n("tr",[n("td",[s._v("认证查询字段名")]),s._v(" "),n("td",[s._v("需要从集合里面查询出来的字段，如果需要查询多个，使用逗号分隔。例如password,salt")])]),s._v(" "),n("tr",[n("td",[s._v("认证条件字段")]),s._v(" "),n("td",[s._v("认证查询的条件，如果需要查询多个，使用逗号分隔。例如 username=%u,clientid=%c")])])])]),s._v(" "),n("p",[s._v("你可以在认证查询占位符中使用以下占位符，执行时 EMQX 将自动填充为客户端信息：")]),s._v(" "),n("ul",[n("li",[s._v("%u：用户名")]),s._v(" "),n("li",[s._v("%c：clientid")]),s._v(" "),n("li",[s._v("%C：TLS 证书公用名（证书的域名或子域名），仅当 TLS 连接时有效")]),s._v(" "),n("li",[s._v("%d：TLS 证书 subject，仅当 TLS 连接时有效")])]),s._v(" "),n("p",[s._v("你可以根据业务需要调整认证查询，如添加多个查询条件、使用数据库预处理函数，以实现更多业务相关的功能。但是任何情况下认证查询需要满足以下条件：")]),s._v(" "),n("ol",[n("li",[s._v("查询结果中必须包含 password 字段，EMQX 使用该字段与客户端密码比对")]),s._v(" "),n("li",[s._v("如果启用了加盐配置，查询结果中必须包含 salt 字段，EMQX 使用该字段作为 salt（盐）值")]),s._v(" "),n("li",[s._v("MongoDB 使用 findOne 查询命令，确保你期望的查询结果能够出现在第一条数据中")])]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("p",[s._v("这是默认配置使用的集合结构，熟悉该插件的使用后你可以使用任何满足条件的集合进行认证。")])]),s._v(" "),n("h2",{attrs:{id:"访问控制集合"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#访问控制集合"}},[s._v("#")]),s._v(" 访问控制集合")]),s._v(" "),n("div",{staticClass:"language-json line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    username"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"username"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    clientid"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clientid"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    publish"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ..."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    subscribe"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"subtop1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"subtop2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ..."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    pubsub"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic/#"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"topic1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ..."),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("MongoDB ACL 一条规则中定义了发布、订阅和发布/订阅的信息，在规则中的都是"),n("strong",[s._v("允许")]),s._v("列表。")]),s._v(" "),n("p",[s._v("规则字段说明：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("配置项")]),s._v(" "),n("th",[s._v("说明")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("访问控制查询集合")]),s._v(" "),n("td",[s._v("访问控制查询的MongoDB集合")])]),s._v(" "),n("tr",[n("td",[s._v("访问控制查询字段名")]),s._v(" "),n("td",[s._v("需要从集合里面查询出来的字段")])]),s._v(" "),n("tr",[n("td",[s._v("访问控制条件字段")]),s._v(" "),n("td",[s._v("访问控制查询的条件，支持and 和 or 操作，and操作通过逗号分隔，例如：username=%u,clientid=%c, or 操作需要添加多条数据")])])])]),s._v(" "),n("h2",{attrs:{id:"超级用户查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#超级用户查询"}},[s._v("#")]),s._v(" 超级用户查询")]),s._v(" "),n("p",[s._v("进行 ACL 鉴权时，EMQX 将使用当前客户端信息填充并执行用户配置的超级用户查询，查询客户端是否为超级用户。客户端为超级用户时将跳过 ACL 查询。\n同一个选择器的多个条件时实际查询中使用 MongoDB and 查询：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('db.mqtt_user.find({\n  "username": "wivwiv"\n  "clientid": "$all"\n})\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("你可以在查询条件中使用以下占位符，执行时 EMQX 将自动填充为客户端信息：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("%u：用户名")])]),s._v(" "),n("li",[n("p",[s._v("%c：clientid")])])]),s._v(" "),n("p",[s._v("你可以根据业务需要调整超级用户查询，如添加多个查询条件、使用数据库预处理函数，以实现更多业务相关的功能。但是任何情况下超级用户查询需要满足以下条件：\n查询结果中必须包含 is_superuser 字段，is_superuser 应该显式的为 true。\nMongoDB 支持配置集合名称、认证字段、认证占位符等等参数。")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("配置项")]),s._v(" "),n("th",[s._v("说明")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("超级用户查询集合")]),s._v(" "),n("td",[s._v("超级用户查询的MongoDB集合")])]),s._v(" "),n("tr",[n("td",[s._v("超级用户查询字段名")]),s._v(" "),n("td",[s._v("需要从集合里面查询出来的字段")])]),s._v(" "),n("tr",[n("td",[s._v("超级用户条件字段")]),s._v(" "),n("td",[s._v("超级用户查询的条件，如果需要查询多个，使用逗号分隔。例如 username=%u,clientid=%c")])])])]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("p",[s._v("MongoDB ACL 规则需严格使用上述数据结构。 MongoDB ACL 中添加的所有规则都是 允许 规则，可以搭配 "),n("code",[s._v("etc/emqx.conf")]),s._v(" 中 "),n("code",[s._v("acl_nomatch = deny")]),s._v(" 使用。")])]),s._v(" "),n("h2",{attrs:{id:"加密规则"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#加密规则"}},[s._v("#")]),s._v(" 加密规则")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 不加盐，明文")]),s._v("\nplain\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 不加盐，仅做哈希处理")]),s._v("\nsha256\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## salt 前缀：使用 sha256 加密 salt + 密码 拼接的字符串")]),s._v("\nsalt,sha256\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## salt 后缀：使用 sha256 加密 密码 + salt 拼接的字符串")]),s._v("\nsha256,salt\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## pbkdf2 with macfun iterations dklen")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## macfun: md4, md5, ripemd160, sha, sha224, sha256, sha384, sha512")]),s._v("\npbkdf2,sha256,1000,20\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("p",[s._v("可参考:"),n("a",{attrs:{href:"https://docs.emqx.cn/cn/broker/latest/advanced/auth.html#%E5%AF%86%E7%A0%81%E5%8A%A0%E7%9B%90%E8%A7%84%E5%88%99%E4%B8%8E%E5%93%88%E5%B8%8C%E6%96%B9%E6%B3%95",target:"_blank",rel:"noopener noreferrer"}},[s._v("加盐规则与哈希方法"),n("OutboundLink")],1),s._v("。")])])])}),[],!1,null,null,null);t.default=e.exports},390:function(s,t,a){s.exports=a.p+"docs-assets/img/modules.89e07c9c.png"}}]);
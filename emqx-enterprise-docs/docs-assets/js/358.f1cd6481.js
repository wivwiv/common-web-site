(window.webpackJsonp=window.webpackJsonp||[]).push([[358],{1724:function(e,_,t){"use strict";t.r(_);var a=t(10),v=Object(a.a)({},(function(){var e=this,_=e.$createElement,t=e._self._c||_;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"升级到-4-3-版本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#升级到-4-3-版本"}},[e._v("#")]),e._v(" 升级到 4.3 版本")]),e._v(" "),t("p",[e._v("以下内容仅针对从 4.2 升级到 4.3 的用户。")]),e._v(" "),t("p",[e._v("由于数据库架构和 Broker 间 API 更改，EMQX 4.3 节点将无法加入 4.2 集群。")]),e._v(" "),t("p",[e._v("推荐按以下步骤完成升级：")]),e._v(" "),t("ol",[t("li",[e._v("从 4.2 任一节点导出数据（见下文）")]),e._v(" "),t("li",[e._v("使用 4.3 的配置创建备用的 4.3 集群")]),e._v(" "),t("li",[e._v("将导出数据导入至 4.3 任一节点，然后重启集群")]),e._v(" "),t("li",[e._v("将流量从 4.2 集群切换至 4.3 集群")]),e._v(" "),t("li",[e._v("关闭 4.2 集群")])]),e._v(" "),t("p",[e._v("旧集群中存储在内置数据库（Mneisa）的数据可以通过 "),t("a",{attrs:{href:"#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB"}},[e._v("数据库迁移")]),e._v(" 来迁移至新集群。此外还有一些重要的 "),t("a",{attrs:{href:"#%E9%87%8D%E8%A6%81%E7%9A%84%E9%85%8D%E7%BD%AE%E5%8F%98%E6%9B%B4"}},[e._v("配置变更")]),e._v(" 和 "),t("a",{attrs:{href:"#%E9%87%8D%E8%A6%81%E7%9A%84%E8%A1%8C%E4%B8%BA%E5%8F%98%E6%9B%B4"}},[e._v("行为变更")]),e._v("，详见下文。")]),e._v(" "),t("h2",{attrs:{id:"数据迁移"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据迁移"}},[e._v("#")]),e._v(" 数据迁移")]),e._v(" "),t("p",[e._v("在升级前，应备在每个4.2版本的节点上对 "),t("code",[e._v("data")]),e._v(" 目录中的数据进行备份。\n根据不同的安装方式和配置，"),t("code",[e._v("data")]),e._v(" 目录可能在一下这些位置")]),e._v(" "),t("ul",[t("li",[e._v("环境变量 "),t("code",[e._v("EMQX_NODE__DATA_DIR")]),e._v(" 指向的位置")]),e._v(" "),t("li",[e._v("配置文件中 "),t("code",[e._v("node.data_dir")]),e._v(" 指向的位置")]),e._v(" "),t("li",[e._v("在docker中运行的默认位置: "),t("code",[e._v("/opt/emqx/data")]),e._v(" （通常是一个挂在的外部volume）")]),e._v(" "),t("li",[e._v("直接使用 zip 安装包的默认位置: "),t("code",[e._v("<install-path>/data")])]),e._v(" "),t("li",[e._v("使用RPM或DEB安装包安装的默认位置："),t("code",[e._v("/var/lib/emqx/")])])]),e._v(" "),t("h3",{attrs:{id:"复制-data-目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#复制-data-目录"}},[e._v("#")]),e._v(" 复制 Data 目录")]),e._v(" "),t("p",[e._v("从4.2升级到4.3前，如果4.3在另外一台主机，则需要将备份的data目录复制到新主机上。\n但是 data/mnesia 目录除外（或者在复制之后删除）。")]),e._v(" "),t("h3",{attrs:{id:"数据库迁移"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据库迁移"}},[e._v("#")]),e._v(" 数据库迁移")]),e._v(" "),t("p",[e._v("注：详情请参阅 "),t("RouterLink",{attrs:{to:"/zh/enterprise/latest/advanced/data-import-and-export.html"}},[e._v("数据导入导出")]),e._v("。")],1),e._v(" "),t("p",[e._v("执行以下命令以导出数据：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("$ emqx_ctl data "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("这将生成一个名称中带有时间戳的 JSON 文件，该文件包含了旧集群的所有可迁移数据，可用于导入至新集群。")]),e._v(" "),t("p",[t("code",[e._v("emqx_auth_mnesia")]),e._v(" 插件现在支持基于 "),t("code",[e._v("clientid")]),e._v(" 和 "),t("code",[e._v("username")]),e._v(" 的规则。而此前只支持一种类型的过滤器，如 "),t("code",[e._v("etc/plugins/emqx_auth_mnesia.conf")]),e._v(" 文件中配置的那样。")]),e._v(" "),t("p",[e._v("为了正确导入来自旧版本 "),t("code",[e._v("emqx_auth_mnesia")]),e._v(" 插件的数据，需要将该参数的值通过命令行参数选项传递给数据导入命令：")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("$ emqx_ctl data "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("import")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("filename"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" --env "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('\'{"auth.mnesia.as":"username"}\'')]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("或者")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("$ emqx_ctl data "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("import")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("filename"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" --env "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('\'{"auth.mnesia.as":"clientid"}\'')]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("h3",{attrs:{id:"重要的配置变更"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#重要的配置变更"}},[e._v("#")]),e._v(" 重要的配置变更")]),e._v(" "),t("ul",[t("li",[e._v("EMQX 现在默认尝试使用 TLS 1.3，请确保 openssl 是最新的(1.1.1)，否则可能需要更改 SSL 相关配置，例如从 "),t("code",[e._v("listener.ssl.external.tls_versions")]),e._v(" 的列表中删除 "),t("code",[e._v("tlsv1.3")])]),e._v(" "),t("li",[e._v("新增 "),t("code",[e._v("listener.ws.$zone.check_origin_enable")]),e._v(" "),t("code",[e._v("listener.ws.$zone.allow_origin_absence")]),e._v(" 和 "),t("code",[e._v("listener.ws.$zone.check_origins")]),e._v(" 配置以获得更好的 WebSocket 安全性。")]),e._v(" "),t("li",[e._v("配置项 "),t("code",[e._v("listener.ws.$name.verify_protocol_header")]),e._v(" 由 "),t("code",[e._v("listener.ws.external.fail_if_no_subprotocol")]),e._v(" 和 "),t("code",[e._v("listener.ws.external.supported_subprotocols")]),e._v(" 替代。")]),e._v(" "),t("li",[e._v("配置项 "),t("code",[e._v("node.heartbeat")]),e._v(" 不能被环境变量 "),t("code",[e._v("EMQX_NODE__HEARTBEAT")]),e._v(" 覆盖，待修复，"),t("a",{attrs:{href:"https://github.com/emqx/emqx/issues/5929",target:"_blank",rel:"noopener noreferrer"}},[e._v("Github Issue#5929"),t("OutboundLink")],1)]),e._v(" "),t("li",[e._v("支持设置 "),t("code",[e._v("log.formatter = json")]),e._v(" 以 JSON 格式输出日志，但可能需要更多 CPU 资源")]),e._v(" "),t("li",[e._v("支持设置 "),t("code",[e._v("log.single_line = true")]),e._v(" 以阻止单条日志发生换行。")]),e._v(" "),t("li",[t("code",[e._v("rpc.tcp_client_num")]),e._v(" 默认配置为 1。大于 1 的值可能会导致集群节点间传递消息时乱序。")])]),e._v(" "),t("h4",{attrs:{id:"重要的插件配置变更"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#重要的插件配置变更"}},[e._v("#")]),e._v(" 重要的插件配置变更")]),e._v(" "),t("h5",{attrs:{id:"emqx-auth-http"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#emqx-auth-http"}},[e._v("#")]),e._v(" "),t("code",[e._v("emqx_auth_http")])]),e._v(" "),t("p",[e._v("为了更容易理解，我们将使用关键字 "),t("code",[e._v("REQUEST")]),e._v(" 来指代 "),t("code",[e._v("auth_req")]),e._v("、"),t("code",[e._v("super_req")]),e._v(" 和 "),t("code",[e._v("acl_req")]),e._v("。")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("auth.http.REQUEST")]),e._v(" 更名为 "),t("code",[e._v("auth.http.REQUEST.url")]),e._v("。")]),e._v(" "),t("li",[t("code",[e._v("auth.http.header.<Key>")]),e._v(" 更名为 "),t("code",[e._v("auth.http.REQUEST.headers.<Key> = <Value>")]),e._v("。即现在可以为每个 REQUEST 类型配置不同的 HTTP Headers。")]),e._v(" "),t("li",[t("code",[e._v("auth.http.REQUEST.content_type")]),e._v(" 更名为 "),t("code",[e._v("auth.http.REQUEST.headers.content_type")]),e._v("。")]),e._v(" "),t("li",[t("code",[e._v("auth.http.request.timeout")]),e._v(" 更名为 "),t("code",[e._v("auth.http.timeout")]),e._v("。")]),e._v(" "),t("li",[t("code",[e._v("auth.http.request.connect_timeout")]),e._v(" 更名为 "),t("code",[e._v("auth.http.connect_timeout")]),e._v("。")]),e._v(" "),t("li",[e._v("废弃 "),t("code",[e._v("auth.http.request.retry_times")]),e._v("，"),t("code",[e._v("auth.http.request.retry_interval")]),e._v(" 和 "),t("code",[e._v("auth.http.request.retry_backoff")]),e._v(" 配置项。")]),e._v(" "),t("li",[e._v("新增 "),t("code",[e._v("auth.http.pool_size")]),e._v(" 以支持配置进程池大小。")]),e._v(" "),t("li",[e._v("新增 "),t("code",[e._v("auth.http.enable_pipelining")]),e._v(" 以支持开启或关闭 HTTP Pipelining。")]),e._v(" "),t("li",[e._v("新增安全相关配置："),t("code",[e._v("auth.http.ssl.verify")]),e._v(" 和 "),t("code",[e._v("auth.http.ssl.server_name_indication")]),e._v("。")])]),e._v(" "),t("h5",{attrs:{id:"emqx-auth-mongo"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#emqx-auth-mongo"}},[e._v("#")]),e._v(" "),t("code",[e._v("emqx_auth_mongo")])]),e._v(" "),t("ul",[t("li",[t("code",[e._v("auth.mongo.login")]),e._v(" 更名为 "),t("code",[e._v("auth.mongo.username")])]),e._v(" "),t("li",[t("code",[e._v("auth.mongo.ssl_opts.*")]),e._v(" 更名为 "),t("code",[e._v("auth.mongo.ssl.*")])])]),e._v(" "),t("h5",{attrs:{id:"emqx-auth-pgsql"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#emqx-auth-pgsql"}},[e._v("#")]),e._v(" "),t("code",[e._v("emqx_auth_pgsql")])]),e._v(" "),t("ul",[t("li",[t("code",[e._v("auth.pgsql.ssl_opts.*")]),e._v(" 更名为 "),t("code",[e._v("auth.mongo.pgsql.*")])])]),e._v(" "),t("h5",{attrs:{id:"emqx-auth-redis"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#emqx-auth-redis"}},[e._v("#")]),e._v(" "),t("code",[e._v("emqx_auth_redis")])]),e._v(" "),t("ul",[t("li",[e._v("SSL 配置现在按配置路径中的 "),t("code",[e._v(".ssl")]),e._v(" 分组。例如"),t("code",[e._v("auth.redis.cacertfile")]),e._v(" 现在是 "),t("code",[e._v("auth.redis.ssl.cacertfile")]),e._v("。")])]),e._v(" "),t("h5",{attrs:{id:"emqx-web-hook"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#emqx-web-hook"}},[e._v("#")]),e._v(" "),t("code",[e._v("emqx_web_hook")])]),e._v(" "),t("p",[e._v("注：规则引擎中的 Webhook 资源和操作可以通过数据库迁移命令进行迁移。")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("web.hook.api.url")]),e._v(" 更名为 "),t("code",[e._v("web.hook.url")]),e._v("。")]),e._v(" "),t("li",[t("code",[e._v("web.hook.encode_payload")]),e._v(" 更名为 "),t("code",[e._v("web.hook.body.encoding_of_payload_field")])]),e._v(" "),t("li",[e._v("新增安全相关配置： "),t("code",[e._v("web.hook.ssl.verify")]),e._v(" 和 "),t("code",[e._v("web.hook.ssl.server_name_indication")])]),e._v(" "),t("li",[e._v("新增 "),t("code",[e._v("web.hook.pool_size")]),e._v(" 以支持配置进程池大小。")]),e._v(" "),t("li",[e._v("新增 "),t("code",[e._v("web.hook.enable_pipelining")]),e._v(" 以支持开启或关闭 HTTP Pipelining。")])]),e._v(" "),t("h3",{attrs:{id:"重要的行为变更"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#重要的行为变更"}},[e._v("#")]),e._v(" 重要的行为变更")]),e._v(" "),t("ul",[t("li",[e._v("日志时间戳现在是 RFC3339 格式，请确保您的日志索引器已准备好进行此更改。")]),e._v(" "),t("li",[e._v("共享订阅分发策略配置为 "),t("code",[e._v("round_robin")]),e._v(" 时的行为变更为随机选择起始订阅者。")]),e._v(" "),t("li",[e._v("多语言扩展功能底层实现方式由 erlport 改为 gRPC，因此无法兼容基于 4.2 开发的 Java、Python 扩展代码。")]),e._v(" "),t("li",[e._v("新安装包不再支持 macOS 10.14 以下版本（不包括 10.14）。")])])])}),[],!1,null,null,null);_.default=v.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{1612:function(s,t,a){"use strict";a.r(t);var e=a(10),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"save-data-to-postgresql"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#save-data-to-postgresql"}},[s._v("#")]),s._v(" Save data to PostgreSQL")]),s._v(" "),e("p",[s._v("Setup a PostgreSQL database, taking Mac OSX for instance:")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ brew "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" postgresql\n\n$ brew services start postgresql\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## create root user")]),s._v("\n$ createuser --interactive --pwprompt\nEnter name of role to add: root\nEnter password "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" new role: public\nEnter it again: public\nShall the new role be a superuser? "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("y/n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" y\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## create database named 'mqtt' using root")]),s._v("\n$ createdb -U root mqtt\n\n$ psql -U root mqtt\n\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("mqtt")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("dn"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nList of schemas\nName  "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Owner\n--------+-------\npublic "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" shawn\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" row"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("p",[s._v("Initiate PgSQL table:")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("$ psql -U root mqtt\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("create "),e("code",[s._v("t_mqtt_msg")]),s._v(" table:")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" t_mqtt_msg "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    id "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SERIAL")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("primary")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("key")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    msgid "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("character")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varying")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    sender "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("character")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varying")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    topic "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("character")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varying")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("255")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    qos "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("integer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    retain "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("integer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    payload "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("text")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    arrived "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("timestamp")]),s._v(" without "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("time")]),s._v(" zone\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("Create a rule:")]),s._v(" "),e("p",[s._v("Go to "),e("a",{attrs:{href:"http://127.0.0.1:18083/#/rules",target:"_blank",rel:"noopener noreferrer"}},[s._v("EMQX Dashboard"),e("OutboundLink")],1),s._v(', select the "Rule" tab on the menu to the left.')]),s._v(" "),e("p",[s._v('Select "message.publish", then type in the following SQL:')]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v("\n "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v("\n "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"message.publish"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("img",{attrs:{src:a(393),alt:"image"}})]),s._v(" "),e("p",[s._v("Bind an action:")]),s._v(" "),e("p",[s._v('Click on the "+ Add" button under "Action Handler", and then select\n"Data to PostgreSQL" in the pop-up dialog window.')]),s._v(" "),e("p",[e("img",{attrs:{src:a(742),alt:"image"}})]),s._v(" "),e("p",[s._v("Fill in the parameters required by the action:")]),s._v(" "),e("p",[s._v('Two parameters is required by action "Data to PostgreSQL":')]),s._v(" "),e("p",[s._v("1). SQL template. SQL template is the sql command you'd like to run\nwhen the action is triggered. In this example we'll insert a message\ninto pgsql, so type in the following sql\ntemplate:")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" t_mqtt_msg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("msgid"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" topic"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" qos"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" retain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" payload"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" arrived"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("${id}"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ${topic}"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ${qos}"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ${retain}"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ${payload}"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" to_timestamp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("${"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("timestamp")]),s._v("}::"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("double")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("precision")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("returning")]),s._v(" id\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("Before data is inserted into the table, placeholders like ${key} will\nbe replaced by the corresponding values.")]),s._v(" "),e("p",[e("img",{attrs:{src:a(743),alt:"image"}})]),s._v(" "),e("p",[s._v('2). Bind a resource to the action. Since the dropdown list "Resource"\nis empty for now, we create a new resource by clicking on the "New\nResource" to the top right, and then select "PostgreSQL":')]),s._v(" "),e("p",[e("img",{attrs:{src:a(744),alt:"image"}})]),s._v(" "),e("p",[s._v('Select "PostgreSQL Resource".')]),s._v(" "),e("p",[s._v("Configure the resource:")]),s._v(" "),e("p",[s._v('Set "PostgreSQL Database" to "mqtt", "PostgreSQL User" to "root", and\nkeep all other configs as default, and click on the "Testing\nConnection" button to make sure the connection can be created\nsuccessfully.')]),s._v(" "),e("p",[s._v('Finally click on the "Create" button.')]),s._v(" "),e("p",[e("img",{attrs:{src:a(745),alt:"image"}})]),s._v(" "),e("p",[s._v('Back to the "Actions" dialog, and then click on the "Confirm"\nbutton.')]),s._v(" "),e("p",[e("img",{attrs:{src:a(746),alt:"image"}})]),s._v(" "),e("p",[s._v('Back to the creating rule page, then click on "Create" button. The\nrule we created will be show in the rule list:')]),s._v(" "),e("p",[e("img",{attrs:{src:a(747),alt:"image"}})]),s._v(" "),e("p",[s._v("We have finished, testing the rule by sending an MQTT message to\nemqx:")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Topic: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"t/1"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" QoS: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Retained: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Payload: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello1"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("Then inspect the PgSQL table, verify a new record has been inserted:")]),s._v(" "),e("p",[e("img",{attrs:{src:a(748),alt:"image"}})]),s._v(" "),e("p",[s._v('And from the rule list, verify that the "Matched" column has increased\nto 1:')]),s._v(" "),e("p",[e("img",{attrs:{src:a(749),alt:"image"}})])])}),[],!1,null,null,null);t.default=n.exports},393:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_sql_1.515176ea.png"},742:function(s,t,a){s.exports=a.p+"docs-assets/img/pgsql_action_0.5cd8dfc0.png"},743:function(s,t,a){s.exports=a.p+"docs-assets/img/pgsql_action_1.608ad6ab.png"},744:function(s,t,a){s.exports=a.p+"docs-assets/img/pgsql_resource_0.051a71d9.png"},745:function(s,t,a){s.exports=a.p+"docs-assets/img/pgsql_resource_1.1415591a.png"},746:function(s,t,a){s.exports=a.p+"docs-assets/img/pgsql_action_2.ce6254e6.png"},747:function(s,t,a){s.exports=a.p+"docs-assets/img/pgsql_rule_overview_1.ec2a38e6.png"},748:function(s,t,a){s.exports=a.p+"docs-assets/img/pgsql_result_1.f3885317.png"},749:function(s,t,a){s.exports=a.p+"docs-assets/img/pgsql_rule_overview_2.153f45ab.png"}}]);
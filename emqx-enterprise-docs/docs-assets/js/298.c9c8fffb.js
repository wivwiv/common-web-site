(window.webpackJsonp=window.webpackJsonp||[]).push([[298],{1641:function(s,t,e){"use strict";e.r(t);var a=e(10),n=Object(a.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"custom-codec-example-protobuf"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#custom-codec-example-protobuf"}},[s._v("#")]),s._v(" Custom codec example - Protobuf")]),s._v(" "),e("h2",{attrs:{id:"rule-requirements"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#rule-requirements"}},[s._v("#")]),s._v(" Rule requirements")]),s._v(" "),e("p",[s._v('The device publishes a binary message encoded using Protobuf, which needs to be matched by the rule engine and then republished to the topic associated with the "name" field. The format of the topic is "person/${name}".')]),s._v(" "),e("p",[s._v('For example, republish a message with the "name" field as "Shawn" to the topic "person/Shawn".')]),s._v(" "),e("h2",{attrs:{id:"create-schema"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#create-schema"}},[s._v("#")]),s._v(" Create schema")]),s._v(" "),e("p",[s._v("In the "),e("a",{attrs:{href:"http://127.0.0.1:18083/#/schemas/0?oper=create",target:"_blank",rel:"noopener noreferrer"}},[s._v("Dashboard"),e("OutboundLink")],1),s._v(" interface of EMQX, create a Protobuf Schema using the following parameters:")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("Name: protobuf_person")])]),s._v(" "),e("li",[e("p",[s._v("Codec Type: protobuf")])]),s._v(" "),e("li",[e("p",[s._v("Schema: The following protobuf schema defines a Person message.")])])]),s._v(" "),e("div",{staticClass:"language-protobuf line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-protobuf"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("message")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Person")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("required")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" name "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("required")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int32")]),s._v(" id "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("optional")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" email "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h2",{attrs:{id:"creating-rules"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#creating-rules"}},[s._v("#")]),s._v(" Creating rules")]),s._v(" "),e("p",[e("strong",[s._v("Use the Schema you have just created to write the rule SQL statement:")])]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v("\n  schema_decode"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'protobuf_person'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" payload"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Person'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" person"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" payload\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"t/#"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v("\n  person"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Shawn'")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("The key point here is "),e("code",[s._v("schema_decode('protobuf_person', payload, 'Person')")]),s._v(":")]),s._v(" "),e("ul",[e("li",[s._v("The "),e("code",[s._v("schema_decode")]),s._v(" function decodes the contents of the payload field according to the Schema 'protobuf_person';")]),s._v(" "),e("li",[e("code",[s._v("as person")]),s._v(' stores the decoded value in the variable "person";')]),s._v(" "),e("li",[s._v("The last argument "),e("code",[s._v("Person")]),s._v(" specifies that the message type in the payload is the 'Person' type defined in the protobuf schema.")])]),s._v(" "),e("p",[e("strong",[s._v("Then add the action using the following parameters:")])]),s._v(" "),e("ul",[e("li",[s._v("Action Type: Message republishing")]),s._v(" "),e("li",[s._v("Destination Topic: person/${person.name}")]),s._v(" "),e("li",[s._v("Message Content Template: ${person}")])]),s._v(" "),e("p",[s._v('This action sends the decoded "person" to the topic '),e("code",[s._v("person/${person.name}")]),s._v(" in JSON format. "),e("code",[s._v("${person.name}")]),s._v(' is a variable placeholder that will be replaced at runtime with the value of the "name" field in the message content.')]),s._v(" "),e("h2",{attrs:{id:"device-side-code"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#device-side-code"}},[s._v("#")]),s._v(" Device side code")]),s._v(" "),e("p",[s._v("Once the rules have been created, it is time to simulate the data for testing.")]),s._v(" "),e("p",[s._v('The following code uses the Python language to fill a Person message and encode it as binary data, then sends it to the "t/1" topic. See '),e("a",{attrs:{href:"https://github.com/terry-xiaoyu/schema-registry-examples/blob/master/protobuf/pb2_mqtt.py",target:"_blank",rel:"noopener noreferrer"}},[s._v("full code"),e("OutboundLink")],1),s._v(" for details.")]),s._v(" "),e("div",{staticClass:"language-python line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-python"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("publish_msg")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("client"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    p "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" person_pb2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Person"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    p"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("id")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    p"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Shawn"')]),s._v("\n    p"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("email "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"liuxy@emqx.io"')]),s._v("\n    message "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" p"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SerializeToString"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    topic "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"t/1"')]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"publish to topic: t/1, payload:"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    client"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("publish"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("topic"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" payload"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("message"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" qos"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" retain"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("h2",{attrs:{id:"checking-rule-execution-results"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#checking-rule-execution-results"}},[s._v("#")]),s._v(" Checking rule execution results")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("In the Dashboard's "),e("a",{attrs:{href:"http://127.0.0.1:18083/#/websocket",target:"_blank",rel:"noopener noreferrer"}},[s._v("Websocket"),e("OutboundLink")],1),s._v(' tools, log in to an MQTT Client and subscribe to "person/#".')])]),s._v(" "),e("li",[e("p",[s._v("Install the python dependency and execute the device-side code:")])])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("$ pip3 "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" protobuf\n$ pip3 "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" paho-mqtt\n\n$ python3 ./pb2_mqtt.py\nConnected with result code "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\npublish to topic: t/1, payload: b"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n\\x05Shawn\\x10\\x01\\x1a\\rliuxy@emqx.io'")]),s._v("\nt/1 b"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n\\x05Shawn\\x10\\x01\\x1a\\rliuxy@emqx.io'")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("Check that a message with the topic "),e("code",[s._v("person/Shawn")]),s._v(" is received on the Websocket side:")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"email"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"liuxy@emqx.io"')]),s._v(","),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),s._v(":1,"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Shawn"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])])}),[],!1,null,null,null);t.default=n.exports}}]);
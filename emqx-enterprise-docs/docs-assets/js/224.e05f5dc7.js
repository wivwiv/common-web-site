(window.webpackJsonp=window.webpackJsonp||[]).push([[224],{1480:function(s,t,a){"use strict";a.r(t);var e=a(10),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"postgresql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#postgresql"}},[s._v("#")]),s._v(" PostgreSQL")]),s._v(" "),a("p",[s._v("PostgreSQL authentication uses an external PostgreSQL database as the authentication data source, which can store a large amount of data and facilitate integration with external device management systems.")]),s._v(" "),a("p",[s._v("Plugin:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("emqx_auth_pgsql\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("The emqx_auth_pgsql also includes ACL feature, which can be disabled via comments")])]),s._v(" "),a("p",[s._v("To enable PostgreSQL authentication, you need to configure the following in "),a("code",[s._v("etc/plugins/emqx_auth_pgsql.conf")])]),s._v(" "),a("h2",{attrs:{id:"postgresql-connection-information"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#postgresql-connection-information"}},[s._v("#")]),s._v(" PostgreSQL connection information")]),s._v(" "),a("p",[s._v("For PostgreSQL basic connection information, it needs to ensure that all nodes in the cluster can access.")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_pgsql.conf")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Server address")]),s._v("\nauth.pgsql.server "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:5432\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Connection pool size")]),s._v("\nauth.pgsql.pool "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n\nauth.pgsql.username "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" root\n\nauth.pgsql.password "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" public\n\nauth.pgsql.database "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mqtt\n\nauth.pgsql.encoding "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" utf8\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## TLS configuration")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.pgsql.ssl = false")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.pgsql.ssl_opts.keyfile =")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## auth.pgsql.ssl_opts.certfile =")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("h2",{attrs:{id:"default-table-structure"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#default-table-structure"}},[s._v("#")]),s._v(" Default table structure")]),s._v(" "),a("p",[s._v("In the default configuration of PostgreSQL authentication, you need to ensure that the following table is in the database:")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" mqtt_user "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SERIAL")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIMARY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  username "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CHARACTER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARYING")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  password "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CHARACTER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARYING")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  salt "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CHARACTER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARYING")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  is_superuser "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BOOLEAN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UNIQUE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("The sample data in the default configuration is as follows:")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" mqtt_user "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" salt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" is_superuser"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'emqx'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'efa1f375d76194fa51a3556a97e641e61685f914d446979da50a551a4333ffd7'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("After PostgreSQL authentication is enabled, you can connect with username: emqx, password: public.")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("This is the table structure used by default configuration. After being familiar with the use of the plugin, you can use any data table that meets the conditions for authentication")])]),s._v(" "),a("h2",{attrs:{id:"salting-rules-and-hash-methods"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#salting-rules-and-hash-methods"}},[s._v("#")]),s._v(" Salting rules and hash methods")]),s._v(" "),a("p",[s._v("PostgreSQL authentication support to configure "),a("RouterLink",{attrs:{to:"/en/enterprise/latest/advanced/auth.html#password-salting-rules-and-hash-methods"}},[s._v("Salting rules and hash methods")]),s._v("：")],1),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_pgsql.conf")]),s._v("\n\nauth.pgsql.password_hash "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sha256\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"auth-query"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#auth-query"}},[s._v("#")]),s._v(" auth_query")]),s._v(" "),a("p",[s._v("During authentication, EMQX Broker will use the current client information to populate and execute the user-configured authentication SQL to query the client's authentication data in the database.")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_pgsql.conf")]),s._v("\n\nauth.pgsql.auth_query "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" password from mqtt_user where username "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%u'")]),s._v(" limit "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("You can use the following placeholders in the SQL authentication, and EMQX Broker will be automatically populated with client information when executed:")]),s._v(" "),a("ul",[a("li",[s._v("%u：Username")]),s._v(" "),a("li",[s._v("%c：Client ID")]),s._v(" "),a("li",[s._v("%C：TLS certificate common name (the domain name or subdomain name of the certificate), valid only for TLS connections")]),s._v(" "),a("li",[s._v("%d：TLS certificate subject, valid only for TLS connections")])]),s._v(" "),a("p",[s._v("You can adjust the authentication SQL according to business to achieve more business-related functions, such as adding multiple query conditions and using database preprocessing functions. However, in any case, the authentication  must meet the following conditions:")]),s._v(" "),a("ol",[a("li",[s._v("The query result must include the password field, which is used by EMQX Broker to compare with the client password")]),s._v(" "),a("li",[s._v("If the salting configuration is enabled, the query result must include the salt field, which is used by EMQX Broker as the salt value")]),s._v(" "),a("li",[s._v("There can only be one query result. When there are multiple results, only the first one is taken as valid data.")])]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("You can use AS syntax in SQL to specify passwords for field renaming, or set the salt value to a fixed value.")])]),s._v(" "),a("h3",{attrs:{id:"advanced"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#advanced"}},[s._v("#")]),s._v(" Advanced")]),s._v(" "),a("p",[s._v("In the default table structure, we set the username field as a unique index (UNIQUE), and use it with the default query statement ("),a("code",[s._v("select password from mqtt_user where username ='%u' limit 1")]),s._v(") to get very good query performance.")]),s._v(" "),a("p",[s._v("If the default query conditions do not meet your needs, for example, you need to query the corresponding "),a("code",[s._v("Password Hash")]),s._v(" and "),a("code",[s._v("Salt")]),s._v(" based on the "),a("code",[s._v("Client ID")]),s._v(", please make sure to set the "),a("code",[s._v("Client ID")]),s._v(" as an index; Or you want to perform multi-condition queries on "),a("code",[s._v("Username")]),s._v(", "),a("code",[s._v("Client ID")]),s._v(", or other fields. It is recommended to set the correct single-column index or multiple-column index. In short, set the correct table structure and query statement, and try not to let the index fail and affect the query performance.")])])}),[],!1,null,null,null);t.default=n.exports}}]);
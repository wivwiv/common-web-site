(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{1625:function(s,t,e){"use strict";e.r(t);var a=e(10),n=Object(a.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"get-subscription-relationship-from-postgresql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#get-subscription-relationship-from-postgresql"}},[s._v("#")]),s._v(" Get subscription relationship from PostgreSQL")]),s._v(" "),a("p",[s._v("Set up the PostgreSQL database, and take MacOS X as an example:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ brew "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" postgresql\n$ brew services start postgresql\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("Create the mqtt database:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# Create a database named 'mqtt' with the username postgres\n$ createdb -U postgres mqtt\n\n$ psql -U postgres mqtt\n\nmqtt=> \\dn;\nList of schemas\nName  | Owner\n--------+-------\npublic | postgres\n(1 row)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("Create the mqtt_sub table:")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("$ psql "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("U postgres mqtt\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" mqtt_sub"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  id SERIAL8 "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("primary")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  clientid "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("character")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varying")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  topic "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("character")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varying")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("255")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  qos "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("integer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UNIQUE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("clientid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" topic"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("The subscription relationship table structure cannot be modified. Please use the above SQL statement to create")])]),s._v(" "),a("p",[s._v("Create rules:")]),s._v(" "),a("p",[s._v("Open "),a("a",{attrs:{href:"http://127.0.0.1:18083/#/rules",target:"_blank",rel:"noopener noreferrer"}},[s._v("EMQX Dashboard"),a("OutboundLink")],1),s._v(' and select the "Rules" tab on the left.')]),s._v(" "),a("p",[s._v("Then fill in the rule SQL:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("SELECT * FROM "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$events")]),s._v('/client_connected"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:e(834),alt:""}})]),s._v(" "),a("p",[s._v("Related actions:")]),s._v(" "),a("p",[s._v('Select "Add Action" on the "Response Action" interface, and then select "Get Subscription List from PostgreSQL" in the "Add Action" drop-down box')]),s._v(" "),a("p",[a("img",{attrs:{src:e(835),alt:""}})]),s._v(" "),a("p",[s._v("Fill in the action parameters:")]),s._v(" "),a("p",[s._v('The action of "Get subscription list from PostgreSQL" requires one parameter:')]),s._v(" "),a("p",[s._v('1). Associated resources. The resource drop-down box is empty now, and you can click "New" in the upper right corner to create a PostgreSQL resource:')]),s._v(" "),a("p",[a("img",{attrs:{src:e(836),alt:""}})]),s._v(" "),a("p",[s._v('The "Create Resource" dialog box pops up')]),s._v(" "),a("p",[a("img",{attrs:{src:e(837),alt:""}})]),s._v(" "),a("p",[s._v("Fill in the resource configuration:")]),s._v(" "),a("p",[s._v('Fill in the real PostgreSQL server address and the values corresponding to other configurations, and then click the "Test Connection" button to ensure that the connection test is successful.')]),s._v(" "),a("p",[s._v('Finally click the "OK" button.')]),s._v(" "),a("p",[a("img",{attrs:{src:e(838),alt:""}})]),s._v(" "),a("p",[s._v('Return to the response action interface and click "OK".')]),s._v(" "),a("p",[a("img",{attrs:{src:e(839),alt:""}})]),s._v(" "),a("p",[s._v('Return to the rule creation interface and click "Create".')]),s._v(" "),a("p",[a("img",{attrs:{src:e(840),alt:""}})]),s._v(" "),a("p",[s._v('The rule has been created, and you can insert a subscription relationship into PostgreSQL through "psql":')]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("insert into mqtt_sub(clientid, topic, qos) values('test', 't1', 1)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:e(841),alt:""}})]),s._v(" "),a("p",[s._v("Log in to the device whose clientid is test via Dashboard:")]),s._v(" "),a("p",[a("img",{attrs:{src:e(842),alt:""}})]),s._v(" "),a("p",[s._v("查看“订阅”列表，可以看到 Broker 从 PostgreSQL 里面获取到订阅关系，并代理设备订阅:")]),s._v(" "),a("p",[s._v('Check the "Subscription" list, and you can see that the Broker obtains the subscription relationship from PostgreSQL and subscribes as the agent device:')]),s._v(" "),a("p",[a("img",{attrs:{src:e(843),alt:""}})])])}),[],!1,null,null,null);t.default=n.exports},834:function(s,t,e){s.exports=e.p+"docs-assets/img/pg_sub_01.d96ce5c5.png"},835:function(s,t,e){s.exports=e.p+"docs-assets/img/pg_sub_02.cb3b0a85.png"},836:function(s,t,e){s.exports=e.p+"docs-assets/img/pg_sub_03.25910d10.png"},837:function(s,t,e){s.exports=e.p+"docs-assets/img/pg_sub_04.75828836.png"},838:function(s,t,e){s.exports=e.p+"docs-assets/img/pg_sub_05.450596e0.png"},839:function(s,t,e){s.exports=e.p+"docs-assets/img/pg_sub_06.79dce4a0.png"},840:function(s,t,e){s.exports=e.p+"docs-assets/img/pg_sub_07.5b1639fd.png"},841:function(s,t,e){s.exports=e.p+"docs-assets/img/pg_sub_08.8ae3af5b.png"},842:function(s,t,e){s.exports=e.p+"docs-assets/img/pg_sub_09.63ff5c5b.png"},843:function(s,t,e){s.exports=e.p+"docs-assets/img/pg_sub_10.1a7e4254.png"}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{1624:function(s,t,n){"use strict";n.r(t);var e=n(10),a=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"get-subscription-relationship-from-mongodb"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#get-subscription-relationship-from-mongodb"}},[s._v("#")]),s._v(" Get subscription relationship from MongoDB")]),s._v(" "),e("p",[s._v("Set up the MongoDB database and set the user name and password to root/public. Take MacOS X as an example:")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ brew "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" mongodb\n$ brew services start mongodb\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Add root/public user")]),s._v("\n$ use mqtt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n$ db.createUser"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("user: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"root"')]),s._v(", pwd: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"public"')]),s._v(", roles: "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("role: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"readWrite"')]),s._v(", db: "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mqtt"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Modify the configuration and disable anonymous authentication")]),s._v("\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /usr/local/etc/mongod.conf\n\n    security:\n    authorization: enabled\n\n$ brew services restart mongodb\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("p",[s._v("Create the mqtt_sub table:")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[s._v("$ mongo "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("mqtt "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("uroot "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("ppublic\ndb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("createCollection"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mqtt_sub"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("Create rules:")]),s._v(" "),e("p",[s._v("Open "),e("a",{attrs:{href:"http://127.0.0.1:18083/#/rules",target:"_blank",rel:"noopener noreferrer"}},[s._v("EMQX Dashboard"),e("OutboundLink")],1),s._v(' and select the "Rules" tab on the left.')]),s._v(" "),e("p",[s._v("Then fill in the rule SQL:")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("SELECT * FROM "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$events")]),s._v('/client_connected"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:n(824),alt:""}})]),s._v(" "),e("p",[s._v("Related actions:")]),s._v(" "),e("p",[s._v('Select "Add Action" on the "Response Action" interface, and then select "Get Subscription List from MongoDB" in the "Add Action" drop-down box')]),s._v(" "),e("p",[e("img",{attrs:{src:n(825),alt:""}})]),s._v(" "),e("p",[s._v("Fill in the action parameters:")]),s._v(" "),e("p",[s._v('The action of "Get subscription list from MongoDB" requires one parameter:')]),s._v(" "),e("p",[s._v('1). Associated resources. The resource drop-down box is empty now, and you can click "New" in the upper right corner to create a MongoDB  resource:')]),s._v(" "),e("p",[e("img",{attrs:{src:n(826),alt:""}})]),s._v(" "),e("p",[s._v('The "Create Resource" dialog box pops up')]),s._v(" "),e("p",[e("img",{attrs:{src:n(827),alt:""}})]),s._v(" "),e("p",[s._v("Fill in the resource configuration:")]),s._v(" "),e("p",[s._v('Fill in the real MongoDB  server address and the values corresponding to other configurations, and then click the "Test Connection" button to ensure that the connection test is successful.')]),s._v(" "),e("p",[s._v('Finally click the "OK" button.')]),s._v(" "),e("p",[e("img",{attrs:{src:n(828),alt:""}})]),s._v(" "),e("p",[s._v('Return to the response action interface and click "OK".')]),s._v(" "),e("p",[e("img",{attrs:{src:n(829),alt:""}})]),s._v(" "),e("p",[s._v('Return to the rule creation interface and click "Create".')]),s._v(" "),e("p",[e("img",{attrs:{src:n(830),alt:""}})]),s._v(" "),e("p",[s._v('The rule has been created, and you can insert a subscription relationship into MongoDB through "mongo":')]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('db.mqtt_sub.insert({clientid: "test", topic: "t1", qos: 1})\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:n(831),alt:""}})]),s._v(" "),e("p",[s._v("Log in to the device whose clientid is test via Dashboard:")]),s._v(" "),e("p",[e("img",{attrs:{src:n(832),alt:""}})]),s._v(" "),e("p",[s._v('Check the "Subscription" list, and you can see that the Broker obtains the subscription relationship from MongoDB and subscribes as the agent device:')]),s._v(" "),e("p",[e("img",{attrs:{src:n(833),alt:""}})])])}),[],!1,null,null,null);t.default=a.exports},824:function(s,t,n){s.exports=n.p+"docs-assets/img/mongo_sub_01.d96ce5c5.png"},825:function(s,t,n){s.exports=n.p+"docs-assets/img/mongo_sub_02.a9d8d09c.png"},826:function(s,t,n){s.exports=n.p+"docs-assets/img/mongo_sub_03.14641a82.png"},827:function(s,t,n){s.exports=n.p+"docs-assets/img/mongo_sub_04.09ab394b.png"},828:function(s,t,n){s.exports=n.p+"docs-assets/img/mongo_sub_05.46136eac.png"},829:function(s,t,n){s.exports=n.p+"docs-assets/img/mongo_sub_06.e53e7846.png"},830:function(s,t,n){s.exports=n.p+"docs-assets/img/mongo_sub_07.4821d64d.png"},831:function(s,t,n){s.exports=n.p+"docs-assets/img/mongo_sub_08.884c9032.png"},832:function(s,t,n){s.exports=n.p+"docs-assets/img/mongo_sub_09.63ff5c5b.png"},833:function(s,t,n){s.exports=n.p+"docs-assets/img/mongo_sub_10.1a7e4254.png"}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[169],{1674:function(s,e,a){"use strict";a.r(e);var t=a(10),r=Object(t.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"消息桥接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#消息桥接"}},[s._v("#")]),s._v(" 消息桥接")]),s._v(" "),t("p",[s._v("EMQX 支持两种桥接方式:")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("RPC 桥接: 使用 Erlang RPC 协议的桥接方式，只能在 EMQX 间使用")])]),s._v(" "),t("li",[t("p",[s._v("MQTT 桥接: 使用 MQTT 协议、作为客户端连接到远程 Broker 的桥接方式，可桥接到其他 MQTT Broker 以及 EMQX Broker")])])]),s._v(" "),t("p",[s._v("其概念如下图所示:")]),s._v(" "),t("p",[t("img",{attrs:{src:a(956),alt:"image"}})]),s._v(" "),t("p",[s._v("发布者可通过桥接将消息发布到远程的 Broker:")]),s._v(" "),t("p",[t("img",{attrs:{src:a(957),alt:"image"}})]),s._v(" "),t("p",[s._v("EMQX 根据不同的 name 来区分不同的 bridge。可在 "),t("code",[s._v("etc/plugins/emqx_bridge_mqtt.conf")]),s._v(" 中添加 Bridge:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.address "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("211.182")]),s._v(".34.1:1883\n\nbridge.mqtt.huawei.address "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54.33")]),s._v(".120.8:1883\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("该项配置声明了两个 bridge，一个名为 "),t("code",[s._v("aws")]),s._v("，另一个名为 "),t("code",[s._v("huawei")]),s._v("，并分别指向响应的服务地址，使用 MQTT 方式桥接。")]),s._v(" "),t("p",[s._v("如果该配置的值是另一个 EMQX 的节点名，则使用 RPC 方式桥接:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.emqx2.address "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" emqx2@57.122.76.34\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("使用桥接功能需要启动 "),t("code",[s._v("emqx_bridge_mqtt")]),s._v(" 插件:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ emqx_ctl plugins load emqx_bridge_mqtt\n\nok\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"rpc-桥接的优缺点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#rpc-桥接的优缺点"}},[s._v("#")]),s._v(" RPC 桥接的优缺点")]),s._v(" "),t("p",[s._v("RPC 桥接的优点在于其不涉及 MQTT 协议编解码，效率高于 MQTT 桥接。")]),s._v(" "),t("p",[s._v("RPC 桥接的缺点:")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("RPC 桥接只能将两个 EMQX 桥接在一起（版本须相同），无法桥接 EMQX 到其他的 MQTT Broker 上")])]),s._v(" "),t("li",[t("p",[s._v("RPC 桥接只能将本地的消息转发到远程桥接节点上，无法将远程桥接节点的消息同步到本地节点上")])])]),s._v(" "),t("h2",{attrs:{id:"rpc-桥接举例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#rpc-桥接举例"}},[s._v("#")]),s._v(" RPC 桥接举例")]),s._v(" "),t("p",[s._v("假设有两个 emqx 节点:")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("名称")]),s._v(" "),t("th",[s._v("节点")]),s._v(" "),t("th",[s._v("MQTT 端口")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("emqx1")]),s._v(" "),t("td",[t("a",{attrs:{href:"mailto:emqx1@192.168.1.1"}},[s._v("emqx1@192.168.1.1")])]),s._v(" "),t("td",[s._v("1883")])]),s._v(" "),t("tr",[t("td",[s._v("emqx2")]),s._v(" "),t("td",[t("a",{attrs:{href:"mailto:emqx2@192.168.1.2"}},[s._v("emqx2@192.168.1.2")])]),s._v(" "),t("td",[s._v("1883")])])])]),s._v(" "),t("p",[s._v("现在我们要将 "),t("code",[s._v("emqx1")]),s._v(" 桥接到 "),t("code",[s._v("emqx2")]),s._v("。首先需要在 "),t("code",[s._v("emqx1")]),s._v(" 的 "),t("code",[s._v("etc/plugins/emqx_bridge_mqtt.conf")]),s._v(" 配置文件里添加 Bridge 配置并指向"),t("code",[s._v("emqx2")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.emqx2.address "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" emqx2@192.168.1.2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("接下来定义 "),t("code",[s._v("forwards")]),s._v(" 规则，这样本节点上发到 "),t("code",[s._v("sensor1/#")]),s._v("、"),t("code",[s._v("sensor2/#")]),s._v(" 上的消息都会被转发到 "),t("code",[s._v("emqx2")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.emqx2.forwards "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sensor1/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#,sensor2/#")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("如果想要在消息转发前给 "),t("code",[s._v("emqx2")]),s._v(" 之前，给主题加上特定前缀，可以设置挂载点:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.emqx2.mountpoint "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" bridge/emqx2/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node}")]),s._v("/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("挂载点利于 "),t("code",[s._v("emqx2")]),s._v(" 区分桥接消息和本地消息。例如，以上配置中，原主题为 "),t("code",[s._v("sensor1/hello")]),s._v(" 的消息，转发到 "),t("code",[s._v("emqx2")]),s._v(" 后主题会变为 "),t("code",[s._v("bridge/emqx2/emqx1@192.168.1.1/sensor1/hello")]),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"mqtt-桥接举例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mqtt-桥接举例"}},[s._v("#")]),s._v(" MQTT 桥接举例")]),s._v(" "),t("p",[s._v("MQTT 桥接是让 EMQX 作为 MQTT 客户端连接到远程的 MQTT Broker。")]),s._v(" "),t("p",[s._v("首先需要配置 MQTT 客户端参数:")]),s._v(" "),t("p",[s._v("远程 Broker 地址:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.address "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("211.182")]),s._v(".34.1:1883\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("MQTT 协议版本，可以为 "),t("code",[s._v("mqttv3")]),s._v("、"),t("code",[s._v("mqttv4")]),s._v(" 或 "),t("code",[s._v("mqttv5")]),s._v(" 其中之一:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.proto_ver "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" mqttv4\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("MQTT 客户端的 clientid:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.clientid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" bridge_emq\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("MQTT 客户端的 username 字段:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.username "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" user\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("MQTT 客户端的 password 字段:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.password "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("passwd")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Keepalive 设置:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.keepalive "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 60s\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("然后是客户端的 clean_start 字段，有些 IoT Hub 要求 clean_start（或 clean_session) 字段必须为 "),t("code",[s._v("true")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.clean_start "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("可设置桥接断线重连间隔:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.reconnect_interval "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 30s\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("如需使用 TLS 连接，可以设置 "),t("code",[s._v("bridge.mqtt.aws.ssl = on")]),s._v(" 并设置 TLS 证书:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.ssl "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" off\nbridge.mqtt.aws.cacertfile "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" etc/certs/cacert.pem\nbridge.mqtt.aws.certfile "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" etc/certs/client-cert.pem\nbridge.mqtt.aws.keyfile "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" etc/certs/client-key.pem\nbridge.mqtt.aws.ciphers "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ECDHE-ECDSA-AES256-GCM-SHA384,ECDHE-RSA-AES256-GCM-SHA384\nbridge.mqtt.aws.tls_versions "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tlsv1.2,tlsv1.1,tlsv1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("接下来定义 "),t("code",[s._v("forwards")]),s._v(" 规则，这样本节点上发到 "),t("code",[s._v("sensor1/#")]),s._v("、"),t("code",[s._v("sensor2/#")]),s._v(" 上的消息都会被转发到远程 Broker:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.forwards "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sensor1/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#,sensor2/#")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("还可指定 QoS1 与 QoS2 消息的重传间隔以及批量发送报文数:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.retry_interval "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 20s\nbridge.mqtt.aws.max_inflight_batches "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("如果想要在消息转发前给 "),t("code",[s._v("aws")]),s._v(" 之前，给主题加上特定前缀，可以设置挂载点，详见 "),t("a",{attrs:{href:"#rpc-bridge-example"}},[s._v("RPC 桥接举例")]),s._v(" 章节:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.mountpoint "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" bridge/aws/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node}")]),s._v("/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v('如果想让本地 Broker "拉取" 远程 Broker 的消息，可以向远程 Broker 订阅某些主题:')]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.subscription.1.topic "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cmd/topic1\nbridge.mqtt.aws.subscription.1.qos "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"emqx-桥接缓存配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#emqx-桥接缓存配置"}},[s._v("#")]),s._v(" EMQX 桥接缓存配置")]),s._v(" "),t("p",[s._v("EMQX 的 Bridge 拥有消息缓存机制，当 Bridge 连接断开时会将 forwards 主题的消息缓存，等到桥接恢复时，再把消息重新转发到远程节点上。缓存机制同时适用于 RPC 桥接和 MQTT 桥接。")]),s._v(" "),t("p",[s._v("设置缓存队列总大小:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.aws.queue.max_total_size "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 5GB\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("将消息缓存到磁盘的某个路径（如不设置，则仅缓存到内存）:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.emqx2.queue.replayq_dir "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" data/emqx_emqx2_bridge/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("设置单个缓存文件的大小，如超过则会创建新的文件来存储消息队列:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("bridge.mqtt.emqx2.queue.replayq_seg_bytes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 10MB\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])}),[],!1,null,null,null);e.default=r.exports},956:function(s,e,a){s.exports=a.p+"docs-assets/img/bridge.7dd285a2.png"},957:function(s,e,a){s.exports=a.p+"docs-assets/img/bridges_3.51f9d637.png"}}]);
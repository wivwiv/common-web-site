(window.webpackJsonp=window.webpackJsonp||[]).push([[159],{1482:function(t,e,a){"use strict";a.r(e);var n=a(10),s=Object(n.a)({},(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"introduction"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[t._v("#")]),t._v(" Introduction")]),t._v(" "),n("p",[t._v("Authentication is an important part of most applications. Enabling authentication can effectively prevent illegal client connections.")]),t._v(" "),n("p",[t._v("Authentication in EMQX Broker means that when a client connects to EMQX Broker, the server configuration is used to control the client's permission to connect to the server.")]),t._v(" "),n("p",[t._v("EMQX Broker's authentication support includes two levels:")]),t._v(" "),n("ul",[n("li",[t._v("The MQTT specifies allows the username/password to be included in the CONNECT packet. EMQX Broker supports multiple forms of authentication based on Username, ClientID, HTTP, JWT, LDAP, and various databases such as MongoDB, MySQL, PostgreSQL, Redis through plugins.")]),t._v(" "),n("li",[t._v("At the transport layer, TLS guarantees client-to-server authentication using client certificates and ensures that the server verifies the server certificate to the client(X.509 authentication). PSK-based TLS/DTLS authentication is also supported.")])]),t._v(" "),n("p",[t._v("This authentication methods supported by EMQX and the configuration methods of the corresponding plugins are introduced in this article.")]),t._v(" "),n("h2",{attrs:{id:"authentication-method"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#authentication-method"}},[t._v("#")]),t._v(" Authentication method")]),t._v(" "),n("p",[t._v("EMQX supports the use of built-in data sources (files, built-in databases), JWT, external mainstream databases, and custom HTTP APIs as authentication data sources.")]),t._v(" "),n("p",[t._v("The data source connection and authentication logic are implemented through plugins. Each plugin corresponds to an authentication method, and the corresponding plugin needs to be enabled before use.")]),t._v(" "),n("p",[t._v("When the client connects, the plugin implements the identity authentication of the client by checking whether its username/clientid and password are consistent with the information of the specified data source.")]),t._v(" "),n("p",[t._v("Authentication methods supported by EMQX:")]),t._v(" "),n("p",[n("strong",[t._v("Built-in data source")])]),t._v(" "),n("ul",[n("li",[n("RouterLink",{attrs:{to:"/en/enterprise/latest/modules/mnesia_authentication.html"}},[t._v("Built-in Auth")])],1)]),t._v(" "),n("p",[t._v("The configuration file and the built-in database of EMQX are used to provide an authenticated data source, which is managed through the HTTP API and is simple and lightweight.")]),t._v(" "),n("p",[n("strong",[t._v("External Database")])]),t._v(" "),n("ul",[n("li",[n("RouterLink",{attrs:{to:"/en/enterprise/latest/modules/mysql_authentication.html"}},[t._v("MySQL authentication")])],1),t._v(" "),n("li",[n("RouterLink",{attrs:{to:"/en/enterprise/latest/modules/pgsql_authentication.html"}},[t._v("PostgreSQL authentication")])],1),t._v(" "),n("li",[n("RouterLink",{attrs:{to:"/en/enterprise/latest/modules/redis_authentication.html"}},[t._v("Redis authentication")])],1),t._v(" "),n("li",[n("RouterLink",{attrs:{to:"/en/enterprise/latest/modules/mongo_authentication.html"}},[t._v("MongoDB authentication")])],1),t._v(" "),n("li",[n("RouterLink",{attrs:{to:"/en/enterprise/latest/modules/ldap_authentication.html"}},[t._v("LDAP authentication")])],1)]),t._v(" "),n("p",[t._v("The external database can store a large amount of data, while facilitating integration with external device management systems.")]),t._v(" "),n("p",[t._v("Others")]),t._v(" "),n("ul",[n("li",[n("RouterLink",{attrs:{to:"/en/enterprise/latest/modules/http_authentication.html"}},[t._v("HTTP authentication")])],1),t._v(" "),n("li",[n("RouterLink",{attrs:{to:"/en/enterprise/latest/modules/jwt_authentication.html"}},[t._v("JWT authentication")])],1)]),t._v(" "),n("p",[t._v("JWT authentication can issue authentication information in batches, and HTTP authentication can implement complex authentication logic.")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),n("p",[t._v("After changing the plugin configuration, you need to restart the plugin to take effect. Some authentication plugins include "),n("RouterLink",{attrs:{to:"/en/enterprise/latest/advanced/acl.html"}},[t._v("ACL function")]),t._v(".")],1)]),t._v(" "),n("h2",{attrs:{id:"authentication-results"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#authentication-results"}},[t._v("#")]),t._v(" Authentication results")]),t._v(" "),n("p",[t._v("Any authentication method will eventually return a result:")]),t._v(" "),n("ul",[n("li",[t._v("Authentication succeeded: the client authentication succeeded after comparison")]),t._v(" "),n("li",[t._v("Authentication failed: the client authentication fails after comparison, which is because the password in the data source does not match the current password")]),t._v(" "),n("li",[t._v("Ignore: The authentication data is not found with the current authentication method, and the result cannot be determined explicitly. The next method of authentication chain or anonymous authentication is used to determine the result.")])]),t._v(" "),n("h2",{attrs:{id:"anonymous-authentication"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#anonymous-authentication"}},[t._v("#")]),t._v(" Anonymous Authentication")]),t._v(" "),n("p",[t._v("Anonymous authentication is enabled in the EMQX default configuration and any client can access EMQX. When the authentication plug-in is not enabled or the authentication plug-in does not explicitly allow/deny(ignore) the connection request, EMQX will decide whether to allow the client to connect based on whether the anonymous authentication is enabled.")]),t._v(" "),n("p",[t._v("Configure the anonymous authentication:")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# etc/emqx.conf")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## Value: true | false")]),t._v("\nallow_anonymous "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br")])]),n("div",{staticClass:"custom-block danger"},[n("p",{staticClass:"custom-block-title"},[t._v("DANGER")]),t._v(" "),n("p",[t._v("Disable anonymous authentication in production environments.")])]),t._v(" "),n("h2",{attrs:{id:"password-salting-and-hash-methods"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#password-salting-and-hash-methods"}},[t._v("#")]),t._v(" Password salting and hash methods")]),t._v(" "),n("p",[t._v("The hash method can be enabled in most EMQX authentication plugins. Only the password cipher text is saved in the data source to ensure data security.")]),t._v(" "),n("p",[t._v("When the hash method is enabled, the user can specify a salt for each client and configure a salting rule. The password stored in the database is the cipher text processed according to the salting rule and hash method.")]),t._v(" "),n("p",[t._v("Taking MySQL authentication as an exampleï¼š")]),t._v(" "),n("p",[n("strong",[t._v("Salting rules and hash method configuration:")])]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# etc/plugins/emqx_auth_mysql.conf")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## only hash is used without salt")]),t._v("\nauth.mysql.password_hash "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sha256\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## salt prefix: use sha256 to encrypt salt + password")]),t._v("\nauth.mysql.password_hash "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" salt,sha256\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## salt suffix: encrypted password using sha256 + salt")]),t._v("\nauth.mysql.password_hash "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" sha256,salt\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## pbkdf2 with macfun iterations dklen")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## macfun: md4, md5, ripemd160, sha, sha224, sha256, sha384, sha512")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("## auth.mysql.password_hash = pbkdf2,sha256,1000,20")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br")])]),t._v(" "),n("h3",{attrs:{id:"how-to-generate-authentication-information"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#how-to-generate-authentication-information"}},[t._v("#")]),t._v(" How to generate authentication information")]),t._v(" "),n("ol",[n("li",[t._v("Assign user name, Client ID, password, and salt for each client")]),t._v(" "),n("li",[t._v("Use the same salting rules and hash method as MySQL authentication to process client information to get cipher text")]),t._v(" "),n("li",[t._v("Write the client information to the database. The client password should be cipher text information.")])]),t._v(" "),n("h3",{attrs:{id:"emqx-authentication-process"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#emqx-authentication-process"}},[t._v("#")]),t._v(" EMQX authentication process")]),t._v(" "),n("ol",[n("li",[t._v("The authentication data such as password (ciphertext) and salt are queried according to the configured authentication SQL combined with the information passed in by the client. If there is no query result, the authentication will terminate and the ignore result will be returned")]),t._v(" "),n("li",[t._v("The cipher text is calculated according to the configured salting rule and hash method. If no hash method is enabled,  this step is skipped.")]),t._v(" "),n("li",[t._v("Compare the cipher text stored in the database with the cipher text calculated by the current client. If the comparison is successful, the authentication succeeds. Otherwise, the authentication fails.")])]),t._v(" "),n("p",[t._v("MySQL authentication function logic diagram:")]),t._v(" "),n("p",[n("img",{attrs:{src:a(491),alt:"image-20200217154254202"}})]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),n("p",[t._v("The authentication can be performed normally when the salting rules and hash method of the written data are consistent with the configuration of the corresponding plugin. It will invalidate existing authentication data when changing the hashing method.")])]),t._v(" "),n("h2",{attrs:{id:"authentication-chain"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#authentication-chain"}},[t._v("#")]),t._v(" Authentication chain")]),t._v(" "),n("p",[t._v("When multiple authentication methods are enabled at the same time, EMQX will perform chain authentication in the order in which the plugins are opened:")]),t._v(" "),n("ul",[n("li",[t._v("Once authentication succeeds, terminate the authentication chain and allow clients to access")]),t._v(" "),n("li",[t._v("Once authentication fails, terminate the authentication chain and prohibit client access")]),t._v(" "),n("li",[t._v("If Failing to pass until the last authentication method,  it is determined according to  "),n("strong",[t._v("anonymous authentication")]),t._v(" configuration\n"),n("ul",[n("li",[t._v("Allow client access when anonymous authentication is enabled")]),t._v(" "),n("li",[t._v("Deny client access when anonymous authentication is disabled")])])])]),t._v(" "),n("p",[n("img",{attrs:{src:a(492),alt:"_images/guide_2.png"}})]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),n("p",[t._v("It can improve client authentication efficiency when enabling only one authentication plugin at the same time")])]),t._v(" "),n("h2",{attrs:{id:"tls-authentication"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tls-authentication"}},[t._v("#")]),t._v(" TLS authentication")]),t._v(" "),n("p",[t._v("The default port for MQTT TLS is 8883:")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("listener.ssl.external "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8883")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("Configure certificates and CAs:")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("listener.ssl.external.keyfile "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" etc/certs/key.pem\nlistener.ssl.external.certfile "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" etc/certs/cert.pem\nlistener.ssl.external.cacertfile "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" etc/certs/cacert.pem\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("Note that the "),n("code",[t._v("key.pem")]),t._v(","),n("code",[t._v("cert.pem")]),t._v(" and "),n("code",[t._v("cacert.pem")]),t._v(" under the default directory of "),n("code",[t._v("etc/certs")]),t._v(" are self-signed certificates generated by EMQX Broker. Therefore, when testing with a client that supports TLS, you need to configure the above CA certificate "),n("code",[t._v("etc/certs/cacert.pem")]),t._v(" to the client.")]),t._v(" "),n("p",[t._v("The cipher list supported by the server needs to be specified explicitly. The default list is consistent with Mozilla's server cipher list:")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("listener.ssl.external.ciphers "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ECDHE-ECDSA-AES256-GCM-SHA384,ECDHE-RSA-AES256-GCM-SHA384,ECDHE-ECDSA-AES256-SHA384,ECDHE-RSA-AES256-SHA384,ECDHE-ECDSA-DES-CBC3-SHA,ECDH-ECDSA-AES256-GCM-SHA384,ECDH-RSA-AES256-GCM-SHA384,ECDH-ECDSA-AES256-SHA384,ECDH-RSA-AES256-SHA384,DHE-DSS-AES256-GCM-SHA384,DHE-DSS-AES256-SHA256,AES256-GCM-SHA384,AES256-SHA256,ECDHE-ECDSA-AES128-GCM-SHA256,ECDHE-RSA-AES128-GCM-SHA256,ECDHE-ECDSA-AES128-SHA256,ECDHE-RSA-AES128-SHA256,ECDH-ECDSA-AES128-GCM-SHA256,ECDH-RSA-AES128-GCM-SHA256,ECDH-ECDSA-AES128-SHA256,ECDH-RSA-AES128-SHA256,DHE-DSS-AES128-GCM-SHA256,DHE-DSS-AES128-SHA256,AES128-GCM-SHA256,AES128-SHA256,ECDHE-ECDSA-AES256-SHA,ECDHE-RSA-AES256-SHA,DHE-DSS-AES256-SHA,ECDH-ECDSA-AES256-SHA,ECDH-RSA-AES256-SHA,AES256-SHA,ECDHE-ECDSA-AES128-SHA,ECDHE-RSA-AES128-SHA,DHE-DSS-AES128-SHA,ECDH-ECDSA-AES128-SHA,ECDH-RSA-AES128-SHA,AES128-SHA\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("h2",{attrs:{id:"psk-authentication"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#psk-authentication"}},[t._v("#")]),t._v(" PSK authentication")]),t._v(" "),n("p",[t._v("If you want to use PSK authentication, you need to comment out "),n("code",[t._v("listener.ssl.external.ciphers")]),t._v(" in "),n("a",{attrs:{href:"#auth-tls"}},[t._v("TLS Authentication")]),t._v(", and then configure "),n("code",[t._v("listener.ssl.external.psk_ciphers")]),t._v(":")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#listener.ssl.external.ciphers = ECDHE-ECDSA-AES256-GCM-SHA384,...")]),t._v("\nlistener.ssl.external.psk_ciphers "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" PSK-AES128-CBC-SHA,PSK-AES256-CBC-SHA,PSK-3DES-EDE-CBC-SHA,PSK-RC4-SHA\n\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br")])]),n("p",[t._v("Then enable the emqx_psk_file plugin:")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ emqx_ctl plugins load emqx_psk_file\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br")])]),n("p",[t._v("The configuration file for PSK is "),n("code",[t._v("etc/psk.txt")]),t._v(". A colon "),n("code",[t._v(":")]),t._v(" is used to separate the PSK ID and PSK:")]),t._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("client1:1234\nclient2:abcd\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br")])])])}),[],!1,null,null,null);e.default=s.exports},491:function(t,e,a){t.exports=a.p+"docs-assets/img/image-20200217154254202.73f93538.png"},492:function(t,e,a){t.exports=a.p+"docs-assets/img/guide_2.708b25fd.png"}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[216],{1471:function(e,s,t){"use strict";t.r(s);var a=t(10),n=Object(a.a)({},(function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"redis-acl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis-acl"}},[e._v("#")]),e._v(" Redis ACL")]),e._v(" "),t("p",[e._v("An external Redis database is used to store ACL rules for Redis ACL, which can store a large amount of data and dynamically manage ACLs for easy integration with external device management systems.")]),e._v(" "),t("p",[e._v("Plugin:")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("emqx_auth_redis\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),t("p",[e._v("The emqx_auth_mysql plugin also includes authentication feature, which can be disabled via comments.")])]),e._v(" "),t("h2",{attrs:{id:"redis-connection-information"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis-connection-information"}},[e._v("#")]),e._v(" Redis connection information")]),e._v(" "),t("p",[e._v("Redis basic connection information needs to be accessible to all nodes in the cluster.")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# etc/plugins/emqx_auth_redis.conf")]),e._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Server address")]),e._v("\nauth.redis.server "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("127.0")]),e._v(".0.1:6379\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Connection pool size")]),e._v("\nauth.redis.pool "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("8")]),e._v("\n\nauth.redis.database "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("\n\nauth.redis.password "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" \n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br")])]),t("h2",{attrs:{id:"default-data-structure"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#default-data-structure"}},[e._v("#")]),e._v(" Default data structure")]),e._v(" "),t("p",[e._v("Under the default configuration of the Redis  authentication plugin, a hash table is used to store authentication data, and "),t("code",[e._v("mqtt_user:")]),e._v(" is used as the Redis key prefix. The data structure is as follows:")]),e._v(" "),t("h3",{attrs:{id:"authentication-superuser"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#authentication-superuser"}},[e._v("#")]),e._v(" Authentication / Superuser")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("redis"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" hgetall mqtt_user:emqx\n  password public\n  salt wivwiv\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br")])]),t("p",[e._v("Under the default configuration, Sample data is as follows:")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("HMSET mqtt_user:emqx password public salt wivwiv\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("h3",{attrs:{id:"acl-rule-table"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#acl-rule-table"}},[e._v("#")]),e._v(" ACL rule table")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Format")]),e._v("\nHSET mqtt_acl:"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("username clientid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("topic"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("access"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("## Structure")]),e._v("\nredis"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" hgetall mqtt_acl:emqx\n  testtopic/1 "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br")])]),t("p",[e._v("A rule of Redis ACL defines publish, subscribe, or publish/subscribe information. All lists in the rule are "),t("strong",[e._v("allow")]),e._v(" lists.")]),e._v(" "),t("p",[e._v("Rule field description:")]),e._v(" "),t("ul",[t("li",[e._v("ipaddr: Set IP address")]),e._v(" "),t("li",[e._v("username: User name for connecting to the client. If the value is set to "),t("code",[e._v("$ all")]),e._v(", the rule applies to all users.")]),e._v(" "),t("li",[e._v("clientid: Client ID of the connected client")]),e._v(" "),t("li",[e._v("access: Allowed operations: subscribe (1), publish (2), both subscribe and publish (3)")]),e._v(" "),t("li",[e._v("topic: Topics to be controlled, which can use wildcards, and placeholders can be added to the topic to match client information. For example, the topic will be replaced with the client ID of the current client when matching "),t("code",[e._v("t/%c")]),e._v(" "),t("ul",[t("li",[e._v("%u：Username")]),e._v(" "),t("li",[e._v("%c：Client ID")])])])]),e._v(" "),t("p",[e._v("Under the default configuration, Sample data is as follows:")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("HSET mqtt_acl:emqx "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 1")]),e._v("\nHSET mqtt_acl:testtopic/2 "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("2")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br")])]),t("p",[e._v("After enabling Redis ACL and successfully connecting with the username emqx, the client should have permissions on the topics it wants to subscribe/publish.")]),e._v(" "),t("h2",{attrs:{id:"super-user-query-command-super-cmd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#super-user-query-command-super-cmd"}},[e._v("#")]),e._v(" Super user query command（super cmd）")]),e._v(" "),t("p",[e._v("When performing ACL authentication, EMQX Broker will use the current client information to execute the user-configured superuser query command to query whether the client is a superuser. ACL query command is skipped when the client is superuser.")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# etc/plugins/emqx_auth_redis.conf")]),e._v("\n\nauth.redis.super_cmd "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" HGET mqtt_user:%u is_superuser\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br")])]),t("p",[e._v("You can use the following placeholders in query command and EMQX Broker will automatically populate with client information when executed:")]),e._v(" "),t("ul",[t("li",[e._v("%u：Username")]),e._v(" "),t("li",[e._v("%c：Client ID")]),e._v(" "),t("li",[e._v("%C：TLS certificate common name (the domain name or subdomain name of the certificate), valid only for TLS connections")]),e._v(" "),t("li",[e._v("%d：TLS certificate subject, valid only for TLS connections")])]),e._v(" "),t("p",[e._v("You can adjust the super user query command according to business to achieve more business-related functions, such as adding multiple query conditions and using database preprocessing functions. However, in any case, the superuser query command needs to meet the following conditions:")]),e._v(" "),t("ol",[t("li",[e._v("The first data in the query results must be the is_superuser data")])]),e._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),t("p",[e._v("If superuser functionality is not needed, it can be more efficient when commenting and disabling this option .")])]),e._v(" "),t("h2",{attrs:{id:"acl-query-command-acl-cmd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#acl-query-command-acl-cmd"}},[e._v("#")]),e._v(" ACL query command（acl cmd）")]),e._v(" "),t("p",[e._v("When performing ACL authentication, EMQX Broker will use the current client information to populate and execute the user-configured superuser SQL. If superuser SQL is not enabled or the client is not a superuser, ACL SQL is used to query the client's ACL rules in the database.")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# etc/plugins/emqx_auth_redis.conf")]),e._v("\n\nauth.redis.acl_cmd "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" HGETALL mqtt_acl:%u\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br")])]),t("p",[e._v("You can use the following placeholders in ACL SQL and EMQX Broker will automatically populate with client information when executed:")]),e._v(" "),t("ul",[t("li",[e._v("%u：Username")]),e._v(" "),t("li",[e._v("%c：Client ID")])]),e._v(" "),t("p",[e._v("You can adjust the ACL query command according to business requirement. However, in any case, the ACL query command  needs to meet the following conditions:")]),e._v(" "),t("ol",[t("li",[e._v("Topic is used as key and access is used as value in hash")])]),e._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),t("p",[e._v("The above data structures need to be used strictly for Redis ACL rules.")]),e._v(" "),t("p",[e._v("ACL rules from redis are all "),t("strong",[e._v("allow")]),e._v(" rules. i.e. a whitelist.")]),e._v(" "),t("p",[e._v("When a client's rules list is empty, EMQX continues to check the next auth/ACL plugin.\nOtherwise the check returns immediately without proceeding to the next auth/ACL plugins.")]),e._v(" "),t("p",[e._v("When the rule is non-empty and does not match the corresponding pub/sub permission,\nan authentication failure will be returned (the corresponding pub/sub behavior will be denied) and the authentication chain will be terminated.")]),e._v(" "),t("p",[e._v("When more than one auth/ACL plugins are in use, it is recommended to position Redis ACL after other auth/ACL plugins in the enabled plugins list.")])])])}),[],!1,null,null,null);s.default=n.exports}}]);
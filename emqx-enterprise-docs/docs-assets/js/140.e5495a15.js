(window.webpackJsonp=window.webpackJsonp||[]).push([[140],{1486:function(e,t,s){"use strict";s.r(t);var a=s(10),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cluster"}},[e._v("#")]),e._v(" Cluster")]),e._v(" "),a("h2",{attrs:{id:"distributed-erlang"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#distributed-erlang"}},[e._v("#")]),e._v(" Distributed Erlang")]),e._v(" "),a("p",[e._v("Erlang / OTP was originally a programming language platform designed by Ericsson for the development of telecommunication equipment systems. Telecommunication equipment (routers, access gateways) is typically a distributed system that connects the main control board and multiple business boards through the backplane.")]),e._v(" "),a("h3",{attrs:{id:"nodes-and-distributed-erlang"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nodes-and-distributed-erlang"}},[e._v("#")]),e._v(" Nodes and distributed Erlang")]),e._v(" "),a("p",[e._v("The distributed programs of the Erlang / OTP language platform are composed of distributed interconnected Erlang runtime systems. Each Erlang runtime system is called a node. Nodes are interconnected by TCP to form a network structure.")]),e._v(" "),a("p",[e._v("Erlang nodes are identified by a unique node name, which consists of two parts separated by "),a("code",[e._v("@")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("name"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("@"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("ip-address"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("Communication between nodes is addressed by node name. For example, start four shell terminals locally, and then use the "),a("code",[e._v("-name")]),e._v(" parameter to start four Erlang nodes respectively:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("erl -name node1@127.0.0.1 -setcookie my_nodes\nerl -name node2@127.0.0.1 -setcookie my_nodes\nerl -name node3@127.0.0.1 -setcookie my_nodes\nerl -name node4@127.0.0.1 -setcookie my_nodes\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[a("code",[e._v("node ().")]),e._v(" can be used to view the name of this node, and "),a("code",[e._v("nodes ().")]),e._v(" can be used to view other nodes that have established a connection with the current node. We now go to the console of 'node1@127.0.0.1' and check the current node name and connected nodes:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("node1@127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[e._v("4")]),e._v(">")]),e._v(" node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(".\n"),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'node1@127.0.0.1'")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("node1@127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[e._v("4")]),e._v(">")]),e._v(" nodes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br")])]),a("p",[e._v("Then we let node1 initiate connections with other nodes:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("node1@127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[e._v("1")]),e._v(">")]),e._v(" net_kernel:connect_node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'node2@127.0.0.1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(".\n"),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("node1@127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[e._v("2")]),e._v(">")]),e._v(" net_kernel:connect_node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'node3@127.0.0.1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(".\n"),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("node1@127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[e._v("3")]),e._v(">")]),e._v(" net_kernel:connect_node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'node4@127.0.0.1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(".\n"),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br")])]),a("p",[e._v("Now we can check other nodes that are already connected to node1:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("node1@127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[e._v("4")]),e._v(">")]),e._v(" nodes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'node2@127.0.0.1'")]),e._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'node3@127.0.0.1'")]),e._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'node4@127.0.0.1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("p",[e._v("We can see that node2, node3, and node4 have established a distributed connection with node1, and these four nodes form a cluster. Note that whenever a new node joins the cluster, it will establish a TCP connection with all the nodes in the cluster. At this point, the four nodes have completed the mesh structure shown in the following figure:")]),e._v(" "),a("p",[a("img",{attrs:{src:s(498),alt:"image"}})]),e._v(" "),a("h3",{attrs:{id:"security"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#security"}},[e._v("#")]),e._v(" Security")]),e._v(" "),a("p",[e._v("Cookies are used for interconnection authentication between Erlang nodes. A cookie is a string, and only two nodes with the same cookie can establish a connection. In the "),a("a",{attrs:{href:"#node-and-distributed-erlang"}},[e._v("Previous section")]),e._v(", We used the "),a("code",[e._v("-setcookie my_nodes")]),e._v(" parameter to set the same cookie of "),a("code",[e._v("my_nodes")]),e._v(" to four nodes.")]),e._v(" "),a("p",[e._v("See "),a("a",{attrs:{href:"http://erlang.org/doc/reference_manual/distributed.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://erlang.org/doc/reference_manual/distributed.html"),a("OutboundLink")],1),e._v(" for details.")]),e._v(" "),a("h3",{attrs:{id:"emqx-broker-cluster-protocol-settings"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#emqx-broker-cluster-protocol-settings"}},[e._v("#")]),e._v(" EMQX Broker Cluster protocol settings")]),e._v(" "),a("p",[e._v("Each node in the Erlang cluster can be connected through TCPv4, TCPv6 or TLS, and the connection method can be configured in"),a("code",[e._v("etc/emqx.conf")]),e._v(":")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Configuration name")]),e._v(" "),a("th",[e._v("Type")]),e._v(" "),a("th",[e._v("Default value")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("cluster.proto_dist")]),e._v(" "),a("td",[e._v("enum")]),e._v(" "),a("td",[a("code",[e._v("inet_tcp")])]),e._v(" "),a("td",[e._v("Distributed protocol with optional values are as follows:"),a("br"),e._v("  - inet_tcp: use TCP IPv4"),a("br"),e._v("  - inet6_tcp: use TCP IPv6"),a("br"),e._v("  - inet_tls: use TLS")])]),e._v(" "),a("tr",[a("td",[e._v("node.ssl_dist_optfile")]),e._v(" "),a("td",[e._v("file path")]),e._v(" "),a("td",[a("code",[e._v("etc/ssl_dist.conf")])]),e._v(" "),a("td",[e._v("When "),a("code",[e._v("cluster.proto_dist")]),e._v(" is selected as inet_tls, you need to configure the "),a("code",[e._v("etc/ssl_dist.conf")]),e._v(" file, and specify the TLS certificate.")])])])]),e._v(" "),a("h2",{attrs:{id:"emqx-broker-distributed-cluster-design"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#emqx-broker-distributed-cluster-design"}},[e._v("#")]),e._v(" EMQX Broker Distributed cluster design")]),e._v(" "),a("p",[e._v("The basic function of EMQX Broker distribution is to forward and publish messages to subscribers on each node, as shown in the following figure:")]),e._v(" "),a("p",[a("img",{attrs:{src:s(399),alt:"image"}})]),e._v(" "),a("p",[e._v("To achieve this, EMQX Broker maintains several data structures related to it: subscription tables, routing tables, and topic trees.")]),e._v(" "),a("h3",{attrs:{id:"subscription-table-topics-subscribers"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#subscription-table-topics-subscribers"}},[e._v("#")]),e._v(" Subscription Table: Topics-Subscribers")]),e._v(" "),a("p",[e._v("When an MQTT client subscribes to a topic, EMQX Broker maintains a "),a("strong",[e._v("Subscription Table")]),e._v(" for the Topic-> Subscriber mapping. The subscription table only exists on the EMQX Broker node where the subscriber is located, for example:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("node1:\n\n    topic1 -"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" client1, client2\n    topic2 -"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" client3\n\nnode2:\n\n    topic1 -"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" client4\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br"),a("span",{staticClass:"line-number"},[e._v("8")]),a("br")])]),a("h3",{attrs:{id:"route-table-topic-node"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#route-table-topic-node"}},[e._v("#")]),e._v(" Route Table: Topic-Node")]),e._v(" "),a("p",[e._v("All nodes in the same cluster will "),a("strong",[e._v("copy")]),e._v(" a topic-to-> node mapping table, for example:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("topic1 -"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" node1, node2\ntopic2 -"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" node3\ntopic3 -"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" node2, node4\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("h3",{attrs:{id:"topic-tree-topic-matching-with-wildcards"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#topic-tree-topic-matching-with-wildcards"}},[e._v("#")]),e._v(" Topic tree: topic matching with wildcards")]),e._v(" "),a("p",[e._v("In addition to the routing table, each node in the EMQX Broker cluster also maintains a backup of the "),a("strong",[e._v("Topic Trie.")])]),e._v(" "),a("p",[e._v("The following topic-subscription relationship is an example:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Client")]),e._v(" "),a("th",[e._v("Node")]),e._v(" "),a("th",[e._v("Subscribed topic")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("client1")]),e._v(" "),a("td",[e._v("node1")]),e._v(" "),a("td",[e._v("t/+/x, t/+/y")])]),e._v(" "),a("tr",[a("td",[e._v("client2")]),e._v(" "),a("td",[e._v("node2")]),e._v(" "),a("td",[e._v("t/#")])]),e._v(" "),a("tr",[a("td",[e._v("client3")]),e._v(" "),a("td",[e._v("node3")]),e._v(" "),a("td",[e._v("t/+/x, t/a")])])])]),e._v(" "),a("p",[e._v("When all subscriptions are completed, EMQX Broker maintains the following Topic Trie and Route Table:")]),e._v(" "),a("p",[a("img",{attrs:{src:s(499),alt:"image"}})]),e._v(" "),a("h3",{attrs:{id:"message-distribution-process"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#message-distribution-process"}},[e._v("#")]),e._v(" Message Distribution Process")]),e._v(" "),a("p",[e._v("When an MQTT client publishes a message, the node where it is located retrieves the route table and forwards the message to the relevant node according to the message topic, and then the relevant node retrieves the local subscription table and sends the message to the relevant subscriber.")]),e._v(" "),a("p",[e._v("For example, when client1 publishes a message to the topic "),a("code",[e._v("t/a")]),e._v(". The routing and distribution of the message between nodes are as follows:")]),e._v(" "),a("ol",[a("li",[e._v("client1 publishes a message with the topic "),a("code",[e._v("t/a")]),e._v(" to the node1")]),e._v(" "),a("li",[e._v("By querying the topic tree, node1 learns that "),a("code",[e._v("t/a")]),e._v(" can match the two existing topics of "),a("code",[e._v("t/a")]),e._v(" and "),a("code",[e._v("t/#")]),e._v(".")]),e._v(" "),a("li",[e._v("By querying the route table, node1 learns that topic "),a("code",[e._v("t/a")]),e._v(" has subscribers only on node3, and topic"),a("code",[e._v("t/#")]),e._v("has subscribers only on node2. So node1 forwards the message to node2 and node3.")]),e._v(" "),a("li",[e._v("After node2 receives the forwarded  "),a("code",[e._v("t/a")]),e._v(" message, it queries the local subscription table to obtain the subscribers who have subscribed to "),a("code",[e._v("t/#")]),e._v(" on this node and distributes the message to them.")]),e._v(" "),a("li",[e._v("After node3 receives the forwarded  "),a("code",[e._v("t/a")]),e._v(" message, it queries the local subscription table to obtain the subscribers who have subscribed to "),a("code",[e._v("t/a")]),e._v(" on this node and distributes the message to them.")]),e._v(" "),a("li",[e._v("Message forwarding and distribution are finished.")])]),e._v(" "),a("h3",{attrs:{id:"data-partition-and-sharing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#data-partition-and-sharing"}},[e._v("#")]),e._v(" Data partition and sharing")]),e._v(" "),a("p",[e._v("EMQX Broker's subscription table is partitioned in the cluster, while the topic tree and routing table are replicated.")]),e._v(" "),a("h2",{attrs:{id:"node-discovery-and-automatic-clustering"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-discovery-and-automatic-clustering"}},[e._v("#")]),e._v(" Node discovery and automatic clustering")]),e._v(" "),a("p",[e._v("EMQX Broker supports Autocluster based on Ekka library. Ekka is a cluster management library developed for Erlang / OTP applications. It supports Service Discovery, Autocluster, Network Partition Autoheal, and Autoclean of  Erlang node.")]),e._v(" "),a("p",[e._v("EMQX supports multiple node discovery strategies:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("strategy")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("manual")]),e._v(" "),a("td",[e._v("Creating a cluster manually")])]),e._v(" "),a("tr",[a("td",[e._v("static")]),e._v(" "),a("td",[e._v("Autocluster of static node lists")])]),e._v(" "),a("tr",[a("td",[e._v("mcast")]),e._v(" "),a("td",[e._v("Autocluster of UDP multicast mode")])]),e._v(" "),a("tr",[a("td",[e._v("dns")]),e._v(" "),a("td",[e._v("Autocluster DNS A record")])]),e._v(" "),a("tr",[a("td",[e._v("etcd")]),e._v(" "),a("td",[e._v("Autocluster by etcd")])]),e._v(" "),a("tr",[a("td",[e._v("k8s")]),e._v(" "),a("td",[e._v("Autocluster of Kubernetes service")])])])]),e._v(" "),a("h3",{attrs:{id:"creating-a-cluster-manually"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#creating-a-cluster-manually"}},[e._v("#")]),e._v(" Creating a cluster manually")]),e._v(" "),a("p",[e._v("The default configuration is to manually create a cluster. Nodes should be added via the command of ./bin/emqx_ctl join \\ <Node >:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("cluster.discovery "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" manual\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h3",{attrs:{id:"autocluster-based-on-static-node-list"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#autocluster-based-on-static-node-list"}},[e._v("#")]),e._v(" Autocluster based on static node list")]),e._v(" "),a("p",[e._v("Configure a fixed node list to automatically discover and create clusters:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("cluster.discovery "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" static\ncluster.static.seeds "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" emqx1@127.0.0.1,emqx2@127.0.0.1\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br")])]),a("h3",{attrs:{id:"autocluster-based-on-mcast"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#autocluster-based-on-mcast"}},[e._v("#")]),e._v(" Autocluster based on mcast")]),e._v(" "),a("p",[e._v("Automatically discover and create clusters based on UDP multicast:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("cluster.discovery "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" mcast\ncluster.mcast.addr "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("239.192")]),e._v(".0.1\ncluster.mcast.ports "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("4369,4370")]),e._v("\ncluster.mcast.iface "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("0.0")]),e._v(".0.0\ncluster.mcast.ttl "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("255")]),e._v("\ncluster.mcast.loop "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" on\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br")])]),a("h3",{attrs:{id:"autocluster-based-on-dns-a-records"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#autocluster-based-on-dns-a-records"}},[e._v("#")]),e._v(" Autocluster based on DNS A records")]),e._v(" "),a("p",[e._v("Automatically discover and create clusters based on DNS A records:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("cluster.discovery "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" dns\ncluster.dns.name "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" localhost\ncluster.dns.app  "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" ekka\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("h3",{attrs:{id:"autocluster-based-on-etcd"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#autocluster-based-on-etcd"}},[e._v("#")]),e._v(" Autocluster based on etcd")]),e._v(" "),a("p",[e._v("Automatically discover and create clusters based on "),a("a",{attrs:{href:"https://coreos.com/etcd/",target:"_blank",rel:"noopener noreferrer"}},[e._v("etcd"),a("OutboundLink")],1),e._v(":")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("cluster.discovery "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" etcd\ncluster.etcd.server "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" http://127.0.0.1:2379\ncluster.etcd.prefix "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" emqcl\ncluster.etcd.node_ttl "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" 1m\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("h3",{attrs:{id:"autocluster-based-on-kubernetes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#autocluster-based-on-kubernetes"}},[e._v("#")]),e._v(" Autocluster based on kubernetes")]),e._v(" "),a("p",[e._v("Automatically discover and create clusters based on "),a("a",{attrs:{href:"https://kubernetes.io/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Kubernetes"),a("OutboundLink")],1),e._v(":")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("cluster.discovery "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" k8s\ncluster.k8s.apiserver "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" http://10.110.111.204:8080\ncluster.k8s.service_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" ekka\ncluster.k8s.address_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("ip")]),e._v("\ncluster.k8s.app_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" ekka\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br")])]),a("h3",{attrs:{id:"introduction-to-manual-cluster-management"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#introduction-to-manual-cluster-management"}},[e._v("#")]),e._v(" Introduction to manual cluster management")]),e._v(" "),a("p",[e._v("Deploy EMQX Broker cluster on two servers of s1.emqx.io, s2.emqx.io:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Node name")]),e._v(" "),a("th",[e._v("Server")]),e._v(" "),a("th",[e._v("IP address")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("emqx@s1.emqx.io or emqx@192.168.0.10")]),e._v(" "),a("td",[e._v("s1.emqx.io")]),e._v(" "),a("td",[e._v("192.168.0.10")])]),e._v(" "),a("tr",[a("td",[e._v("emqx@s2.emqx.io or emqx@192.168.0.20")]),e._v(" "),a("td",[e._v("s2.emqx.io")]),e._v(" "),a("td",[e._v("192.168.0.20")])])])]),e._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[e._v("Tip")]),e._v(" "),a("p",[e._v("The format of node name is"),a("a",{attrs:{href:"mailto:Name@Host"}},[e._v("Name@Host")]),e._v(", and Host must be an IP address or FQDN (server name. Domain name)")])]),e._v(" "),a("h4",{attrs:{id:"configure-emqx-s1-emqx-io-node"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configure-emqx-s1-emqx-io-node"}},[e._v("#")]),e._v(" Configure emqx@s1.emqx.io node")]),e._v(" "),a("p",[e._v("emqx/etc/emqx.conf:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("node.name "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" emqx@s1.emqx.io\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# or")]),e._v("\nnode.name "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" emqx@192.168.0.10\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("p",[e._v("Configure through environment variables:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("EMQX_NODE_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("emqx@s1.emqx.io "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&&")]),e._v(" ./bin/emqx start\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[e._v("Tip")]),e._v(" "),a("p",[e._v("After a node starts to join the cluster, the node name cannot be changed.")])]),e._v(" "),a("h4",{attrs:{id:"configure-emqx-s2-emqx-io-node"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configure-emqx-s2-emqx-io-node"}},[e._v("#")]),e._v(" Configure emqx@s2.emqx.io node")]),e._v(" "),a("p",[e._v("emqx/etc/emqx.conf:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("node.name "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" emqx@s2.emqx.io\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# or")]),e._v("\nnode.name "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" emqx@192.168.0.20\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("h4",{attrs:{id:"node-joins-the-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#node-joins-the-cluster"}},[e._v("#")]),e._v(" Node joins the cluster")]),e._v(" "),a("p",[e._v("After starting two nodes, the join can be executed on s2.emqx.io:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ ./bin/emqx_ctl cluster "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("join")]),e._v(" emqx@s1.emqx.io\n\nJoin the cluster successfully.\nCluster status: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("running_nodes,"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'emqx@s1.emqx.io'")]),e._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'emqx@s2.emqx.io'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[e._v("Or executed on s1.emqx.io:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ ./bin/emqx_ctl cluster "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("join")]),e._v(" emqx@s2.emqx.io\n\nJoin the cluster successfully.\nCluster status: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("running_nodes,"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'emqx@s1.emqx.io'")]),e._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'emqx@s2.emqx.io'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[e._v("Query the cluster status on any node:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ ./bin/emqx_ctl cluster status\n\nCluster status: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("running_nodes,"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'emqx@s1.emqx.io'")]),e._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'emqx@s2.emqx.io'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("h4",{attrs:{id:"exit-the-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#exit-the-cluster"}},[e._v("#")]),e._v(" Exit the cluster")]),e._v(" "),a("p",[e._v("There are two ways for a node to exit the cluster:")]),e._v(" "),a("ol",[a("li",[e._v("leave: Leave this node exit the cluster")]),e._v(" "),a("li",[e._v("force-leave: Remove other nodes from cluster")])]),e._v(" "),a("p",[e._v("Let emqx@s2.emqx.io actively exit the cluster:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ ./bin/emqx_ctl cluster leave\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("Or remove the emqx@s2.emqx.io node from the cluster on s1.emqx.io:")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("$ ./bin/emqx_ctl cluster force-leave emqx@s2.emqx.io\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h4",{attrs:{id:"start-a-cluster-on-single-machine"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#start-a-cluster-on-single-machine"}},[e._v("#")]),e._v(" Start a cluster on single machine")]),e._v(" "),a("p",[e._v("For users who only have one server, the pseudo-distributed starting mode can be used. Please notice that if we want to start two or more nodes on one machine, we must adjust the listening port of the other node to avoid the port conflicts.")]),e._v(" "),a("p",[e._v("The basic process is to copy another emqx folder and name it emqx2. After that, we let all the listening ports of the original emqx to be added by an offset as the listening ports of the emqx2 node. For example, we can change the MQTT/TCP listening port from the default 1883 to 2883 as the MQTT/TCP listening port for emqx2. Please refer to "),a("a",{attrs:{href:"https://github.com/terry-xiaoyu/one_more_emqx",target:"_blank",rel:"noopener noreferrer"}},[e._v("Cluster Script"),a("OutboundLink")],1),e._v(" regarding to the above operations and also refer to "),a("RouterLink",{attrs:{to:"/en/enterprise/latest/getting-started/config.html"}},[e._v("Configuration Instructions")]),e._v(" and  "),a("RouterLink",{attrs:{to:"/en/enterprise/latest/configuration/configuration.html"}},[e._v("Configuration Items")]),e._v(" for details.")],1),e._v(" "),a("h2",{attrs:{id:"network-partition-autoheal"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#network-partition-autoheal"}},[e._v("#")]),e._v(" Network Partition Autoheal")]),e._v(" "),a("p",[a("em",[e._v("EMQX")]),e._v(" supports Network Partition Autoheal, which can be configure in "),a("code",[e._v("etc/emqx.conf")]),e._v(":")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("cluster.autoheal "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" on\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("p",[e._v("Network Partition Autoheal Process:")]),e._v(" "),a("ol",[a("li",[e._v("The node performs Network Partition confirmation 3 seconds after receiving the "),a("code",[e._v("inconsistent_database")]),e._v(" event from Mnesia;")]),e._v(" "),a("li",[e._v("After the node confirms that the Network Partition has occurred, it reports the message to the Leader node (the earliest start node in the cluster);")]),e._v(" "),a("li",[e._v("After the Leader node delays for a period of time, it create a SplitView when all nodes are online;")]),e._v(" "),a("li",[e._v("The Leader node selects the self-healing Coordinator node in the majority partition;")]),e._v(" "),a("li",[e._v("The Coordinator node restarts the minority partition node to restore the cluster.")])]),e._v(" "),a("h2",{attrs:{id:"autoclean-of-cluster-nodes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#autoclean-of-cluster-nodes"}},[e._v("#")]),e._v(" Autoclean of Cluster nodes")]),e._v(" "),a("p",[a("em",[e._v("EMQX")]),e._v(" supports Autoclean frol cluster , which can be configured in "),a("code",[e._v("etc/emqx.conf")]),e._v(" :")]),e._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("cluster.autoclean "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" 5m\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br")])]),a("h2",{attrs:{id:"firewall-settings"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#firewall-settings"}},[e._v("#")]),e._v(" Firewall settings")]),e._v(" "),a("h3",{attrs:{id:"the-node-discovery-ports"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-node-discovery-ports"}},[e._v("#")]),e._v(" The Node Discovery Ports")]),e._v(" "),a("p",[e._v("If the environment variable WITH_EPMD=1 is set in advance, the epmd (listening port 4369) will be enabled for node discovery when emqx is started, which is called "),a("code",[e._v("epmd mode")]),e._v(".")]),e._v(" "),a("p",[e._v("If the environment variable WITH_EPMD is not set, epmd is not enabled when emqx is started, and emqx ekka is used for node discovery, which is also the default method of node discovery  since version 4.0. This is called "),a("code",[e._v("ekka mode")]),e._v(".")]),e._v(" "),a("p",[a("strong",[e._v("epmd mode：")])]),e._v(" "),a("p",[e._v("If there is a firewall between cluster nodes, the firewall needs to open TCP port 4369 for each node, to allow peers query each other's listening port. The firewall should also allow nodes connecting to port in configurable range from "),a("code",[e._v("node.dist_listen_min")]),e._v(" to "),a("code",[e._v("node.dist_listen_max")]),e._v(" (inclusive, default is "),a("code",[e._v("6369")]),e._v(" for both)")]),e._v(" "),a("p",[a("strong",[e._v("ekka mode（Default mode since version 4.0）：")])]),e._v(" "),a("p",[e._v("In "),a("code",[e._v("ekka")]),e._v(" mode, the port mapping is conventional, but not dynamic as in "),a("code",[e._v("epmd")]),e._v(" mode.\nThe configurations "),a("code",[e._v("node.dist_listen_min")]),e._v(" and "),a("code",[e._v("node.dist_listen_max")]),e._v(" take no effect in this case.")]),e._v(" "),a("p",[e._v("If there is a firewall between the cluster nodes, the conventional listening port should be allowed\nfor nodes to connect each other. See below for port mapping rule in "),a("code",[e._v("ekka")]),e._v(" mode.")]),e._v(" "),a("p",[e._v("Erlang distribution port mapping rule in "),a("code",[e._v("ekka")]),e._v(" mode: "),a("code",[e._v("ListeningPort = BasePort + Offset")]),e._v(",\nwhere "),a("code",[e._v("BasePort")]),e._v(" is 4370 (which is not made configurable), and "),a("code",[e._v("Offset")]),e._v(" is the numeric suffix of the node's name. If the node name does not have a numeric suffix, "),a("code",[e._v("Offsset")]),e._v(" is 0.")]),e._v(" "),a("p",[e._v("For example, having "),a("code",[e._v("node.name = emqx@192.168.0.12")]),e._v(" in "),a("code",[e._v("emqx.conf")]),e._v(" should make the\nnode listen on port "),a("code",[e._v("4370")]),e._v(", and port  "),a("code",[e._v("4371")]),e._v(" for "),a("code",[e._v("emqx1")]),e._v(" (or "),a("code",[e._v("emqx-1")]),e._v("), and so on.")]),e._v(" "),a("h3",{attrs:{id:"the-cluster-rpc-port"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-cluster-rpc-port"}},[e._v("#")]),e._v(" The Cluster RPC Port")]),e._v(" "),a("p",[e._v("Each emqx node also listens on a (conventional) port for the RPC channels, which should\nalso be allowed by the firewall. The port mapping rule is similar to the node discovery\nports in "),a("code",[e._v("ekka mode")]),e._v(", but with the "),a("code",[e._v("BasePort = 5370")]),e._v(". That is, having\n"),a("code",[e._v("node.name = emqx@192.168.0.12")]),e._v(" in "),a("code",[e._v("emqx.conf")]),e._v(" should make the node listen on port "),a("code",[e._v("5370")]),e._v(",\nand port "),a("code",[e._v("5371")]),e._v(" for "),a("code",[e._v("emqx1")]),e._v(" (or "),a("code",[e._v("emqx-1")]),e._v("), and so on.")])])}),[],!1,null,null,null);t.default=n.exports},399:function(e,t,s){e.exports=s.p+"docs-assets/img/design_9.46b9a10f.png"},498:function(e,t,s){e.exports=s.p+"docs-assets/img/cluster_1.7f2c87ef.png"},499:function(e,t,s){e.exports=s.p+"docs-assets/img/cluster_2.8a49ae02.png"}}]);
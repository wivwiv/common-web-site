(window.webpackJsonp=window.webpackJsonp||[]).push([[128],{1040:function(s,t,a){s.exports=a.p+"docs-assets/img/auth_http2.ce933d90.png"},1041:function(s,t,a){s.exports=a.p+"docs-assets/img/auth_http3.fb0e8b31.png"},1042:function(s,t,a){s.exports=a.p+"docs-assets/img/auth_http4.81691b1d.png"},1766:function(s,t,a){"use strict";a.r(t);var e=a(10),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"http-认证-访问控制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#http-认证-访问控制"}},[s._v("#")]),s._v(" HTTP 认证/访问控制")]),s._v(" "),e("p",[s._v("HTTP 认证/访问控制使用外部自建 HTTP 应用认证数据源，根据 HTTP API 返回的数据判定认证结果，能够实现复杂的认证鉴权逻辑和实现复杂的 ACL 校验逻辑。")]),s._v(" "),e("h2",{attrs:{id:"创建模块"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建模块"}},[s._v("#")]),s._v(" 创建模块")]),s._v(" "),e("p",[s._v("打开 "),e("a",{attrs:{href:"http://127.0.0.1:18083/#/modules",target:"_blank",rel:"noopener noreferrer"}},[s._v("EMQX Dashboard"),e("OutboundLink")],1),s._v("，点击左侧的 “模块” 选项卡，选择添加：")]),s._v(" "),e("p",[e("img",{attrs:{src:a(390),alt:"image-20200927213049265"}})]),s._v(" "),e("p",[s._v("选择 HTTP 认证/访问控制模块")]),s._v(" "),e("p",[e("img",{attrs:{src:a(1040),alt:"image-20200927213049265"}})]),s._v(" "),e("p",[s._v("配置相关参数")]),s._v(" "),e("p",[e("img",{attrs:{src:a(1041),alt:"image-20200927213049265"}})]),s._v(" "),e("p",[s._v("点击添加后，模块添加完成")]),s._v(" "),e("p",[e("img",{attrs:{src:a(1042),alt:"image-20200927213049265"}})]),s._v(" "),e("h2",{attrs:{id:"http-认证原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#http-认证原理"}},[s._v("#")]),s._v(" HTTP 认证原理")]),s._v(" "),e("p",[s._v("EMQX 在设备连接事件中使用当前客户端相关信息作为参数，向用户自定义的认证服务发起请求查询权限，通过返回的 HTTP "),e("strong",[s._v("响应状态码")]),s._v(" (HTTP statusCode) 来处理认证请求。")]),s._v(" "),e("ul",[e("li",[s._v("认证失败：API 返回非 200 的状态码")]),s._v(" "),e("li",[s._v("认证成功：API 返回 200 状态码")]),s._v(" "),e("li",[s._v("忽略认证：API 返回 200 状态码且消息体 ignore")])]),s._v(" "),e("h2",{attrs:{id:"认证请求"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#认证请求"}},[s._v("#")]),s._v(" 认证请求")]),s._v(" "),e("p",[s._v("进行身份认证时，EMQX 将使用当前客户端信息填充并发起用户配置的认证查询请求，查询出该客户端在 HTTP 服务器端的认证数据。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 认证请求地址")]),s._v("\nhttp://127.0.0.1:8991/mqtt/auth\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## HTTP 请求方法")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: POST | GET")]),s._v("\nPOST\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 请求参数")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("clientid")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%c,username"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%u,password"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%P\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("HTTP 请求方法为 GET 时，请求参数将以 URL 查询字符串的形式传递；POST 请求则将请求参数以普通表单形式提交（content-type 为 x-www-form-urlencoded）。")]),s._v(" "),e("p",[s._v("你可以在认证请求中使用以下占位符，请求时 EMQX 将自动填充为客户端信息：")]),s._v(" "),e("ul",[e("li",[s._v("%u：用户名")]),s._v(" "),e("li",[s._v("%c：Client ID")]),s._v(" "),e("li",[s._v("%a：客户端 IP 地址")]),s._v(" "),e("li",[s._v("%r：客户端接入协议")]),s._v(" "),e("li",[s._v("%P：明文密码")]),s._v(" "),e("li",[s._v("%p：客户端端口")]),s._v(" "),e("li",[s._v("%C：TLS 证书公用名（证书的域名或子域名），仅当 TLS 连接时有效")]),s._v(" "),e("li",[s._v("%d：TLS 证书 subject，仅当 TLS 连接时有效")])]),s._v(" "),e("div",{staticClass:"custom-block danger"},[e("p",{staticClass:"custom-block-title"},[s._v("警告")]),s._v(" "),e("p",[s._v("推荐使用 POST 与 PUT 方法，使用 GET 方法时明文密码可能会随 URL 被记录到传输过程中的服务器日志中。")])]),s._v(" "),e("h2",{attrs:{id:"http-访问控制原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#http-访问控制原理"}},[s._v("#")]),s._v(" HTTP 访问控制原理")]),s._v(" "),e("p",[s._v("EMQX 在设备发布、订阅事件中使用当前客户端相关信息作为参数，向用户自定义的认证服务发起请求权限，通过返回的 HTTP "),e("strong",[s._v("响应状态码")]),s._v(" (HTTP statusCode) 来处理 ACL 授权请求。")]),s._v(" "),e("ul",[e("li",[s._v("无权限：API 返回非 200 状态码")]),s._v(" "),e("li",[s._v("授权成功：API 返回 200 状态码")]),s._v(" "),e("li",[s._v('忽略授权：API 返回 200 状态码且消息体为固定内容: "ignore"')])]),s._v(" "),e("h2",{attrs:{id:"http-请求信息"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#http-请求信息"}},[s._v("#")]),s._v(" HTTP 请求信息")]),s._v(" "),e("p",[s._v("HTTP API 基础请求信息，配置证书、请求头与重试规则。")]),s._v(" "),e("p",[s._v("进行发布、订阅认证时，EMQX 将使用当前客户端信息填充并发起用户配置的 ACL 授权查询请求，查询出该客户端在 HTTP 服务器端的授权数据。")]),s._v(" "),e("h2",{attrs:{id:"superuser-请求"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#superuser-请求"}},[s._v("#")]),s._v(" superuser 请求")]),s._v(" "),e("p",[s._v("首先查询客户端是否为超级用户，客户端为超级用户时将跳过 ACL 查询。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# etc/plugins/emqx_auth_http.conf")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 超级用户请求地址")]),s._v("\nhttp://127.0.0.1:8991/mqtt/superuser\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## HTTP 请求方法")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: POST | GET")]),s._v("\nPOST\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 超级用户请求参数")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("clientid")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%c,username"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%u\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("h2",{attrs:{id:"acl-访问控制请求"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#acl-访问控制请求"}},[s._v("#")]),s._v(" ACL 访问控制请求")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 访问控制请求地址")]),s._v("\nhttp://127.0.0.1:8991/mqtt/acl\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## HTTP 请求方法")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Value: POST | GET")]),s._v("\nPOST\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 访问控制请求参数")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("access")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%A,username"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%u,clientid"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%c,ipaddr"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%a,topic"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%t,mountpoint"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("%m\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("h2",{attrs:{id:"请求说明"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#请求说明"}},[s._v("#")]),s._v(" 请求说明")]),s._v(" "),e("p",[s._v("HTTP 请求方法为 GET 时，请求参数将以 URL 查询字符串的形式传递；POST、PUT 请求则将请求参数以普通表单形式提交（content-type 为 x-www-form-urlencoded）。")]),s._v(" "),e("p",[s._v("你可以在认证请求中使用以下占位符，请求时 EMQX 将自动填充为客户端信息：")]),s._v(" "),e("ul",[e("li",[s._v("%A：操作类型，'1' 订阅；'2' 发布")]),s._v(" "),e("li",[s._v("%u：客户端用户名")]),s._v(" "),e("li",[s._v("%c：Client ID")]),s._v(" "),e("li",[s._v("%a：客户端 IP 地址")]),s._v(" "),e("li",[s._v("%r：客户端接入协议")]),s._v(" "),e("li",[s._v("%m：Mountpoint")]),s._v(" "),e("li",[s._v("%t：主题")])]),s._v(" "),e("div",{staticClass:"custom-block danger"},[e("p",{staticClass:"custom-block-title"},[s._v("警告")]),s._v(" "),e("p",[s._v("推荐使用 POST 与 PUT 方法，使用 GET 方法时明文密码可能会随 URL 被记录到传输过程中的服务器日志中。")])])])}),[],!1,null,null,null);t.default=n.exports},390:function(s,t,a){s.exports=a.p+"docs-assets/img/modules.89e07c9c.png"}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[136],{1138:function(_,v,e){_.exports=e.p+"docs-assets/img/topic_rewrite_1.6f805427.png"},1139:function(_,v,e){_.exports=e.p+"docs-assets/img/topic_rewrite_2.aa29b27f.png"},1140:function(_,v,e){_.exports=e.p+"docs-assets/img/topic_rewrite_3.0242a9ae.png"},1793:function(_,v,e){"use strict";e.r(v);var t=e(10),o=Object(t.a)({},(function(){var _=this,v=_.$createElement,t=_._self._c||v;return t("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[t("h1",{attrs:{id:"主题重写"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主题重写"}},[_._v("#")]),_._v(" 主题重写")]),_._v(" "),t("p",[_._v("EMQX 的主题重写功能支持根据用户配置的规则在客户端订阅主题、发布消息、取消订阅的时候将 A 主题重写为 B 主题。")]),_._v(" "),t("h2",{attrs:{id:"创建模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建模块"}},[_._v("#")]),_._v(" 创建模块")]),_._v(" "),t("p",[_._v("打开 "),t("a",{attrs:{href:"http://127.0.0.1:18083/#/modules",target:"_blank",rel:"noopener noreferrer"}},[_._v("EMQX Dashboard"),t("OutboundLink")],1),_._v("，点击左侧的 “模块” 选项卡，选择添加：")]),_._v(" "),t("p",[t("img",{attrs:{src:e(390),alt:"image-20200927213049265"}})]),_._v(" "),t("p",[_._v("选择 MQTT 主题重写模块")]),_._v(" "),t("p",[t("img",{attrs:{src:e(1138),alt:"image-20200927213049265"}})]),_._v(" "),t("p",[_._v("配置相关参数")]),_._v(" "),t("p",[t("img",{attrs:{src:e(1139),alt:"image-20200927213049265"}})]),_._v(" "),t("p",[_._v("点击添加后，模块添加完成")]),_._v(" "),t("p",[t("img",{attrs:{src:e(1140),alt:"image-20200927213049265"}})]),_._v(" "),t("h2",{attrs:{id:"主题重写规则"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主题重写规则"}},[_._v("#")]),_._v(" 主题重写规则")]),_._v(" "),t("p",[_._v("重写规则分为 Pub 规则和 Sub 规则，Pub 规则匹配 PUSHLISH 报文携带的主题，Sub 规则匹配 SUBSCRIBE、UNSUBSCRIBE 报文携带的主题。")]),_._v(" "),t("p",[_._v("每条重写规则都由主题过滤器、正则表达式、目标表达式三部分组成。在主题重写功能开启的前提下，EMQX 在收到诸如 PUBLISH 报文等带有主题的 MQTT 报文时，将使用报文中的主题去依次匹配配置文件中规则的主题过滤器部分，一旦成功匹配，则使用正则表达式提取主题中的信息，然后替换至目标表达式以构成新的主题。")]),_._v(" "),t("p",[_._v("目标表达式中可以使用 "),t("code",[_._v("$N")]),_._v(" 这种格式的变量匹配正则表达中提取出来的元素，"),t("code",[_._v("$N")]),_._v(" 的值为正则表达式中提取出来的第 N 个元素，比如 "),t("code",[_._v("$1")]),_._v(" 即为正则表达式提取的第一个元素。")]),_._v(" "),t("p",[_._v("同时，表达式中也可以使用 "),t("code",[_._v("$c")]),_._v(" 代表 "),t("code",[_._v("客户端Id")]),_._v(", 使用 "),t("code",[_._v("$u")]),_._v(" 代表 "),t("code",[_._v("客户端用户名")]),_._v("。")]),_._v(" "),t("p",[_._v("需要注意的是，EMQX 使用倒序读取配置文件中的重写规则，当一条主题可以同时匹配多条主题重写规则的主题过滤器时，EMQX 仅会使用它匹配到的第一条规则进行重写，如果该条规则中的正则表达式与 MQTT 报文主题不匹配，则重写失败，不会再尝试使用其他的规则进行重写。因此用户在使用时需要谨慎的设计 MQTT 报文主题以及主题重写规则。")]),_._v(" "),t("h2",{attrs:{id:"主题重写示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主题重写示例"}},[_._v("#")]),_._v(" 主题重写示例")]),_._v(" "),t("p",[_._v("添加上图中的主题重写规则并分别订阅 "),t("code",[_._v("y/a/z/b")]),_._v("、"),t("code",[_._v("y/def")]),_._v("、"),t("code",[_._v("x/1/2")]),_._v("、"),t("code",[_._v("x/y/2")]),_._v("、"),t("code",[_._v("x/y/z")]),_._v(" 五个主题：")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("当客户端订阅 "),t("code",[_._v("y/def")]),_._v(" 主题时，"),t("code",[_._v("y/def")]),_._v(" 不匹配任何一个主题过滤器，因此不执行主题重写，直接订阅 "),t("code",[_._v("y/def")]),_._v(" 主题。")])]),_._v(" "),t("li",[t("p",[_._v("当客户端订阅 "),t("code",[_._v("y/a/z/b")]),_._v(" 主题时，"),t("code",[_._v("y/a/z/b")]),_._v(" 匹配 "),t("code",[_._v("y/+/z/#")]),_._v(" 主题过滤器，EMQX 执行 "),t("code",[_._v("module.rewrite.sub.rule.1")]),_._v(" 规则，通过正则正则表达式匹配出元素 "),t("code",[_._v("[a、b]")]),_._v(" ，将匹配出来的第二个元素带入 "),t("code",[_._v("y/z/$2")]),_._v("，实际订阅了 "),t("code",[_._v("y/z/b")]),_._v(" 主题。")])]),_._v(" "),t("li",[t("p",[_._v("当客户端向 "),t("code",[_._v("x/1/2")]),_._v(" 主题发送消息时，"),t("code",[_._v("x/1/2")]),_._v(" 匹配 "),t("code",[_._v("x/#")]),_._v(" 主题过滤器，EMQX 执行 "),t("code",[_._v("module.rewrite.pub.rule.1")]),_._v(" 规则，通过正则表达式未匹配到元素，不执行主题重写，因此直接向 "),t("code",[_._v("x/1/2")]),_._v(" 主题发送消息。")])]),_._v(" "),t("li",[t("p",[_._v("当客户端向 "),t("code",[_._v("x/y/2")]),_._v(" 主题发送消息时，"),t("code",[_._v("x/y/2")]),_._v(" 同时匹配 "),t("code",[_._v("x/#")]),_._v(" 和 "),t("code",[_._v("x/y/+")]),_._v(" 两个主题过滤器，EMQX 通过倒序读取配置，所以优先匹配 "),t("code",[_._v("module.rewrite.pub.rule.2")]),_._v("，通过正则替换，实际向 "),t("code",[_._v("z/y/2")]),_._v(" 主题发送消息。")])]),_._v(" "),t("li",[t("p",[_._v("当客户端向 "),t("code",[_._v("x/y/z")]),_._v(" 主题发送消息时，"),t("code",[_._v("x/y/z")]),_._v(" 同时匹配 "),t("code",[_._v("x/#")]),_._v(" 和 "),t("code",[_._v("x/y/+")]),_._v(" 两个主题过滤器，EMQX 通过倒序读取配置，所以优先匹配 "),t("code",[_._v("module.rewrite.pub.rule.2，通过正则表达式未匹配到元素，不执行主题重写，直接向")]),_._v("x/y/z"),t("code",[_._v("主题发送消息。需要注意的是，即使")]),_._v("module.rewrite.pub.rule.2"),t("code",[_._v("的正则表达式匹配失败，也不会再次去匹配")]),_._v("module.rewrite.pub.rule.1` 的规则。")])])])])}),[],!1,null,null,null);v.default=o.exports},390:function(_,v,e){_.exports=e.p+"docs-assets/img/modules.89e07c9c.png"}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{1644:function(s,t,e){"use strict";e.r(t);var a=e(10),n=Object(a.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"rule-engine-example"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rule-engine-example"}},[s._v("#")]),s._v(" Rule engine example")]),s._v(" "),a("h2",{attrs:{id:"check-debug"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#check-debug"}},[s._v("#")]),s._v(" Check (debug)")]),s._v(" "),a("p",[s._v("Create a rule for testing: print the content of the message and all the\nargs of the action, when a MQTT message is sent to topic 't/a'.")]),s._v(" "),a("ul",[a("li",[s._v("The filter SQL is: SELECT * FROM \"message.publish\" WHERE topic =\n't/a';")]),s._v(" "),a("li",[s._v("The action is: \"print the content of the message and all the args of\nthe action\", the action we need is 'inspect'.")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ ./bin/emqx_ctl rules create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"SELECT * FROM '),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("message.publish"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(" WHERE topic = 't/a'\"")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'[{"name":"inspect", "params": {"a": 1}}]\'')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Rule for debug'")]),s._v("\n\nRule rule:803de6db created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("The CLI above created a rule with ID='Rule rule:803de6db'.")]),s._v(" "),a("p",[s._v("The first two args are mandatory:")]),s._v(" "),a("ul",[a("li",[s._v("SQL: SELECT * FROM \"message.publish\" WHERE topic = 't/a'")]),s._v(" "),a("li",[s._v('Action List: [{"name":"inspect", "params": {"a": 1}}]. Action List\nis of type JSON Array. "name" is the name of the action, "params" is\nthe parameters of the action. Note that the action '),a("code",[s._v("inspect")]),s._v(" does\nnot need a resource.")])]),s._v(" "),a("p",[s._v("The last arg is an optional description of the rule: 'Rule for debug'.")]),s._v(" "),a("p",[s._v('If a MQTT message "hello" is sent to topic \'t/a\', the rule "Rule\nrule:803de6db" will be matched, and then action "inspect" will be\ntriggered, the following info will be printed to the emqx console:')]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" -f log/erlang.log.1\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("emqx@127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("inspect"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nSelected Data: "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#{client_id => <<\"shawn\">>,event => 'message.publish',")]),s._v("\n                    flags "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#{dup => false,retain => false},")]),s._v("\n                    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5898704A55D6AF4430000083D0002"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(",\n                    payload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(",\n                    peername "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1:61770"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(",qos "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n                    timestamp "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1558587875090")]),s._v(",topic "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"t/a"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(",\n                    username "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" undefined"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nEnvs: "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#{event => 'message.publish',")]),s._v("\n        flags "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#{dup => false,retain => false},")]),s._v("\n        from "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shawn"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(",\n        headers "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#{allow_publish => true,")]),s._v("\n                peername "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127,0")]),s._v(",0,1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",61770"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n                username "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" undefined"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,5")]),s._v(",137,135,4,165,93,106,244,67,0,0,8,61,0,"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">>")]),s._v(",\n        payload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(",qos "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n        timestamp "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1558,587875")]),s._v(",89754"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n        topic "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"t/a"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nAction Init Params: "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#{<<"a">> => 1}')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("Selected Data")]),s._v(" listed the fields that selected by the SQL.All\navailable fields will be listed here, as we used "),a("code",[s._v("select *")]),s._v(".")]),s._v(" "),a("li",[a("code",[s._v("Envs")]),s._v(" is the environment varibles that can be used internally in\nthe action.")]),s._v(" "),a("li",[a("code",[s._v("Action Init Params")]),s._v(" is the params we passed to the action.")])]),s._v(" "),a("h2",{attrs:{id:"send-data-to-webhook"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#send-data-to-webhook"}},[s._v("#")]),s._v(" Send data to WebHook")]),s._v(" "),a("p",[s._v("Setup a Web Service, here we setup a simple web service using the linux tool "),a("code",[s._v("nc")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"HTTP/1.1 200 OK'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nc")]),s._v(" -l "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9901")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Create a rule:")]),s._v(" "),a("p",[s._v("Go to "),a("a",{attrs:{href:"http://127.0.0.1:18083/#/rules",target:"_blank",rel:"noopener noreferrer"}},[s._v("EMQX Dashboard"),a("OutboundLink")],1),s._v(', select the\n"rule" tab on the menu to the left.')]),s._v(" "),a("p",[s._v('Select "message.publish", then type in the following SQL:')]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"message.publish"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("img",{attrs:{src:e(393),alt:"image"}})]),s._v(" "),a("p",[s._v("Bind an action:")]),s._v(" "),a("p",[s._v('Click on the "+ Add" button under "Action Handler", and then select\n"Data to Web Server" in the pop-up dialog window.')]),s._v(" "),a("p",[a("img",{attrs:{src:e(934),alt:"image"}})]),s._v(" "),a("p",[s._v("Bind a resource to the action:")]),s._v(" "),a("p",[s._v('Since the dropdown list "Resource" is empty for now, we create a new\nresource by clicking on the "New Resource" to the top right, and then\nselect "WebHook":')]),s._v(" "),a("p",[a("img",{attrs:{src:e(935),alt:"image"}})]),s._v(" "),a("p",[s._v("Configure the resource:")]),s._v(" "),a("p",[s._v('Fill in the "Request URL" and "Request Header"(Optional):')]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("http://127.0.0.1:9901\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v('And click on the "Testing Connection" button to make sure the\nconnection can be created successfully, and then click on the "Create"\nbutton.')]),s._v(" "),a("p",[a("img",{attrs:{src:e(936),alt:"image"}})]),s._v(" "),a("p",[s._v('Back to the "Actions" dialog, and then click on the "Confirm"\nbutton.')]),s._v(" "),a("p",[a("img",{attrs:{src:e(937),alt:"image"}})]),s._v(" "),a("p",[s._v('Back to the creating rule page, then click on "Create" button. The\nrule we created will be show in the rule list:')]),s._v(" "),a("p",[a("img",{attrs:{src:e(938),alt:"image"}})]),s._v(" "),a("p",[s._v("We have finished, testing the rule by sending an MQTT message to\nemqx:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Topic: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"t/1"')]),s._v("\n\nQoS: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\nPayload: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello web server"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("Then inspect the Web Service table, verify a new record has been\nreceived:")]),s._v(" "),a("p",[a("img",{attrs:{src:e(939),alt:"image"}})]),s._v(" "),a("p",[s._v('And from the rule list, verify that the "Matched" column has increased\nto 1:')]),s._v(" "),a("p",[a("img",{attrs:{src:e(940),alt:"image"}})])])}),[],!1,null,null,null);t.default=n.exports},393:function(s,t,e){s.exports=e.p+"docs-assets/img/mysql_sql_1.515176ea.png"},934:function(s,t,e){s.exports=e.p+"docs-assets/img/webhook_action_0.958e6b06.png"},935:function(s,t,e){s.exports=e.p+"docs-assets/img/webhook_action_1.d776200d.png"},936:function(s,t,e){s.exports=e.p+"docs-assets/img/webhook_resource_0.213dc3ac.png"},937:function(s,t,e){s.exports=e.p+"docs-assets/img/webhook_action_2.de97a657.png"},938:function(s,t,e){s.exports=e.p+"docs-assets/img/webhook_rule_rule_overview_0.038ef6ea.png"},939:function(s,t,e){s.exports=e.p+"docs-assets/img/webhook_result.e58f8bb6.png"},940:function(s,t,e){s.exports=e.p+"docs-assets/img/webhook_rule_rule_overview_1.c3103ce7.png"}}]);
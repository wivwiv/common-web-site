(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{1632:function(s,t,a){"use strict";a.r(t);var e=a(10),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"save-offline-messages-to-mysql"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#save-offline-messages-to-mysql"}},[s._v("#")]),s._v(" Save offline messages to MySQL")]),s._v(" "),e("p",[s._v("Set up the MySQL database and set the user name and password to root/public. Take MacOS X as an example:")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ brew "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" mysql\n\n$ brew services start mysql\n\n$ mysql -u root -h localhost -p\n\nALTER "),e("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),s._v("@"),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'localhost'")]),s._v(" IDENTIFIED BY "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'public'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("Initialize the MySQL database:")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ mysql -u root -h localhost -ppublic\n\ncreate database mqtt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("Create the mqtt_msg table:")]),s._v(" "),e("div",{staticClass:"language-sql line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DROP")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("IF")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("EXISTS")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("mqtt_msg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("mqtt_msg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AUTO_INCREMENT")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("msgid"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("topic"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("180")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("sender"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("qos"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tinyint")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("retain"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tinyint")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("payload"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("blob")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("arrived"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("datetime")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIMARY")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INDEX")]),s._v(" topic_index"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("topic"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("InnoDB")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CHARSET")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utf8MB4"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),e("p",[s._v("The message table structure cannot be modified. Please use the above SQL statement to create")])]),s._v(" "),e("p",[s._v("Create rules:")]),s._v(" "),e("p",[s._v("Open "),e("a",{attrs:{href:"http://127.0.0.1:18083/#/rules",target:"_blank",rel:"noopener noreferrer"}},[s._v("EMQX Dashboard"),e("OutboundLink")],1),s._v(' and select the "Rules" tab on the left.')]),s._v(" "),e("p",[s._v("Then fill in the rule SQL:")]),s._v(" "),e("p",[s._v("FROM description")]),s._v(" "),e("p",[s._v("​\t"),e("strong",[s._v("t/#")]),s._v(": The publisher publishes a message to trigger the action of saving of offline messages to MySQL")]),s._v(" "),e("p",[s._v("​\t"),e("strong",[s._v("$events/session_subscribed")]),s._v(": The subscriber subscribes to topics to trigger  the action of getting offline messages")]),s._v(" "),e("p",[s._v("​\t"),e("strong",[s._v("$events/message_acked")]),s._v(": The subscriber replies to the message ACK to trigger the action of deleting the offline message that has been received")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("SELECT * FROM "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"t/#"')]),s._v(", "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$events")]),s._v('/session_subscribed"')]),s._v(", "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$events")]),s._v('/message_acked"')]),s._v(" WHERE topic "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=~")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'t/#'")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:a(905),alt:""}})]),s._v(" "),e("p",[s._v("Related actions:")]),s._v(" "),e("p",[s._v('Select "Add Action" on the "Response Action" interface, and then select "Save offline messages to MySQL" in the "Add Action" drop-down box')]),s._v(" "),e("p",[e("img",{attrs:{src:a(906),alt:""}})]),s._v(" "),e("p",[s._v('Now that the resource drop-down box is empty, and you can click "New" in the upper right corner to create a MySQL resource:')]),s._v(" "),e("p",[e("img",{attrs:{src:a(907),alt:""}})]),s._v(" "),e("p",[s._v('The "Create Resource" dialog box pops up')]),s._v(" "),e("p",[e("img",{attrs:{src:a(908),alt:""}})]),s._v(" "),e("p",[s._v("Fill in the resource configuration:")]),s._v(" "),e("p",[s._v('Fill in the real MySQL server address and the values corresponding to other configurations, and then click the "Test Connection" button to ensure that the connection test is successful.')]),s._v(" "),e("p",[s._v('Finally click the "OK" button.')]),s._v(" "),e("p",[e("img",{attrs:{src:a(909),alt:""}})]),s._v(" "),e("p",[s._v('Return to the response action interface and click "OK".')]),s._v(" "),e("p",[e("img",{attrs:{src:a(910),alt:""}})]),s._v(" "),e("p",[s._v('Return to the rule creation interface and click "Create".')]),s._v(" "),e("p",[e("img",{attrs:{src:a(911),alt:""}})]),s._v(" "),e("p",[s._v("The rule has been created, and you can send a piece of data through the WebSocket client of Dashboard "),e("strong",[s._v("(The QoS of the published message must be greater than 0):")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(912),alt:""}})]),s._v(" "),e("p",[s._v("After the message is sent, you can see the message is saved in MySQL through mysql:")]),s._v(" "),e("p",[e("img",{attrs:{src:a(913),alt:""}})]),s._v(" "),e("p",[s._v('Use another client to subscribe to the topic "t/1" (the QoS of the subscribed topic must be greater than 0, otherwise the message will be received repeatedly):')]),s._v(" "),e("p",[e("img",{attrs:{src:a(914),alt:""}})]),s._v(" "),e("p",[s._v("After subscribing, you will receive the offline message saved in MySQL immediately:")]),s._v(" "),e("p",[e("img",{attrs:{src:a(915),alt:""}})]),s._v(" "),e("p",[s._v("Offline messages will be deleted in MySQL after being received:")]),s._v(" "),e("p",[e("img",{attrs:{src:a(916),alt:""}})])])}),[],!1,null,null,null);t.default=n.exports},905:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_offline_msg_01.51e78dfe.png"},906:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_offline_msg_02.ab101336.png"},907:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_offline_msg_03.385b02c2.png"},908:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_offline_msg_04.21b0058c.png"},909:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_offline_msg_05.70d21e51.png"},910:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_offline_msg_06.7aa40e15.png"},911:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_offline_msg_07.176e6c8e.png"},912:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_offline_msg_08.9b109a80.png"},913:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_offline_msg_09.d48c81db.png"},914:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_offline_msg_10.1cb47e02.png"},915:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_offline_msg_11.4d50b468.png"},916:function(s,t,a){s.exports=a.p+"docs-assets/img/mysql_offline_msg_12.e998e898.png"}}]);